<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spring 2026 Study Schedule — MOR Subject Pool</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --cardinal: #990000;
  --cardinal-dark: #6B0000;
  --bg: #FAFAF8;
  --surface: #FFFFFF;
  --text: #1A1A1A;
  --text-secondary: #5C5C5C;
  --text-muted: #8C8C8C;
  --border: #E5E5E3;
  --border-light: #F0F0EE;
  --online: #E8F5E9;
  --online-text: #1B5E20;
  --online-border: #A5D6A7;
  --inperson: #FFF3E0;
  --inperson-text: #E65100;
  --inperson-border: #FFCC80;
  --hybrid: #E3F2FD;
  --hybrid-text: #0D47A1;
  --hybrid-border: #90CAF9;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --radius: 8px;
  --current-week-bg: #FFF9F0;
  --current-week-border: #F5C542;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

/* Dark mode toggle */
.dark-mode-toggle {
  background: rgba(255,255,255,0.15);
  border: 1.5px solid rgba(255,255,255,0.3);
  border-radius: 20px;
  color: white;
  font-size: 14px;
  width: 34px;
  height: 34px;
  cursor: pointer;
  transition: background 0.15s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: inherit;
}
.dark-mode-toggle:hover { background: rgba(255,255,255,0.25); }

.whats-new-dot {
  color: #FFD700;
  font-size: 10px;
  animation: pulse-dot 1.5s ease infinite;
  cursor: pointer;
  margin-left: -4px;
}

/* Changelog panel */
.changelog-trigger {
  display: none;
  align-items: center;
  gap: 4px;
  background: rgba(255,215,0,0.15);
  border: 1px solid rgba(255,215,0,0.3);
  border-radius: 14px;
  padding: 3px 10px 3px 8px;
  font-size: 11px;
  font-weight: 600;
  color: #FFD700;
  cursor: pointer;
  transition: all 0.15s;
  font-family: inherit;
  white-space: nowrap;
}
.changelog-trigger.visible { display: inline-flex; }
.changelog-trigger:hover { background: rgba(255,215,0,0.25); border-color: rgba(255,215,0,0.5); }
.changelog-trigger .cl-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: #FFD700;
  animation: pulse-dot 1.5s ease infinite;
  flex-shrink: 0;
}
.changelog-panel {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  width: 320px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 120;
  color: var(--text);
}
.changelog-panel.open { display: block; }
.changelog-panel-header {
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 700;
  color: var(--cardinal);
  border-bottom: 1px solid var(--border-light);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--surface);
}
.changelog-dismiss {
  font-size: 11px;
  color: var(--text-muted);
  cursor: pointer;
  background: none;
  border: none;
  font-family: inherit;
  padding: 2px 6px;
  border-radius: 4px;
}
.changelog-dismiss:hover { background: var(--border-light); color: var(--text); }
.changelog-entry {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border-light);
  font-size: 12px;
  line-height: 1.5;
}
.changelog-entry:last-child { border-bottom: none; }
.changelog-entry-date {
  font-size: 10px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  margin-bottom: 3px;
}
.changelog-entry-items { color: var(--text-secondary); }
.changelog-entry-items li { margin-bottom: 2px; list-style: disc inside; }
body.dark .changelog-panel { background: #242424; border-color: #3A3A3A; }
body.dark .changelog-panel-header { background: #242424; border-color: #3A3A3A; }
@media (max-width: 768px) {
  .changelog-panel { width: calc(100vw - 32px); right: -8px; }
}
  vertical-align: super;
}
@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* Dark mode overrides */
body.dark {
  --bg: #1A1A1A;
  --surface: #242424;
  --text: #E8E8E8;
  --text-secondary: #A0A0A0;
  --text-muted: #707070;
  --border: #3A3A3A;
  --border-light: #2E2E2E;
  --online: #1A2E1A;
  --online-text: #81C784;
  --online-border: #2E5A2E;
  --inperson: #2E2010;
  --inperson-text: #FFB74D;
  --inperson-border: #5A3E1A;
  --hybrid: #10202E;
  --hybrid-text: #64B5F6;
  --hybrid-border: #1A3A5A;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
  --current-week-bg: #2A2510;
  --current-week-border: #8A7A20;
}
body.dark .header { box-shadow: 0 2px 12px rgba(0,0,0,0.5); }
body.dark .nav { background: #242424; border-color: #3A3A3A; }
body.dark .my-schedule-picker { background: #242424; }
body.dark .my-schedule-picker select { background: #1A1A1A; color: #E8E8E8; border-color: #3A3A3A; }
body.dark .studies-search-input { background: #1A1A1A; color: #E8E8E8; border-color: #3A3A3A; }
body.dark .studies-researcher-select { background: #1A1A1A; color: #E8E8E8; border-color: #3A3A3A; }
body.dark .table-wrap { background: #242424; border-color: #3A3A3A; }
body.dark table th { background: #2A2A2A; color: #C0C0C0; }
body.dark table td { border-color: #3A3A3A; }
body.dark table tbody tr:hover td { background: #2E2E2E; }
body.dark .format-chip { background: #2A2A2A; border-color: #3A3A3A; color: #A0A0A0; }
body.dark .format-chip.active { background: var(--cardinal); color: white; }
body.dark .badge-cr { background: #3A1A1A; color: #FF8A80; border-color: #5A2A2A; }
body.dark .note-bar { background: #242424; border-color: #3A3A3A; color: #A0A0A0; }
body.dark .home-intro { background: #242424; border-color: #3A3A3A; }
body.dark .home-intro-tab { background: #2A2A2A; border-color: #3A3A3A; }
body.dark .home-intro-tab:hover { background: #2E1A1A; border-color: var(--cardinal); }
body.dark .researcher-card-header { background: linear-gradient(135deg, #5A0000, #3A0000); }
body.dark .rc-week-header { background: #2A2A2A; border-color: #3A3A3A; }
body.dark .rc-study { border-color: #3A3A3A; }
body.dark .footer-enhanced { background: #1A1A1A; border-color: #3A3A3A; color: #A0A0A0; }
body.dark .footer-enhanced a { color: #FF8A80; }
body.dark .back-to-top { background: #3A3A3A; color: #E8E8E8; border-color: #4A4A4A; }
body.dark .fac-room { background: #2A2A2A; border-color: #3A3A3A; }
body.dark .room-modal { background: #242424; }
body.dark .room-modal-header { background: #3A0000; }
body.dark .cal-nav-btn { background: #2A2A2A; border-color: #3A3A3A; color: #A0A0A0; }
body.dark .rc-minimap-102 .lab102-floor { background: #1A1A1A; }
body.dark .rc-minimap { background: #1E1E1E; border-color: #3A3A3A; }
body.dark .rc-minimap-102 .lab102-door { background: #3A3000; border-color: #5A4B00; color: #FFD54F; }
body.dark .rc-minimap-102 .lab102-proctor { background: #1E2E1E; border-color: #4A6B23; color: #A0A0A0; }
body.dark .rc-minimap-102 .lab102-aisle span { color: #555; }
body.dark .rc-minimap-102 .lab102-col-label { color: #666; }
body.dark .n-progress { background: #3A3A3A; }
body.dark .study-sona-link { background: rgba(255,100,80,0.1); border-color: rgba(255,100,80,0.2); color: #FF8A80; }

body {
  font-family: 'Source Sans 3', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.55;
  -webkit-font-smoothing: antialiased;
}

/* ═══ Skip to content (a11y) ═══ */
.skip-link {
  position: absolute;
  top: -40px;
  left: 0;
  background: var(--cardinal);
  color: white;
  padding: 8px 16px;
  z-index: 200;
  font-size: 14px;
  font-weight: 600;
  transition: top 0.2s;
}
.skip-link:focus { top: 0; }

.header {
  background: var(--cardinal);
  color: white;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
  box-shadow: 0 2px 12px rgba(153,0,0,0.3);
}

.header-inner {
  max-width: 1280px;
  margin: 0 auto;
  padding: 10px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
}

.header-title h1 { font-size: 16px; font-weight: 700; letter-spacing: -0.2px; }
.header-title .subtitle { font-size: 13px; font-weight: 400; opacity: 0.8; }

.header-stats {
  display: flex;
  gap: 4px;
  align-items: center;
}
.header-stat {
  font-size: 11px;
  font-weight: 500;
  background: rgba(255,255,255,0.15);
  padding: 3px 10px;
  border-radius: 12px;
  white-space: nowrap;
}

.header-badge .updated {
  background: rgba(255,255,255,0.15);
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

.header-reset {
  padding: 5px 14px;
  border: 1.5px solid rgba(255,255,255,0.4);
  border-radius: 20px;
  background: transparent;
  color: rgba(255,255,255,0.8);
  font-family: inherit;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
  display: none;
}
.header-reset.visible { display: inline-block; }
.header-reset:hover {
  background: rgba(255,255,255,0.2);
  border-color: rgba(255,255,255,0.7);
  color: white;
}

.semester-progress {
  padding: 0 24px 8px;
  max-width: 1280px;
  margin: 0 auto;
}
.semester-progress-bar {
  height: 3px;
  background: rgba(255,255,255,0.2);
  border-radius: 2px;
  position: relative;
  overflow: hidden;
}
.semester-progress-bar::after {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  background: rgba(255,255,255,0.8);
  border-radius: 2px;
  width: var(--progress, 0%);
  transition: width 0.3s;
}
.semester-progress-labels {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  opacity: 0.6;
  margin-top: 2px;
}

/* ═══ Tabs ═══ */
.nav {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: fixed;
  left: 0;
  right: 0;
  top: var(--header-h, 90px);
  z-index: 99;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.nav::-webkit-scrollbar { display: none; }

.nav-inner {
  max-width: 1280px;
  margin: 0 auto;
  padding: 0 24px;
  display: flex;
  justify-content: center;
  gap: 0;
  min-width: max-content;
}

.nav-tab {
  padding: 10px 18px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
  white-space: nowrap;
  user-select: none;
  background: none;
  border-top: none;
  border-left: none;
  border-right: none;
  font-family: inherit;
  outline: none;
  text-align: center;
}

.nav-tab:hover { color: var(--cardinal); }
.nav-tab:focus-visible { color: var(--cardinal); box-shadow: inset 0 -2px 0 var(--cardinal), 0 0 0 2px rgba(153,0,0,0.2); border-radius: 2px 2px 0 0; }
.nav-tab.active { color: var(--cardinal); border-bottom-color: var(--cardinal); }

.main { max-width: 1200px; margin: 0 auto; padding: 20px 24px; padding-top: calc(var(--header-h, 90px) + var(--nav-h, 42px) + 20px); }
.section { display: none; }
.section.active { display: block; }

.section-intro {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 16px;
  line-height: 1.6;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-light);
}

/* ═══ Tables ═══ */
.table-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  margin-bottom: 24px;
}

.table-scroll { overflow-x: auto; }

table { width: 100%; border-collapse: collapse; font-size: 13px; }

thead th {
  background: #F7F7F5;
  font-weight: 600;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  padding: 8px 12px;
  text-align: left;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

/* Sticky first column in calendar */
#calendar .table-scroll table thead th:first-child,
#calendar .table-scroll table tbody td:first-child {
  position: sticky;
  left: 0;
  z-index: 2;
  background: #F7F7F5;
}
#calendar .table-scroll table tbody td:first-child {
  background: var(--surface);
  box-shadow: 2px 0 4px rgba(0,0,0,0.04);
}
/* Calendar zebra + thicker week borders */
#calendar tbody tr { border-bottom: 2px solid var(--border); }
#calendar tbody tr:nth-child(even) td { background: #FAFAF8; }
#calendar tbody tr:nth-child(even) td:first-child { background: #FAFAF8; }
#calendar tbody tr:hover td { background: #F5F4F0; }
#calendar tbody tr:hover td:first-child { background: #F5F4F0; }

/* Week column styling */
.cal-week-label {
  font-size: 14px;
  font-weight: 700;
  color: var(--cardinal);
  line-height: 1.3;
}
.cal-week-dates {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 2px;
}
.cal-week-note {
  font-size: 10px;
  color: var(--text-muted);
  font-style: italic;
  margin-top: 3px;
}

/* Study cards inside calendar cells */
.cal-study {
  padding: 5px 8px;
  margin: 3px 0;
  background: white;
  border: 1px solid var(--border-light);
  border-left: 3px solid #CBD5E1;
  border-radius: 4px;
  font-size: 12px;
  line-height: 1.4;
}
#calendar tbody tr:nth-child(even) .cal-study { background: white; }
.cal-study strong { font-weight: 600; color: var(--text); }
.cal-study-name { color: var(--text-secondary); }
.cal-study.cal-online { border-left-color: #3B82F6; }
.cal-study.cal-inperson { border-left-color: var(--cardinal); }
.cal-study.cal-stacked { border-left-color: #7C3AED; background: #FAFAFF; }
.cal-study.cal-ongoing { opacity: 0.6; border-style: dashed; }
.cal-empty { padding: 4px 0; color: var(--text-muted); font-size: 12px; }

/* Calendar cell padding */
#calendar tbody td { padding: 8px 10px; }
#calendar thead th { padding: 10px 10px; }

tbody td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border-light);
  vertical-align: top;
  font-size: 13px;
}

tbody tr:hover { background: #FAFAF8; }
tbody tr:last-child td { border-bottom: none; }

/* Current week row highlight in calendar */
tbody tr.current-week-row {
  background: var(--current-week-bg);
}
tbody tr.current-week-row td {
  background: var(--current-week-bg) !important;
}
tbody tr.current-week-row td:first-child {
  background: var(--current-week-bg) !important;
  border-left: 3px solid var(--current-week-border);
}
#calendar tbody tr.current-week-row:hover td { background: #E6F3E6 !important; }

/* ═══ Badges ═══ */
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.badge-online { background: var(--online); color: var(--online-text); border: 1px solid var(--online-border); }
.badge-inperson { background: var(--inperson); color: var(--inperson-text); border: 1px solid var(--inperson-border); }
.badge-hybrid { background: var(--hybrid); color: var(--hybrid-text); border: 1px solid var(--hybrid-border); }

.badge-cr {
  background: var(--cardinal);
  color: white;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
}

.badge-2part {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 700;
  background: #F3E5F5;
  color: #6A1B9A;
  border: 1px solid #CE93D8;
  margin-left: 4px;
  vertical-align: middle;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.badge-start {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 700;
  background: #E8F5E9;
  color: #2E7D32;
  border: 1px solid #A5D6A7;
  margin-left: 4px;
  vertical-align: middle;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.badge-end {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 700;
  background: #FFF3E0;
  color: #E65100;
  border: 1px solid #FFCC80;
  margin-left: 4px;
  vertical-align: middle;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.badge-stackable {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 700;
  background: #FFF8E1;
  color: #F57F17;
  border: 1px solid #FFD54F;
  margin-left: 4px;
  vertical-align: middle;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.badge-stackable-maybe {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 700;
  background: #F5F5F5;
  color: #9E9E9E;
  border: 1px solid #E0E0E0;
  margin-left: 4px;
  vertical-align: middle;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.badge-stacked {
  display: inline-block;
  padding: 1px 7px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 700;
  background: #EDE9FE;
  color: #6D28D9;
  border: 1px solid #C4B5FD;
  margin-left: 4px;
  vertical-align: middle;
  letter-spacing: 0.3px;
}

.badge-in-stacked {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 600;
  background: #F5F3FF;
  color: #7C3AED;
  border: 1px solid #DDD6FE;
  margin-left: 4px;
  vertical-align: middle;
}

/* Stacked session row highlight */
#studies-table tr.study-stacked-session td {
  background: #FAFAFF;
  border-bottom: 2px solid #C4B5FD;
}
#studies-table tr.study-stacked-session:hover td {
  background: #F5F3FF;
}

/* ═══ Stacked Session Callout ═══ */
.stack-callout {
  background: white;
  border: 2px solid #7C3AED;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 16px;
}
.stack-callout-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: #F5F3FF;
  border-bottom: 1px solid #EDE9FE;
  flex-wrap: wrap;
}
.stack-callout-icon { font-size: 18px; }
.stack-callout-title {
  font-size: 14px;
  font-weight: 700;
  color: #5B21B6;
  flex: 1;
}
.stack-callout-tags {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.stack-callout-tag {
  font-size: 11px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 12px;
  background: #EDE9FE;
  color: #6D28D9;
}
.stack-callout-tag.primary {
  background: #7C3AED;
  color: white;
}
/* Session bar */
.stack-bar-area { padding: 14px 16px 6px; }
.stack-bar {
  height: 38px;
  border-radius: 6px;
  display: flex;
  overflow: hidden;
  background: #F0EFEC;
}
.stack-block {
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 600;
  color: white;
  padding: 0 6px;
  overflow: hidden;
  white-space: nowrap;
}
.stack-block:not(:first-child) { border-left: 2px solid rgba(255,255,255,0.5); }
.stack-block-1 { background: #16A34A; }
.stack-block-2 { background: #D97706; }
.stack-block-3 { background: #6366F1; }
.stack-bar-empty {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  color: var(--text-muted);
  font-style: italic;
}
.stack-bar-ruler {
  display: flex;
  justify-content: space-between;
  padding: 3px 2px 0;
  font-size: 10px;
  color: var(--text-muted);
}
/* Study breakdown rows */
.stack-studies { padding: 6px 16px 12px; }
.stack-study-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 0;
  font-size: 12px;
}
.stack-study-row:not(:last-child) { border-bottom: 1px solid var(--border-light); }
.stack-study-dot {
  width: 10px; height: 10px;
  border-radius: 3px;
  flex-shrink: 0;
}
.stack-study-name { font-weight: 600; color: var(--text); flex: 1; }
.stack-study-researcher { color: var(--text-muted); font-size: 11px; }
.stack-study-dur { font-size: 12px; color: var(--text-secondary); white-space: nowrap; }
.stack-callout-note {
  padding: 8px 16px;
  font-size: 11px;
  color: var(--text-muted);
  border-top: 1px solid var(--border-light);
  background: #FAFAFF;
}

/* Calendar expanded stacked card */
.cal-stacked-expanded {
  background: #F5F3FF;
  border: 2px solid #7C3AED;
  border-radius: 8px;
  padding: 10px;
  margin: 3px 0;
}
.cal-stacked-expanded .stack-bar { height: 28px; }
.cal-stacked-expanded .stack-study-row { padding: 4px 0; font-size: 11px; }
.cal-stacked-expanded .stack-study-dot { width: 8px; height: 8px; }
.cal-stacked-expanded .stack-callout-title { font-size: 12px; margin-bottom: 6px; }
.cal-stacked-expanded .stack-bar-ruler { font-size: 9px; }

@media (max-width: 768px) {
  .stack-callout-header { flex-direction: column; align-items: flex-start; gap: 6px; }
  .stack-study-row { flex-wrap: wrap; gap: 4px; }
}

.badge-current-week {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 700;
  background: #FFF9F0;
  color: #B8860B;
  border: 1px solid var(--current-week-border);
  margin-left: 6px;
  vertical-align: middle;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  animation: pulse-badge 2s ease-in-out 3;
}

@keyframes pulse-badge {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* ═══ Badge legend tooltip ═══ */
.badge-legend-trigger {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--border-light);
  color: var(--text-muted);
  font-size: 11px;
  font-weight: 700;
  cursor: help;
  position: relative;
  vertical-align: middle;
  margin-left: 4px;
  border: 1px solid var(--border);
  transition: all 0.15s;
}
.badge-legend-trigger:hover, .badge-legend-trigger:focus {
  background: var(--cardinal);
  color: white;
  border-color: var(--cardinal);
}
.badge-legend-trigger:hover .badge-legend-popup,
.badge-legend-trigger:focus .badge-legend-popup {
  display: block;
}
.badge-legend-popup {
  display: none;
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  margin-top: 8px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  padding: 12px 16px;
  font-size: 12px;
  font-weight: 400;
  color: var(--text);
  width: 260px;
  z-index: 50;
  line-height: 1.6;
  text-transform: none;
  letter-spacing: normal;
}
.badge-legend-popup::before {
  content: '';
  position: absolute;
  top: -6px;
  left: 50%;
  transform: translateX(-50%) rotate(45deg);
  width: 10px;
  height: 10px;
  background: var(--surface);
  border-left: 1px solid var(--border);
  border-top: 1px solid var(--border);
}
.badge-legend-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}
.badge-legend-row:last-child { margin-bottom: 0; }

/* ═══ Week groups ═══ */
.week-group { margin-bottom: 12px; }

.week-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 18px;
  background: #F7F7F5;
  border: 1px solid var(--border);
  border-radius: var(--radius) var(--radius) 0 0;
  cursor: pointer;
  user-select: none;
  font-family: inherit;
  font-size: inherit;
  color: inherit;
  width: 100%;
  text-align: left;
}

.week-header:hover { background: #F0F0EE; }
.week-header:focus-visible { outline: 2px solid var(--cardinal); outline-offset: -2px; }
.week-header .week-label { font-weight: 700; font-size: 14px; color: var(--cardinal); }
.week-header .week-dates { font-size: 13px; color: var(--text-secondary); }
.week-header .week-count { margin-left: auto; font-size: 12px; color: var(--text-muted); }
.week-header .chevron { font-size: 12px; color: var(--text-muted); transition: transform 0.2s; }

/* Current week highlight on week-group */
.week-group.current-week .week-header {
  background: var(--current-week-bg);
  border-color: var(--current-week-border);
  border-left: 3px solid var(--current-week-border);
}

.week-group.collapsed .chevron { transform: rotate(-90deg); }

.week-body {
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 var(--radius) var(--radius);
  overflow: hidden;
  max-height: 2000px;
  transition: max-height 0.35s ease, opacity 0.25s ease;
  opacity: 1;
}

.week-group.collapsed .week-body {
  max-height: 0;
  opacity: 0;
  border-color: transparent;
}

.week-group.current-week .week-body {
  border-color: var(--current-week-border);
  border-left: 3px solid var(--current-week-border);
}

.study-row {
  display: grid;
  grid-template-columns: 180px 1fr 80px 60px;
  gap: 10px;
  padding: 8px 16px;
  border-bottom: 1px solid var(--border-light);
  align-items: center;
  font-size: 13px;
}

.study-row:last-child { border-bottom: none; }
.study-row:hover { background: #FAFAF8; }
.study-row .researcher { font-weight: 600; }
.study-row .study-detail { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

/* ═══ Notes ═══ */
.note-bar {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--cardinal);
  border-radius: var(--radius);
  padding: 10px 14px;
  margin-bottom: 14px;
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
}

.note-bar strong { color: var(--text); }

/* ═══ Stacking Planner ═══ */
.stack-planner {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 14px;
  overflow: hidden;
}
.stack-planner-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  cursor: pointer;
  font-size: 13px;
  color: var(--text-secondary);
  transition: background 0.15s;
  user-select: none;
}
.stack-planner-toggle:hover { background: #FAFAF8; }
.stack-planner-icon { font-size: 16px; }
.stack-planner-arrow {
  margin-left: auto;
  font-size: 10px;
  transition: transform 0.2s;
  color: var(--text-muted);
}
.stack-planner.open .stack-planner-arrow { transform: rotate(180deg); }
.stack-planner-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}
.stack-planner.open .stack-planner-body { max-height: 2000px; }
.stack-planner-legend {
  padding: 10px 16px;
  font-size: 12px;
  color: var(--text-muted);
  border-top: 1px solid var(--border-light);
  border-bottom: 1px solid var(--border-light);
}

/* Week cards */
.sp-weeks { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.sp-week {
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  transition: border-color 0.15s;
}
.sp-week.sp-best { border-color: var(--cardinal); border-width: 2px; }
.sp-week-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  background: #FAFAF8;
  gap: 12px;
  flex-wrap: wrap;
}
.sp-week.sp-best .sp-week-header { background: #FEF5F5; }
.sp-week-date { font-weight: 600; font-size: 13px; color: var(--text); }
.sp-week-stats {
  display: flex;
  gap: 12px;
  font-size: 12px;
  color: var(--text-secondary);
}
.sp-week-stat { white-space: nowrap; }
.sp-week-stat strong { color: var(--text); }
.sp-best-tag {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--cardinal);
  background: #FEF0F0;
  padding: 2px 8px;
  border-radius: 10px;
}
.sp-week-studies { padding: 10px 14px; }
.sp-study {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 0;
  font-size: 13px;
}
.sp-study:not(:last-child) { border-bottom: 1px solid var(--border-light); }
.sp-study-name { flex: 1; font-weight: 500; color: var(--text); }
.sp-study-researcher { color: var(--text-muted); font-size: 12px; }
.sp-study-dur { color: var(--text-secondary); font-size: 12px; white-space: nowrap; }
.sp-study-status {
  font-size: 10px;
  font-weight: 600;
  padding: 1px 7px;
  border-radius: 10px;
}
.sp-study-status.confirmed { background: #ECFDF5; color: #065F46; }
.sp-study-status.maybe { background: #FFFBEB; color: #92400E; }
.sp-ll102 {
  padding: 8px 14px;
  font-size: 12px;
  color: var(--text-muted);
  border-top: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  gap: 6px;
}
.sp-ll102-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.sp-ll102-free { background: #22C55E; }
.sp-ll102-busy { background: #EF4444; }

/* No-stack week (only 1 study) */
.sp-week-slim .sp-week-header { opacity: 0.6; }
.sp-week-slim .sp-week-studies { display: none; }

@media (max-width: 768px) {
  .sp-week-header { flex-direction: column; align-items: flex-start; gap: 6px; }
  .sp-study { flex-wrap: wrap; gap: 6px; }
}

.footer {
  text-align: center;
  padding: 24px;
  font-size: 11px;
  color: var(--text-muted);
  border-top: 1px solid var(--border);
}

@media (max-width: 768px) {
  /* Keep both header and nav fixed on mobile */
  .header { position: fixed !important; }
  .nav { top: var(--header-h, 70px); }

  .header-inner { flex-direction: row; flex-wrap: wrap; align-items: center; padding: 8px 16px; gap: 6px; }
  .header-title { flex: 1; min-width: 0; }
  .header-title h1 { font-size: 15px; }
  .header-stats { flex-wrap: wrap; gap: 4px; width: 100%; order: 10; }
  .header-stats .hide-mobile { display: none; }
  .header-badge { order: 5; }
  .header-badge .updated { font-size: 11px; padding: 3px 8px; }
  .dark-mode-toggle { width: 30px; height: 30px; font-size: 12px; order: 6; }
  .semester-progress { padding: 0 16px 6px; }
  .header-title .subtitle { font-size: 11px; }

  .nav-inner { padding: 0 12px; }
  .nav-tab { padding: 10px 12px; font-size: 12px; }

  .main { padding: 12px 16px; padding-top: calc(var(--header-h, 70px) + var(--nav-h, 42px) + 12px); }

  /* Studies controls responsive */
  .studies-controls { flex-direction: column; align-items: stretch; }
  .studies-researcher-select { width: 100%; min-width: 0; font-size: 16px; }
  .studies-search-input { font-size: 16px; } /* prevent iOS zoom */
  .studies-filter-group { min-width: 0; }

  /* My Schedule picker */
  .my-schedule-picker { padding: 8px 10px; top: 40px; border-width: 1.5px; border-radius: 0; position: sticky; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin: 0 -16px 12px; z-index: 50; }
  .my-schedule-picker .picker-label { font-size: 11px; }
  .my-schedule-picker select { font-size: 16px; padding: 6px 28px 6px 8px; border-width: 1px; border-radius: 6px; min-width: 0; } /* 16px prevents iOS zoom */
  .picker-option-label { font-size: 10px; margin-bottom: 2px; }
  .picker-row { flex-direction: row; gap: 6px; align-items: center; flex-wrap: nowrap; }
  .picker-option { max-width: 100%; min-width: 0; flex: 1; }
  .picker-divider { padding-top: 0; font-size: 11px; flex-shrink: 0; }

  /* Facility suites stack */
  .fac-suites { flex-direction: column; }
  .fac-grid { font-size: 11px; }

  /* Badge legend — make tappable on mobile */
  .badge-legend-popup {
    position: fixed;
    top: auto; bottom: 0; left: 0; right: 0;
    transform: none;
    width: 100%;
    border-radius: 12px 12px 0 0;
    max-height: 60vh;
    overflow-y: auto;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    padding: 16px 20px;
  }
  .badge-legend-popup::before { display: none; }

  /* Touch target minimums */
  .cal-nav-btn { padding: 8px 14px; min-height: 36px; }
  .back-to-top { bottom: 16px; right: 16px; width: 44px; height: 44px; }

  /* Researcher card */
  .researcher-card-header { padding: 12px 14px; }
  .rc-header-top { flex-direction: column; align-items: flex-start; gap: 6px; }
  .rc-study { grid-template-columns: 1fr; gap: 4px; }
  .rc-badges { flex-direction: row; align-items: center; }
  .rc-week-header { flex-direction: column; align-items: flex-start; gap: 4px; padding: 8px 14px; }
  .rc-week-header-right { gap: 4px; }
  .rc-minimap svg { max-width: 100%; }
  .rc-minimap-multi { flex-direction: column; }

  /* Progress bar labels */
  .rc-progress-labels { font-size: 9px; margin: 4px 14px 0; }
  .rc-progress { margin: 0 14px 12px; }

  /* Note bars */
  .note-bar { font-size: 12px; padding: 8px 12px; }

  /* This week banner */
  .this-week-banner { padding: 10px 14px; margin-bottom: 14px; }
  .this-week-banner-header { font-size: 12px; flex-wrap: wrap; }
  .this-week-item { flex-wrap: wrap; gap: 4px; }

  /* Credit split */
  .rc-credit-split { flex-wrap: wrap; }

  /* Room breakdown */
  .rc-room-breakdown { font-size: 10px; }
  .rc-room-week { flex-direction: column; gap: 2px; }

  /* Conflicts */
  .rc-conflicts { flex-direction: column; gap: 4px; font-size: 11px; padding: 8px 14px; }

  /* Week header touch target */
  .week-header { padding: 12px 14px; min-height: 44px; }

  /* Calendar nav */
  .cal-nav { flex-wrap: wrap; gap: 8px; }
  .cal-nav-label { font-size: 12px; width: 100%; order: -1; }
  .cal-researcher-filter { font-size: 16px; max-width: 100%; width: 100%; order: 10; margin-top: 4px; }

  /* Hide tab extras on mobile */
  .tab-icon { display: none; }
  .tab-count { display: none; }
  .tab-sub { display: none; }

  /* Facilities week picker full width */
  .fac-week-picker { flex-direction: column; align-items: stretch; }
  .fac-week-picker select { width: 100%; font-size: 16px; }

  /* Room modal — full width on small screens */
  .room-modal { max-width: 100%; border-radius: 0 0 12px 12px; }
  .room-modal-overlay { align-items: flex-start; padding: 0; padding-top: 60px; }
  .room-modal-close { width: 36px; height: 36px; min-width: 36px; }

  /* Mobile card view for All Studies */
  #studies .table-scroll table thead { display: none; }
  #studies .table-scroll table,
  #studies .table-scroll table tbody { display: block; }
  #studies .table-scroll table tr.study-row-data {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 2px 8px;
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    position: relative;
  }
  #studies .table-scroll table tr.filter-hidden { display: none; }
  #studies .table-scroll table tr.study-row-data td {
    border: none; padding: 0; font-size: 13px;
  }
  /* Researcher name: full width top */
  #studies .table-scroll table tr td:nth-child(1) {
    grid-column: 1 / -1; font-size: 14px; margin-bottom: 2px;
  }
  /* Study name: full width */
  #studies .table-scroll table tr td.study-name-col {
    grid-column: 1 / -1; font-size: 13px; margin-bottom: 4px;
  }
  /* Date + format side by side */
  #studies .table-scroll table tr td:nth-child(3) { grid-column: 1; font-size: 12px; color: var(--text-secondary); }
  #studies .table-scroll table tr td:nth-child(4) { grid-column: 2; grid-row: 3; justify-self: end; }
  /* N + Duration + Credits in a row */
  #studies .table-scroll table tr td:nth-child(5),
  #studies .table-scroll table tr td:nth-child(6) { font-size: 12px; color: var(--text-secondary); }
  #studies .table-scroll table tr td:nth-child(5) { grid-column: 1; }
  #studies .table-scroll table tr td:nth-child(6) { grid-column: 2; grid-row: 4; justify-self: end; }
  #studies .table-scroll table tr td:nth-child(7) { grid-column: 1; }
  /* Details: full width, smaller */
  #studies .table-scroll table tr td:nth-child(8) {
    grid-column: 1 / -1; font-size: 11px; color: var(--text-muted); margin-top: 2px;
  }
  #studies .table-scroll table tr td:nth-child(8):empty { display: none; }
  /* Status dots absolute */
  #studies .table-scroll table tr .status-dot { vertical-align: middle; }
  /* Progress bar fits mobile */
  #studies .table-scroll .n-progress { max-width: 80px; }
  /* Search highlight */
  #studies .table-scroll mark { background: #FFF3CD; color: inherit; padding: 0 1px; border-radius: 2px; }

  /* In-person table scroll hint */
  #inperson .table-scroll { position: relative; }
  #inperson .table-scroll::after {
    content: 'Scroll →';
    position: absolute; top: 8px; right: 8px;
    font-size: 10px; color: var(--text-muted);
    background: var(--surface); padding: 2px 6px;
    border-radius: 4px; border: 1px solid var(--border-light);
    pointer-events: none; opacity: 0.7;
  }

  /* Section intro no bottom border on mobile (saves space) */
  .section-intro { border-bottom: none; padding-bottom: 0; margin-bottom: 12px; }

  /* Footer stacks */
  .footer-grid { flex-direction: column; gap: 20px; }
}

/* ═══ Extra-small screens (≤360px) ═══ */
@media (max-width: 360px) {
  .nav-tab { padding: 8px 8px; font-size: 11px; }
  .my-schedule-picker { padding: 6px 8px; }
  .my-schedule-picker .picker-label { font-size: 11px; }
  .picker-row { flex-direction: column; gap: 4px; }
  .picker-divider { display: none; }
}

/* ═══ Facilities Tab ═══ */
.fac-week-picker {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.fac-week-picker label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
}

.fac-week-picker select {
  padding: 10px 36px 10px 14px;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  background: var(--surface);
  box-shadow: var(--shadow-sm);
  outline: none;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235C5C5C' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  transition: border-color 0.15s;
}

.fac-week-picker select:focus { border-color: var(--cardinal); }

.fac-legend {
  display: flex;
  gap: 16px;
  margin-left: auto;
  font-size: 12px;
  color: var(--text-secondary);
  flex-wrap: wrap;
  transition: opacity 0.2s;
}

.fac-legend-item { display: flex; align-items: center; gap: 5px; }

.fac-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
}

.fac-suites {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
  align-items: stretch;
}

.fac-suite {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  display: flex;
  flex-direction: column;
}

.fac-suite-header {
  padding: 14px 18px;
  color: white;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  flex-shrink: 0;
  border-radius: var(--radius) var(--radius) 0 0;
}

.fac-suite-header-112 { background: #333; }
.fac-suite-header-110 { background: #333; }

.fac-suite-title { font-size: 15px; font-weight: 700; }
.fac-suite-sub { font-size: 11px; opacity: 0.7; }

.fac-suite-status {
  padding: 0 18px;
  font-size: 12px;
  color: var(--text-muted);
  overflow: hidden;
  transition: all 0.2s;
  flex-shrink: 0;
  box-sizing: border-box;
  min-height: 0;
}

.fac-suite-status.has-study {
  padding: 10px 18px;
  background: #FFF8E1;
  border-bottom: 1px solid #FFE082;
  color: var(--text);
  font-weight: 500;
}

.fac-grid {
  display: grid;
  grid-template-columns: 1fr 24px 1fr;
  grid-template-rows: repeat(6, minmax(80px, max-content));
  gap: 0;
  padding: 12px;
}

.fac-corr-cell {
  background: #FAFAFA;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 7px;
  color: #CCC;
  letter-spacing: 1px;
  text-transform: uppercase;
  writing-mode: vertical-rl;
  border-left: 1px dashed var(--border-light);
  border-right: 1px dashed var(--border-light);
  grid-column: 2;
  grid-row: 1 / 7;
}

.fac-room {
  border: 1.5px solid #DDD;
  border-radius: 6px;
  padding: 8px 10px;
  margin: 2px;
  position: relative;
  transition: all 0.25s;
  background: #FAFAFA;
  display: flex;
  flex-direction: column;
  cursor: default;
  overflow: visible;
  min-height: 0;
}

.fac-room:hover { border-color: #BBB; }

.fac-room-id {
  font-size: 11px;
  font-weight: 700;
  color: #333;
  margin-bottom: 1px;
}

.fac-room-label {
  font-size: 9px;
  color: var(--text-secondary);
  line-height: 1.2;
}

.fac-room-equip {
  font-size: 8px;
  color: var(--text-muted);
  font-style: italic;
  margin-top: 2px;
  line-height: 1.2;
}

.fac-room-study {
  font-size: 10px;
  font-weight: 600;
  color: var(--cardinal);
  margin-top: 4px;
  line-height: 1.3;
  display: none;
}

.fac-room-study .fac-study-researcher {
  font-size: 9px;
  font-weight: 400;
  color: var(--text-secondary);
}

/* Room type variants */
.fac-backstage {
  background: #FFF8E1;
  border-style: dashed;
  border-color: #FFE082;
}

.fac-reception {
  background: #F0F9FF;
  border-style: dashed;
  border-color: #90CAF9;
}

.fac-room-control {
  background: #F0F4F0;
  border-left: 3px solid #6B8E23;
}

.fac-room-conf {
  background: #F0F4F0;
  border-left: 3px solid #6B8E23;
}

.fac-room-office {
  background: #F0F4F0;
  border-left: 3px solid #6B8E23;
}

.fac-span2 { grid-row: span 2; }

/* Explicit grid placement for LL-112 */
.fac-grid-112 [data-room="112-e"]  { grid-column: 1; grid-row: 1; }
.fac-grid-112 [data-room="112-bs"] { grid-column: 3; grid-row: 1; }
.fac-grid-112 [data-room="112-d"]  { grid-column: 1; grid-row: 2; }
.fac-grid-112 [data-room="112-f"]  { grid-column: 3; grid-row: 2; }
.fac-grid-112 [data-room="112-c"]  { grid-column: 1; grid-row: 3; }
.fac-grid-112 [data-room="112-g"]  { grid-column: 3; grid-row: 3; }
.fac-grid-112 [data-room="112-b"]  { grid-column: 1; grid-row: 4; }
.fac-grid-112 [data-room="112-h"]  { grid-column: 3; grid-row: 4 / 6; }
.fac-grid-112 [data-room="112-a"]  { grid-column: 1; grid-row: 5 / 7; }
.fac-grid-112 [data-room="112-rec"]{ grid-column: 3; grid-row: 6; }

/* Explicit grid placement for LL-110 */
.fac-grid-110 [data-room="110-bs"] { grid-column: 1; grid-row: 1; }
.fac-grid-110 [data-room="110-e"]  { grid-column: 3; grid-row: 1; }
.fac-grid-110 [data-room="110-f"]  { grid-column: 1; grid-row: 2; }
.fac-grid-110 [data-room="110-d"]  { grid-column: 3; grid-row: 2; }
.fac-grid-110 [data-room="110-g"]  { grid-column: 1; grid-row: 3; }
.fac-grid-110 [data-room="110-c"]  { grid-column: 3; grid-row: 3; }
.fac-grid-110 [data-room="110-h"]  { grid-column: 1; grid-row: 4 / 6; }
.fac-grid-110 [data-room="110-b"]  { grid-column: 3; grid-row: 4; }
.fac-grid-110 [data-room="110-rec"]{ grid-column: 1; grid-row: 6; }
.fac-grid-110 [data-room="110-a"]  { grid-column: 3; grid-row: 5 / 7; }

/* Active room state */
.fac-room.fac-active {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  cursor: pointer;
}

.fac-room.fac-active .fac-room-study { display: block; }

/* Room tooltip */
.fac-room-tooltip {
  display: none;
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: white;
  padding: 10px 14px;
  border-radius: 6px;
  font-size: 12px;
  line-height: 1.5;
  width: 220px;
  z-index: 30;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  pointer-events: none;
}
.fac-room-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: #333;
}
.fac-room.fac-active:hover .fac-room-tooltip,
.fac-room.fac-active:focus .fac-room-tooltip {
  display: block;
}

/* ═══ LL102 Computer Lab ═══ */
.fac-suite-102 { margin-top: 16px; }
.fac-suite-header-102 { background: #002B5C; }

.lab102-floor { padding: 16px; }

.lab102-door-area { text-align: center; margin-bottom: 12px; }

.lab102-door {
  display: inline-block;
  padding: 4px 20px;
  background: #FFF8E1;
  border: 2px dashed #FFD54F;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  color: #F57F17;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.lab102-body {
  display: flex;
  gap: 0;
  justify-content: center;
  align-items: flex-end;
}

.lab102-col { display: flex; flex-direction: column; gap: 4px; }

.lab102-col-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  text-align: center;
  margin-bottom: 4px;
}

.lab102-row { display: flex; gap: 4px; }

.lab102-cubicle {
  width: 64px;
  height: 48px;
  border: 1.5px solid #DDD;
  border-radius: 4px;
  background: #FAFAFA;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  position: relative;
  transition: all 0.25s;
}

.lab102-cubicle .lab102-num { font-size: 11px; font-weight: 700; color: var(--text-muted); }
.lab102-cubicle .lab102-icon { font-size: 12px; }

.lab102-cubicle.lab102-active {
  border-width: 2px;
  box-shadow: 0 1px 4px rgba(153,0,0,0.12);
}
.lab102-cubicle.lab102-active .lab102-num { color: var(--cardinal); }

/* Multi-researcher striping for LL102 */
.lab102-cubicle.lab102-multi {
  background: linear-gradient(135deg, var(--lab102-color1) 50%, var(--lab102-color2) 50%) !important;
}

.lab102-aisle {
  width: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 7px;
  color: #CCC;
  letter-spacing: 1px;
  text-transform: uppercase;
  text-align: center;
  line-height: 1.6;
}

.lab102-proctor-area { margin-top: 16px; text-align: center; }

.lab102-proctor {
  display: inline-block;
  padding: 10px 24px;
  background: #F0F4F0;
  border: 1.5px solid #6B8E23;
  border-left: 3px solid #6B8E23;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
}

/* ═══ Mobile facilities fallback ═══ */
.fac-mobile-list { display: none; }

@media (max-width: 768px) {
  .fac-grid { display: none; }
  .fac-mobile-list {
    display: block;
    padding: 12px 16px;
  }
  .fac-mobile-room {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-light);
    font-size: 13px;
  }
  .fac-mobile-room:last-child { border-bottom: none; }
  .fac-mobile-room-id { font-weight: 700; font-size: 12px; }
  .fac-mobile-room-label { font-size: 11px; color: var(--text-secondary); }
  .fac-mobile-room-study { font-size: 12px; color: var(--cardinal); font-weight: 600; margin-top: 4px; }
}

/* print styles moved to enhanced block below */

/* ═══ Mini floor plans in My Schedule ═══ */
.rc-minimap {
  margin-top: 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  background: var(--surface);
}

.rc-minimap-header {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  background: #333;
  color: white;
  font-size: 11px;
  font-weight: 600;
}

.rc-minimap-header span {
  font-weight: 400;
  opacity: 0.6;
  font-size: 10px;
}

.rc-minimap svg {
  display: block;
  width: 100%;
  max-width: 280px;
  height: auto;
  padding: 8px;
}

.rc-minimap-102 .rc-minimap-header {
  background: #002B5C;
  padding: 14px 18px;
  gap: 12px;
  border-radius: 7px 7px 0 0;
}
.rc-minimap-102 .rc-minimap-header .rc-minimap-title {
  font-size: 15px;
  font-weight: 700;
  opacity: 1;
}
.rc-minimap-102 .rc-minimap-header .rc-minimap-sub {
  font-size: 11px;
  font-weight: 400;
  opacity: 0.7;
}

/* LL102 inside researcher card — inherit standard lab102 styles, just minor container adjustments */
.rc-minimap-102 .lab102-floor { padding: 16px; }
.rc-minimap-102 .fac-suite-status { display: none; }
.rc-minimap-102 { box-shadow: var(--shadow-sm); }

/* LL-110/112 inside researcher card — reuse fac-grid layout */
.rc-minimap-suite { box-shadow: var(--shadow-sm); }
.rc-minimap-suite .fac-grid {
  display: grid;
  grid-template-columns: 1fr 24px 1fr;
  grid-template-rows: repeat(6, minmax(64px, max-content));
  gap: 0;
  padding: 12px;
}
.rc-minimap-suite .fac-corr-cell {
  background: #FAFAFA;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 7px;
  color: #CCC;
  letter-spacing: 1px;
  text-transform: uppercase;
  writing-mode: vertical-rl;
  border-left: 1px dashed var(--border-light);
  border-right: 1px dashed var(--border-light);
  grid-column: 2;
  grid-row: 1 / 7;
}
.rc-minimap-suite .fac-room {
  border: 1.5px solid #DDD;
  border-radius: 6px;
  padding: 6px 8px;
  margin: 2px;
  background: #FAFAFA;
  display: flex;
  flex-direction: column;
  transition: all 0.25s;
  min-height: 0;
}
.rc-minimap-suite .fac-room.fac-room-highlighted {
  border-width: 2px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.rc-minimap-suite .fac-room.fac-room-dimmed {
  opacity: 0.45;
}
.rc-minimap-suite .fac-room-id { font-size: 11px; font-weight: 700; color: #333; margin-bottom: 1px; }
.rc-minimap-suite .fac-room-label { font-size: 9px; color: var(--text-secondary); line-height: 1.2; }
.rc-minimap-suite .fac-room-equip { font-size: 8px; color: var(--text-muted); font-style: italic; margin-top: 2px; line-height: 1.2; }
.rc-minimap-suite .fac-backstage { background: #FFF8E1; border-style: dashed; border-color: #FFE082; }
.rc-minimap-suite .fac-reception { background: #F0F9FF; border-style: dashed; border-color: #90CAF9; }
.rc-minimap-suite .fac-room-control { background: #F0F4F0; border-left: 3px solid #6B8E23; }
.rc-minimap-suite .fac-room-conf { background: #F0F4F0; border-left: 3px solid #6B8E23; }
.rc-minimap-suite .fac-room-office { background: #F0F4F0; border-left: 3px solid #6B8E23; }
.rc-minimap-suite .fac-span2 { grid-row: span 2; }

/* Grid placement for 112 inside rc-minimap */
.rc-minimap-suite .fac-grid-112 [data-room="112-e"]  { grid-column: 1; grid-row: 1; }
.rc-minimap-suite .fac-grid-112 [data-room="112-bs"] { grid-column: 3; grid-row: 1; }
.rc-minimap-suite .fac-grid-112 [data-room="112-d"]  { grid-column: 1; grid-row: 2; }
.rc-minimap-suite .fac-grid-112 [data-room="112-f"]  { grid-column: 3; grid-row: 2; }
.rc-minimap-suite .fac-grid-112 [data-room="112-c"]  { grid-column: 1; grid-row: 3; }
.rc-minimap-suite .fac-grid-112 [data-room="112-g"]  { grid-column: 3; grid-row: 3; }
.rc-minimap-suite .fac-grid-112 [data-room="112-b"]  { grid-column: 1; grid-row: 4; }
.rc-minimap-suite .fac-grid-112 [data-room="112-h"]  { grid-column: 3; grid-row: 4 / 6; }
.rc-minimap-suite .fac-grid-112 [data-room="112-a"]  { grid-column: 1; grid-row: 5 / 7; }
.rc-minimap-suite .fac-grid-112 [data-room="112-rec"]{ grid-column: 3; grid-row: 6; }

/* Grid placement for 110 inside rc-minimap */
.rc-minimap-suite .fac-grid-110 [data-room="110-bs"] { grid-column: 1; grid-row: 1; }
.rc-minimap-suite .fac-grid-110 [data-room="110-e"]  { grid-column: 3; grid-row: 1; }
.rc-minimap-suite .fac-grid-110 [data-room="110-f"]  { grid-column: 1; grid-row: 2; }
.rc-minimap-suite .fac-grid-110 [data-room="110-d"]  { grid-column: 3; grid-row: 2; }
.rc-minimap-suite .fac-grid-110 [data-room="110-g"]  { grid-column: 1; grid-row: 3; }
.rc-minimap-suite .fac-grid-110 [data-room="110-c"]  { grid-column: 3; grid-row: 3; }
.rc-minimap-suite .fac-grid-110 [data-room="110-h"]  { grid-column: 1; grid-row: 4 / 6; }
.rc-minimap-suite .fac-grid-110 [data-room="110-b"]  { grid-column: 3; grid-row: 4; }
.rc-minimap-suite .fac-grid-110 [data-room="110-rec"]{ grid-column: 1; grid-row: 6; }
.rc-minimap-suite .fac-grid-110 [data-room="110-a"]  { grid-column: 3; grid-row: 5 / 7; }

/* Dark mode for suite minimaps */
body.dark .rc-minimap-suite .fac-room { background: #2A2A2A; border-color: #3A3A3A; }
body.dark .rc-minimap-suite .fac-room-id { color: #CCC; }
body.dark .rc-minimap-suite .fac-corr-cell { background: #222; border-color: #333; }
body.dark .rc-minimap-suite .fac-backstage { background: #3A3000; border-color: #5A4B00; }
body.dark .rc-minimap-suite .fac-reception { background: #1A2A3A; border-color: #2A4A6A; }
body.dark .rc-minimap-suite .fac-room-control,
body.dark .rc-minimap-suite .fac-room-conf,
body.dark .rc-minimap-suite .fac-room-office { background: #1E2E1E; border-color: #4A6B23; }

/* rc-minimap-suite header — match fac-suite-header */
.rc-minimap-suite .rc-minimap-header {
  padding: 14px 18px;
  gap: 12px;
  border-radius: 7px 7px 0 0;
}
.rc-minimap-suite .rc-minimap-header .rc-minimap-title { font-size: 15px; font-weight: 700; opacity: 1; }
.rc-minimap-suite .rc-minimap-header .rc-minimap-sub { font-size: 11px; font-weight: 400; opacity: 0.7; }
.rc-minimap-112 .rc-minimap-header { background: #333; }
.rc-minimap-110 .rc-minimap-header { background: #333; }

.rc-minimap-multi {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 8px;
  flex-direction: column;
}

.rc-minimap-multi .rc-minimap {
  margin-top: 0;
  flex: 1;
  min-width: 0;
}

/* ═══ Home Intro ═══ */
.home-intro {
  margin-bottom: 20px;
  padding: 16px 20px;
  background: #FAFAF9;
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
}

.home-intro-lead {
  font-size: 13px;
  line-height: 1.65;
  color: var(--text-muted);
  margin-bottom: 14px;
}
.home-intro-lead strong { color: var(--text); }

.home-intro-tabs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 18px;
}

.home-intro-tab {
  font-size: 12.5px;
  line-height: 1.55;
  color: var(--text-muted);
  padding: 10px 14px;
  background: white;
  border-radius: 6px;
  border: 1px solid var(--border-light);
}
.home-intro-tab:hover {
  border-color: var(--cardinal);
  background: #FFFBFB;
}
.home-intro-tab strong {
  color: var(--text-secondary);
  font-size: 12.5px;
}

.home-intro-badges {
  font-size: 11.5px;
  color: var(--text-muted);
  padding-top: 10px;
  border-top: 1px solid var(--border-light);
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px 16px;
}
.home-intro-badges .badge-legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}
.home-intro-badges .sep { display: none; }
.home-intro-badges .badge,
.home-intro-badges .badge-cr,
.home-intro-badges .badge-stackable,
.home-intro-badges .badge-stacked,
.home-intro-badges .badge-2part {
  vertical-align: middle;
  margin-right: 0;
  flex-shrink: 0;
}

@media (max-width: 900px) {
  .home-intro-tabs { grid-template-columns: 1fr; gap: 8px; }
}

@media (max-width: 768px) {
  .home-intro { padding: 16px 18px; }
  .home-intro-lead { font-size: 14px; }
  .home-intro-tab { font-size: 13px; }
  .home-intro-badges { grid-template-columns: 1fr; gap: 5px; }
}

/* ═══ All Studies Controls ═══ */
.studies-filter-row {
  display: flex;
  gap: 12px;
  align-items: flex-end;
  margin-bottom: 14px;
  flex-wrap: wrap;
}
.studies-filter-group { flex: 1; min-width: 200px; }
.studies-filter-label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.4px;
  margin-bottom: 6px;
}
.studies-researcher-select {
  padding: 10px 36px 10px 14px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  font-family: inherit;
  font-size: 14px;
  font-weight: 500;
  background: var(--surface);
  outline: none;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235C5C5C' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  transition: border-color 0.15s;
  min-width: 240px;
}
.studies-researcher-select:focus { border-color: var(--cardinal); }
.studies-researcher-select.has-selection { color: var(--cardinal); font-weight: 600; border-color: var(--cardinal); }

.studies-search-input {
  width: 100%;
  padding: 10px 14px 10px 36px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  font-family: inherit;
  font-size: 14px;
  font-weight: 500;
  background: var(--surface);
  outline: none;
  transition: border-color 0.15s;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%238C8C8C' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: 12px center;
}
.studies-search-input:focus { border-color: var(--cardinal); }
.studies-search-input::placeholder { color: var(--text-muted); font-weight: 400; }
/* Search match highlighting */
#studies-tbody mark {
  background: #FFF3CD;
  color: inherit;
  padding: 0 1px;
  border-radius: 2px;
  font-weight: inherit;
}
body.dark #studies-tbody mark { background: #5A4B00; color: #FFE082; }

.studies-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.format-chips {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.format-chip {
  padding: 6px 14px;
  border: 1px solid var(--border);
  border-radius: 20px;
  background: var(--surface);
  font-family: inherit;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.format-chip:hover { border-color: var(--cardinal); color: var(--cardinal); }
.format-chip.active {
  background: var(--cardinal);
  color: white;
  border-color: var(--cardinal);
}
.format-chip .chip-count {
  font-weight: 700;
  margin-left: 2px;
}


.view-toggle {
  display: flex;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}
.view-btn {
  padding: 7px 12px;
  background: var(--surface);
  border: none;
  font-family: inherit;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.view-btn:first-child { border-right: 1px solid var(--border); }
.view-btn:hover { background: #F5F5F3; }
.view-btn.active { background: var(--cardinal); color: white; }

.studies-result-count {
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 8px;
  min-height: 16px;
}

/* Studies table */
#studies-table { width: 100%; }
#studies-table th { white-space: nowrap; }

.n-progress {
  width: 100%;
  height: 4px;
  background: var(--border-light);
  border-radius: 2px;
  margin-top: 4px;
  overflow: hidden;
}
.n-progress-bar {
  height: 100%;
  background: var(--cardinal);
  border-radius: 2px;
  transition: width 0.3s;
}
.n-progress-label {
  font-size: 10px;
  font-weight: 600;
  color: var(--text-muted);
  display: block;
  margin-top: 1px;
}

.study-sona-link {
  display: inline-block;
  font-size: 10px;
  font-weight: 600;
  color: var(--cardinal);
  background: rgba(153,0,0,0.06);
  border: 1px solid rgba(153,0,0,0.15);
  border-radius: 4px;
  padding: 1px 5px;
  margin-left: 6px;
  text-decoration: none;
  vertical-align: middle;
  letter-spacing: 0.3px;
  transition: background 0.15s, border-color 0.15s;
}
.study-sona-link:hover {
  background: rgba(153,0,0,0.12);
  border-color: var(--cardinal);
}
#studies-table td { vertical-align: top; padding: 8px 10px; }
#studies-table .study-facility { font-size: 11px; color: var(--text-secondary); }
#studies-table .study-notes-cell { font-size: 11px; color: var(--text-secondary); max-width: 200px; }
#studies-table tr.study-past td { opacity: 0.55; }
#studies-table tr.study-past:hover td { opacity: 1; }
#studies-table tr.study-current { background: #FFFCF0; }
.study-name-col { min-width: 180px; }
.study-name-col .study-badges { margin-top: 2px; }

.filter-no-results {
  text-align: center;
  padding: 32px 24px;
  color: var(--text-muted);
  font-size: 13px;
  display: none;
}
.filter-no-results .no-results-icon { font-size: 28px; margin-bottom: 8px; opacity: 0.5; }
.filter-no-results .no-results-text { margin-bottom: 12px; }
.filter-no-results .no-results-clear {
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 6px 14px;
  font-size: 12px;
  font-weight: 500;
  color: var(--cardinal);
  cursor: pointer;
  transition: background 0.15s;
}
.filter-no-results .no-results-clear:hover { background: #FFF0F0; }

/* ═══ My Schedule ═══ */
.my-schedule-picker {
  margin-bottom: 24px;
  background: var(--surface);
  border: 2px solid var(--cardinal);
  border-radius: 14px;
  padding: 14px 24px;
  box-shadow: 0 2px 12px rgba(153,0,0,0.08);
  position: sticky;
  top: 96px;
  z-index: 50;
  transition: box-shadow 0.2s;
}
.my-schedule-picker.picker-stuck {
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  border-radius: 0 0 14px 14px;
}

.my-schedule-picker .picker-label {
  font-size: 14px;
  font-weight: 700;
  color: var(--cardinal);
  white-space: nowrap;
  flex-shrink: 0;
}

.my-schedule-picker .picker-sub { display: none; }

.my-schedule-picker .picker-row {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;
}

.picker-option { flex: 1; min-width: 200px; }

.picker-option-label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.4px;
  margin-bottom: 6px;
  padding-left: 2px;
}

.picker-divider {
  font-size: 13px;
  color: var(--text-muted);
  font-weight: 500;
  flex-shrink: 0;
}

.my-schedule-picker select {
  padding: 10px 36px 10px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 500;
  background: white;
  outline: none;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 12 12'%3E%3Cpath fill='%23990000' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  transition: border-color 0.15s, box-shadow 0.15s;
  min-width: 200px;
}

.my-schedule-picker select:focus { border-color: var(--cardinal); box-shadow: 0 0 0 3px rgba(153,0,0,0.12); }
.my-schedule-picker select.picker-active { border-color: var(--cardinal); font-weight: 600; color: var(--cardinal); }

/* Prev/Next researcher nav */
.researcher-nav {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-left: 4px;
}
.researcher-nav-btn {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 8px;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-secondary);
  transition: all 0.15s;
  font-family: inherit;
  flex-shrink: 0;
}
.researcher-nav-btn:hover:not(:disabled) { border-color: var(--cardinal); color: var(--cardinal); background: #FEF5F5; }
.researcher-nav-btn:disabled { opacity: 0.25; cursor: default; }
body.dark .researcher-nav-btn { background: #2A2A2A; border-color: #3A3A3A; color: #A0A0A0; }
body.dark .researcher-nav-btn:hover:not(:disabled) { background: #3A1A1A; border-color: var(--cardinal); color: #FF8A80; }
@media (max-width: 768px) {
  .researcher-nav-btn { width: 36px; height: 36px; min-height: 36px; }
}



.my-schedule-empty {
  text-align: center;
  padding: 40px 24px;
  color: var(--text-muted);
}

.my-schedule-empty .empty-icon { font-size: 24px; margin-bottom: 8px; opacity: 0.4; }
.my-schedule-empty .empty-text { font-size: 13px; line-height: 1.5; }

.researcher-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  margin-bottom: 24px;
}

.researcher-card-header {
  background: var(--cardinal);
  color: white;
  padding: 14px 18px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.rc-header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

.researcher-card-header .rc-name { font-size: 17px; font-weight: 700; letter-spacing: -0.01em; }

.researcher-card-header .rc-meta {
  display: flex;
  gap: 6px;
  font-size: 11px;
  flex-wrap: wrap;
}

.researcher-card-header .rc-meta span {
  background: rgba(255,255,255,0.15);
  padding: 2px 8px;
  border-radius: 10px;
  white-space: nowrap;
}

.rc-credit-row {
  display: flex;
  gap: 12px;
  font-size: 11px;
  opacity: 0.75;
  padding-top: 2px;
  border-top: 1px solid rgba(255,255,255,0.12);
}

.rc-timeline { padding: 0; }

/* Week grouping in My Schedule */
.rc-week-group {
  border-bottom: 2px solid var(--border);
}
.rc-week-group:last-child { border-bottom: none; }
.rc-week-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 18px;
  background: #F7F7F5;
  border-bottom: 1px solid var(--border-light);
  gap: 10px;
}
.rc-week-header-left {
  display: flex;
  align-items: baseline;
  gap: 8px;
}
.rc-week-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--cardinal);
}
.rc-week-dates {
  font-size: 11px;
  color: var(--text-muted);
}
.rc-week-header-right {
  display: flex;
  gap: 8px;
  align-items: center;
}
.rc-week-stat {
  font-size: 11px;
  color: var(--text-secondary);
  padding: 2px 8px;
  background: white;
  border: 1px solid var(--border-light);
  border-radius: 10px;
}
.rc-week-stat strong { font-weight: 700; }
.rc-week-group.rc-week-past .rc-week-header { opacity: 0.5; }
.rc-week-group.rc-week-past .rc-study { opacity: 0.5; }
.rc-week-group.rc-week-current .rc-week-header {
  background: var(--current-week-bg);
  border-left: 3px solid var(--current-week-border);
}

.rc-study {
  display: grid;
  grid-template-columns: 140px 1fr auto;
  gap: 14px;
  padding: 12px 18px;
  border-bottom: 1px solid var(--border-light);
  align-items: start;
  font-size: 13px;
}

.rc-study:last-child { border-bottom: none; }
.rc-study:hover { background: #FAFAF8; }

.rc-date { font-weight: 600; color: var(--cardinal); white-space: nowrap; font-size: 13px; }

.rc-date .rc-date-sub { font-weight: 400; font-size: 11px; color: var(--text-muted); margin-top: 2px; }

.rc-study-info .rc-study-name { font-weight: 600; color: var(--text); }
.rc-study-info .rc-study-detail { font-size: 12px; color: var(--text-secondary); margin-top: 3px; line-height: 1.5; }

.rc-badges {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 4px;
  white-space: nowrap;
}

.rc-now-marker {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 20px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  background: var(--border-light);
}

.rc-now-marker::before, .rc-now-marker::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.rc-collabs {
  padding: 12px 20px;
  border-bottom: 1px solid var(--border-light);
  font-size: 12px;
  color: var(--text-secondary);
  background: #FAFAF8;
}

.rc-collabs strong { color: var(--text); }

.study-row.filter-hidden,
.week-group.filter-hidden,
tbody tr.filter-hidden { display: none !important; }

.week-group.filter-partial .week-body { max-height: 2000px !important; opacity: 1 !important; border-color: var(--border) !important; }
.week-group.filter-partial .chevron { transform: rotate(0deg) !important; }

/* ═══ Tab enhancements ═══ */
.tab-icon { margin-right: 5px; font-size: 14px; }
.tab-count {
  display: inline-flex; align-items: center; justify-content: center;
  background: var(--border-light); color: var(--text-muted);
  font-size: 10px; font-weight: 700; min-width: 20px; height: 18px;
  border-radius: 9px; margin-left: 6px; padding: 0 5px;
}
.nav-tab.active .tab-count { background: rgba(153,0,0,0.1); color: var(--cardinal); }
.tab-sub {
  display: block;
  font-size: 10px;
  font-weight: 400;
  color: var(--text-muted);
  margin-top: 2px;
  letter-spacing: 0;
}
.nav-tab.active .tab-sub { color: var(--cardinal); opacity: 0.7; }

/* ═══ Sticky filter bar ═══ */
/* ═══ Back to top ═══ */
.back-to-top {
  position: fixed; bottom: 28px; right: 28px; z-index: 200;
  width: 42px; height: 42px; border-radius: 50%;
  background: var(--cardinal); color: white; border: none;
  box-shadow: 0 3px 12px rgba(153,0,0,0.35);
  cursor: pointer; font-size: 18px; display: none;
  align-items: center; justify-content: center;
  transition: all 0.2s; font-family: inherit;
}
.back-to-top:hover { transform: translateY(-2px); box-shadow: 0 5px 16px rgba(153,0,0,0.45); }
.back-to-top.visible { display: flex; }

/* ═══ Collapse/expand all ═══ */
/* ═══ Week group past dimming ═══ */
.week-group.past-week .week-header { opacity: 0.6; }
.week-group.past-week .week-header:hover { opacity: 1; }

/* ═══ Sortable columns ═══ */
th.sortable { cursor: pointer; user-select: none; position: relative; }
th.sortable:hover { background: #EEEDEB; }
th.sortable::after { content: '⇅'; margin-left: 4px; opacity: 0.3; font-size: 10px; }
th.sortable.sort-asc::after { content: '▲'; opacity: 0.7; }
th.sortable.sort-desc::after { content: '▼'; opacity: 0.7; }

/* ═══ In-person study status ═══ */
.status-dot {
  display: inline-block; width: 8px; height: 8px;
  border-radius: 50%; margin-right: 5px; vertical-align: middle;
}
.status-dot.active { background: #4CAF50; box-shadow: 0 0 4px rgba(76,175,80,0.5); }
.status-dot.upcoming { background: #FF9800; }
.status-dot.ended { background: #BDBDBD; }
.status-label { font-size: 11px; font-weight: 600; vertical-align: middle; }
.status-label.active { color: #2E7D32; }
.status-label.upcoming { color: #E65100; }
.status-label.ended { color: #9E9E9E; }

/* ═══ Calendar week nav ═══ */
.cal-nav {
  display: flex; align-items: center; gap: 12px; margin-bottom: 16px;
}
.cal-nav-btn {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 6px; padding: 6px 14px; font-size: 12px;
  font-weight: 600; color: var(--text-secondary); cursor: pointer;
  font-family: inherit; transition: all 0.15s; display: flex;
  align-items: center; gap: 4px;
}
.cal-nav-btn:hover { border-color: var(--cardinal); color: var(--cardinal); }
.cal-nav-btn:disabled { opacity: 0.3; cursor: default; }
.cal-nav-label { font-size: 13px; font-weight: 600; color: var(--text); flex: 1; text-align: center; }
.cal-researcher-filter {
  padding: 6px 28px 6px 10px;
  border: 1.5px solid var(--border);
  border-radius: 6px;
  font-family: inherit;
  font-size: 12px;
  font-weight: 500;
  background: var(--surface);
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%235C5C5C' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 8px center;
  outline: none;
  transition: border-color 0.15s;
  max-width: 200px;
}
.cal-researcher-filter:focus { border-color: var(--cardinal); }
.cal-researcher-filter.has-selection { border-color: var(--cardinal); color: var(--cardinal); font-weight: 600; }
body.dark .cal-researcher-filter { background: #2A2A2A; border-color: #3A3A3A; color: #A0A0A0; }

/* ═══ Room detail modal ═══ */
.room-modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.4);
  z-index: 300; display: none; align-items: center; justify-content: center;
  padding: 20px;
}
.room-modal-overlay.active { display: flex; }
.room-modal {
  background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.25);
  max-width: 360px; width: 100%; overflow: hidden;
  animation: modalIn 0.2s ease;
}
@keyframes modalIn { from { opacity: 0; transform: scale(0.95); } }
.room-modal-header {
  padding: 16px 20px; color: white; font-size: 14px; font-weight: 700;
  display: flex; justify-content: space-between; align-items: center;
}
.room-modal-close {
  background: rgba(255,255,255,0.2); border: none; color: white;
  width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
  font-size: 16px; display: flex; align-items: center; justify-content: center;
}
.room-modal-body { padding: 16px 20px; font-size: 13px; line-height: 1.6; }
.room-modal-row { margin-bottom: 8px; }
.room-modal-row strong { color: var(--text); display: block; font-size: 11px;
  text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-muted); margin-bottom: 2px; }

/* ═══ My Schedule timeline progress ═══ */
.rc-progress {
  margin: 0 18px 12px; height: 5px; background: var(--border-light);
  border-radius: 3px; position: relative; overflow: visible;
}
.rc-progress-fill {
  height: 100%; border-radius: 3px; background: var(--cardinal);
  transition: width 0.4s ease;
}
.rc-progress-marker {
  position: absolute; top: -3.5px; width: 12px; height: 12px;
  background: var(--cardinal); border: 2px solid white;
  border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  transform: translateX(-50%);
}
.rc-progress-labels {
  display: flex; justify-content: space-between;
  font-size: 10px; color: var(--text-muted); margin: 4px 18px 0;
}

/* ═══ Minimap toggle ═══ */
.rc-map-toggle {
  background: none; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px;
  padding: 3px 10px; font-size: 11px; font-weight: 500;
  color: rgba(255,255,255,0.8); cursor: pointer; font-family: inherit;
  margin-left: auto; transition: all 0.15s; white-space: nowrap;
}
.rc-map-toggle:hover { border-color: rgba(255,255,255,0.6); color: white; }
.rc-minimap.maps-hidden, .rc-minimap-multi.maps-hidden { display: none; }

/* ═══ Footer enhanced ═══ */
.footer-enhanced {
  border-top: 1px solid var(--border); padding: 24px;
  max-width: 1280px; margin: 0 auto; font-size: 12px; color: var(--text-secondary);
}
.footer-grid {
  display: flex; gap: 40px; flex-wrap: wrap; margin-bottom: 16px;
}
.footer-col h4 {
  font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 8px;
}
.footer-col a {
  display: block; color: var(--cardinal); text-decoration: none;
  padding: 2px 0; font-weight: 500;
}
.footer-col a:hover { text-decoration: underline; }
.footer-col p { margin-bottom: 4px; line-height: 1.5; }
.footer-credit {
  text-align: center; font-size: 11px; color: var(--text-muted);
  padding-top: 16px; border-top: 1px solid var(--border-light);
}

/* ═══ Enhanced print stylesheet ═══ */
@media print {
  body { background: white; font-size: 11px; }
  .header { position: static !important; box-shadow: none; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
  .nav, .back-to-top, .home-intro,
  .cal-nav, .fac-week-picker, .studies-controls, .studies-filter-row,
  .room-modal-overlay, .rc-map-toggle, .stack-planner,
  .my-schedule-picker, .my-schedule-empty,
  .studies-search-input, .header-reset,
  .changelog-trigger, .changelog-panel,
  .researcher-nav, .cal-researcher-filter { display: none !important; }
  .main { padding: 12px; padding-top: 12px; }
  .header, .nav { position: static !important; }
  /* Show active section only, or My Schedule if it has content */
  .section { display: none !important; page-break-before: always; margin-bottom: 24px; }
  .section.active { display: block !important; }
  .section:first-child { page-break-before: auto; }
  /* My Schedule print styles */
  #myschedule #my-schedule-content { display: block !important; }
  .researcher-card-header { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
  .rc-progress-bar::after, .rc-progress-bar::before { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
  .rc-week-header { break-inside: avoid; }
  .rc-study { break-inside: avoid; }
  .badge { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
  .table-wrap { box-shadow: none; border-color: #CCC; }
  .fac-suites { flex-direction: column; }
  .fac-suite { break-inside: avoid; }
  .footer-enhanced { page-break-before: always; }
  a[href]::after { content: none !important; }
  /* Add a print header */
  #myschedule::before {
    content: 'MOR Subject Pool — Spring 2026 Study Schedule';
    display: block;
    font-size: 14px;
    font-weight: 700;
    color: #990000;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #990000;
  }
}

/* ═══ This Week Summary (#3) ═══ */
.this-week-banner {
  background: var(--current-week-bg);
  border: 1px solid var(--current-week-border);
  border-radius: var(--radius);
  padding: 12px 16px;
  margin-bottom: 16px;
}
.this-week-banner.twb-empty {
  padding: 10px 16px;
  background: #FEFDF8;
  border-color: #EDE8D0;
}
.this-week-banner-header {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 700;
  color: #8B6914;
}
.twb-empty .this-week-banner-header { margin-bottom: 0; }
.this-week-banner:not(.twb-empty) .this-week-banner-header { margin-bottom: 8px; }
.this-week-banner-header .twb-icon { font-size: 16px; }
.this-week-banner-header .twb-dates { font-weight: 400; color: var(--text-secondary); font-size: 12px; }
.this-week-items { display: flex; flex-direction: column; gap: 6px; }
.this-week-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  padding: 4px 0;
}
.this-week-item .twi-dot {
  width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
}
.this-week-item .twi-dot.online { background: var(--online-text); }
.this-week-item .twi-dot.inperson { background: var(--inperson-text); }
.this-week-item .twi-dot.hybrid { background: var(--hybrid-text); }
.this-week-item .twi-name { font-weight: 600; color: var(--text); }
.this-week-item .twi-meta { color: var(--text-secondary); }
.this-week-item .twi-rooms { color: var(--cardinal); font-weight: 500; font-size: 11px; }
.this-week-empty { font-size: 11px; color: #A09060; font-style: italic; font-weight: 400; }

/* ═══ Week-by-week Room Breakdown (#5) ═══ */
.rc-room-breakdown {
  margin-top: 6px;
  font-size: 11px;
  color: var(--text-secondary);
  line-height: 1.5;
}
.rc-room-breakdown summary {
  cursor: pointer;
  font-weight: 600;
  color: var(--cardinal);
  font-size: 11px;
  user-select: none;
  padding: 2px 0;
}
.rc-room-breakdown summary:hover { text-decoration: underline; }
.rc-room-week {
  display: flex;
  gap: 8px;
  padding: 2px 0 2px 12px;
  border-left: 2px solid var(--border-light);
  margin-left: 4px;
}
.rc-room-week .rc-rw-label { font-weight: 500; color: var(--text); white-space: nowrap; min-width: 80px; }
.rc-room-week .rc-rw-rooms { color: var(--text-secondary); }
.rc-room-week .rc-rw-change { color: var(--inperson-text); font-weight: 600; font-size: 10px; }

/* ═══ Conflict/Overlap Indicator (#6) ═══ */
.rc-conflicts {
  padding: 10px 20px;
  background: #FFF8E1;
  border-bottom: 1px solid #FFE082;
  font-size: 12px;
  color: #6D4C00;
  display: flex;
  align-items: center;
  gap: 8px;
}
.rc-conflicts .rc-conflict-icon { font-size: 14px; }
.rc-conflict-item { margin-bottom: 2px; }
.rc-conflict-item strong { color: var(--text); }

/* ═══ Credit Split (#8) ═══ */
.rc-credit-split {
  display: flex;
  gap: 6px;
  font-size: 11px;
  margin-top: 2px;
}
.rc-credit-earned {
  background: rgba(255,255,255,0.2);
  padding: 2px 8px;
  border-radius: 10px;
  opacity: 0.85;
}
.rc-credit-upcoming {
  background: rgba(255,255,255,0.12);
  padding: 2px 8px;
  border-radius: 10px;
  opacity: 0.7;
}

.rc-alloc {
  font-weight: 600;
  color: var(--cardinal);
}

.rc-study-link {
  color: inherit;
  text-decoration: none;
  border-bottom: 1px dashed var(--border);
  transition: border-color 0.15s, color 0.15s;
}
.rc-study-link:hover {
  color: var(--cardinal);
  border-bottom-color: var(--cardinal);
}

/* ═══ Calendar Room Detail (#7) ═══ */
.cal-rooms {
  font-size: 10px;
  color: var(--text-muted);
  font-weight: 400;
  margin-top: 2px;
}


</style>
</head>
<body>

<a href="#main-content" class="skip-link">Skip to content</a>

<div class="header">
  <div class="header-inner">
    <div class="header-title">
      <h1>Spring 2026 Study Schedule</h1>
      <div class="subtitle">MOR Subject Pool · Marshall Behavioral Research Lab</div>
    </div>
    <div class="header-stats">
      <span class="header-stat">1,517 Students</span>
      <span class="header-stat">28 Studies</span>
      <span class="header-stat hide-mobile">16 Researchers</span>
      <span class="header-stat hide-mobile">~7K+ Participants</span>
    </div>
    <div class="header-badge" style="position:relative">
      <div class="updated" id="updated-date" data-date="2026-02-16">Updated Feb 16, 2026</div>
      <span class="whats-new-dot" id="whats-new-dot" title="Schedule updated since your last visit" style="display:none">●</span>
      <button class="changelog-trigger" id="changelog-trigger"><span class="cl-dot"></span> What's New</button>
      <div class="changelog-panel" id="changelog-panel">
        <div class="changelog-panel-header">
          <span>What's Changed</span>
          <button class="changelog-dismiss" id="changelog-dismiss">Dismiss</button>
        </div>
        <div class="changelog-entry">
          <div class="changelog-entry-date">Feb 16, 2026</div>
          <ul class="changelog-entry-items">
            <li>Added Martinez "Pilot" study (Online, Feb 8, 0.25 CR)</li>
            <li>Updated completion tracking: Pilot 90/100, Brainstorming 103/150</li>
            <li>SONA sign-up links added for Pilot and Brainstorming</li>
          </ul>
        </div>
        <div class="changelog-entry">
          <div class="changelog-entry-date">Feb 10, 2026</div>
          <ul class="changelog-entry-items">
            <li>Initial schedule published with 27 studies</li>
            <li>Room assignments for LL-110 and LL-112 suites</li>
            <li>Stacked session planning for Mar 1 pilot</li>
          </ul>
        </div>
      </div>
    </div>
    <button class="header-reset" id="header-reset" title="Clear researcher selection">⟳ Reset</button>
    <button class="dark-mode-toggle" id="dark-mode-toggle" title="Toggle dark mode" aria-label="Toggle dark mode">🌙</button>
  </div>
  <div class="semester-progress" id="semester-progress">
    <div class="semester-progress-bar" id="semester-progress-bar"></div>
    <div class="semester-progress-labels">
      <span>Feb 8</span>
      <span id="semester-progress-pct"></span>
      <span>May 1</span>
    </div>
  </div>
</div>

<nav class="nav" aria-label="Study schedule sections">
  <div class="nav-inner" role="tablist" aria-label="Schedule views">
    <button class="nav-tab active" data-tab="myschedule" role="tab" aria-selected="true" aria-controls="myschedule" id="tab-myschedule"><span class="tab-icon">👤</span>My Schedule<span class="tab-sub">Your studies, rooms &amp; credits</span></button>
    <button class="nav-tab" data-tab="studies" role="tab" aria-selected="false" aria-controls="studies" id="tab-studies"><span class="tab-icon">📋</span>All Studies<span class="tab-count">28</span><span class="tab-sub">Full list with filters</span></button>
    <button class="nav-tab" data-tab="calendar" role="tab" aria-selected="false" aria-controls="calendar" id="tab-calendar"><span class="tab-icon">📅</span>Calendar<span class="tab-sub">Week-by-week grid</span></button>
    <button class="nav-tab" data-tab="facilities" role="tab" aria-selected="false" aria-controls="facilities" id="tab-facilities"><span class="tab-icon">🗺️</span>Facilities<span class="tab-sub">Room maps &amp; weekly usage</span></button>
  </div>
</nav>

<div class="main" id="main-content">

<!-- ═══════════════ MY SCHEDULE ═══════════════ -->
<div class="section active" id="myschedule" role="tabpanel" aria-labelledby="tab-myschedule">

  <div class="my-schedule-picker">
    <div class="picker-row">
      <span class="picker-label">Find Your Schedule</span>
      <div class="researcher-nav">
        <button class="researcher-nav-btn" id="researcher-prev" title="Previous researcher" disabled>‹</button>
      </div>
      <select id="my-researcher-select" aria-label="Select a researcher">
        <option value="">By researcher…</option>
      </select>
      <div class="researcher-nav">
        <button class="researcher-nav-btn" id="researcher-next" title="Next researcher" disabled>›</button>
      </div>
      <span class="picker-divider">or</span>
      <select id="my-study-select" aria-label="Find a study">
        <option value="">By study…</option>
      </select>
    </div>
  </div>

  <div class="home-intro">
    <p class="home-intro-lead">This is the central scheduling hub for the <strong>MOR Subject Pool</strong> at the Marshall Behavioral Research Lab. It covers all 28 studies running this semester across 16 researchers, with approximately 6,900–7,300 participant slots in online, in-person, and hybrid formats.</p>
    <div class="home-intro-tabs">
      <div class="home-intro-tab" data-goto="myschedule" style="cursor:pointer"><strong>My Schedule</strong> — Select your name to see your studies, timeline, room assignments, credits, and collaborators in one place.</div>
      <div class="home-intro-tab" data-goto="studies" style="cursor:pointer"><strong>All Studies</strong> — Browse every study in a sortable table. Filter by format or researcher.</div>
      <div class="home-intro-tab" data-goto="calendar" style="cursor:pointer"><strong>Calendar</strong> — Week-by-week grid of what's running where, organized by facility.</div>
      <div class="home-intro-tab" data-goto="facilities" style="cursor:pointer"><strong>Facilities</strong> — Interactive floor plans of the LL-110, LL-112, and LL102 suites showing room assignments by week.</div>
    </div>
    <div class="home-intro-badges">
      <span class="badge-legend-item"><span class="badge badge-online">Online</span> Qualtrics survey</span>
      <span class="badge-legend-item"><span class="badge badge-inperson">In-Person</span> Lab visit</span>
      <span class="badge-legend-item"><span class="badge badge-hybrid">Hybrid</span> Online + lab</span>
      <span class="badge-legend-item"><span class="badge-cr">0.25</span> Credits</span>
      <span class="badge-legend-item"><span class="badge-stackable">Stackable</span> Can combine in proctored sessions</span>
      <span class="badge-legend-item"><span class="badge-stacked">📦 Pilot</span> Stacked lab session</span>
      <span class="badge-legend-item"><span class="badge-2part">2-Part</span> Multi-wave study</span>
    </div>
  </div>

  <div id="my-schedule-empty" class="my-schedule-empty">
    <div class="empty-icon">📋</div>
    <div class="empty-text">Your study timeline, room assignments, and credits will appear here</div>
  </div>

  <div id="my-schedule-content" style="display:none"></div>

</div>

<!-- ═══════════════ ALL STUDIES ═══════════════ -->
<div class="section" id="studies" role="tabpanel" aria-labelledby="tab-studies">

  <div class="studies-filter-row">
    <div class="studies-filter-group">
      <label class="studies-filter-label" for="researcher-select">Filter by Researcher</label>
      <select id="researcher-select" class="studies-researcher-select" aria-label="Filter by researcher">
        <option value="">All Researchers</option>
      </select>
    </div>
    <div class="studies-filter-group">
      <label class="studies-filter-label" for="studies-search">Search Studies</label>
      <input type="search" id="studies-search" class="studies-search-input" placeholder="Search by name, researcher, notes…" aria-label="Search studies">
    </div>
  </div>

  <div class="studies-controls">
    <div class="format-chips" id="format-chips" role="tablist" aria-label="Filter by format">
      <button class="format-chip active" data-format="all" role="tab" aria-selected="true">All <span class="chip-count" id="chip-all">28</span></button>
      <button class="format-chip" data-format="Online" role="tab" aria-selected="false">Online <span class="chip-count" id="chip-online">16</span></button>
      <button class="format-chip" data-format="In-Person" role="tab" aria-selected="false">In-Person <span class="chip-count" id="chip-inperson">7</span></button>
      <button class="format-chip" data-format="Hybrid" role="tab" aria-selected="false">Hybrid <span class="chip-count" id="chip-hybrid">5</span></button>
    </div>
  </div>

  <div class="studies-result-count" id="filter-result-count"></div>

  <!-- LIST VIEW -->
  <div class="table-wrap">
      <div class="table-scroll">
        <table id="studies-table">
          <thead>
            <tr>
              <th class="sortable" data-col="0">Researcher</th>
              <th class="sortable" data-col="1">Study</th>
              <th class="sortable" data-col="2">Dates</th>
              <th>Format</th>
              <th class="sortable" data-col="4" data-type="num">N</th>
              <th>Duration</th>
              <th class="sortable" data-col="6" data-type="num">Credits</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="studies-tbody"></tbody>
        </table>
      </div>
    </div>

  <!-- No results -->
  <div class="filter-no-results" id="studies-no-results">
    <div class="no-results-icon">🔍</div>
    <div class="no-results-text">No studies match your current filters</div>
    <button class="no-results-clear" id="studies-clear-filters">Clear filters</button>
  </div>

  <!-- Consolidated notes -->
  <div class="note-bar">
    <strong>Lab location:</strong> Verna &amp; Peter Dauterive Hall (VPD), Lower Level · 635 Downey Way · Rooms: LL102 (Computer Lab), LL-110 (Suite), LL-112 (Suite)
  </div>

  <!-- Stacking Planner -->
  <div class="stack-planner" id="stack-planner">
    <div class="stack-planner-toggle" id="stack-planner-toggle">
      <span class="stack-planner-icon">📦</span>
      <span><strong>Stacking Planner</strong> — <span style="color:#16A34A;font-weight:600">1 pilot confirmed (Mar 1)</span> · Find the best weeks to combine short online studies into proctored lab sessions</span>
      <span class="stack-planner-arrow" id="stack-planner-arrow">▼</span>
    </div>
    <div class="stack-planner-body" id="stack-planner-body">
      <div class="stack-planner-legend">
        <span class="badge-stackable">Stackable</span> = researcher interested
        <span style="margin:0 4px">·</span>
        <span class="badge-stackable-maybe">Stackable?</span> = open to it
        <span style="margin:0 4px">·</span>
        <span class="badge-stacked">📦 Pilot</span> = confirmed stacked session
        <span style="margin:0 4px">·</span>
        LL102 has 16 computer stations
      </div>
      <div id="stack-planner-content"></div>
    </div>
  </div>
</div>

<!-- ═══════════════ CALENDAR ═══════════════ -->
<div class="section" id="calendar" role="tabpanel" aria-labelledby="tab-calendar">
  <p class="section-intro">Week-by-week view of all studies, organized by facility</p>

  <div class="cal-nav" id="cal-nav">
    <button class="cal-nav-btn" id="cal-prev" title="Previous week">← Prev</button>
    <span class="cal-nav-label" id="cal-nav-label">All Weeks</span>
    <button class="cal-nav-btn" id="cal-next" title="Next week">Next →</button>
    <button class="cal-nav-btn" id="cal-today" title="Jump to current week" style="color:var(--cardinal);border-color:var(--cardinal)">⦿ Today</button>
    <button class="cal-nav-btn" id="cal-show-all" title="Show all weeks">Show All</button>
    <select id="cal-researcher-filter" class="cal-researcher-filter" aria-label="Highlight researcher">
      <option value="">All Researchers</option>
    </select>
  </div>

  <div class="table-wrap">
    <div class="table-scroll">
      <table>
        <thead>
          <tr><th style="width:160px">Week</th><th>Online Studies</th><th>LL102 (In-Person)</th><th>LL-110 (In-Person)</th><th>LL-112 (In-Person)</th></tr>
        </thead>
        <tbody id="cal-body"></tbody>
      </table>
    </div>
  </div>

  <div class="note-bar" style="margin-top:16px">
    <strong>Lab location:</strong> Verna &amp; Peter Dauterive Hall (VPD), Lower Level · 635 Downey Way · Rooms: LL102 (Computer Lab), LL-110 (Suite), LL-112 (Suite)
  </div>
</div>

<!-- ═══════════════ FACILITIES ═══════════════ -->
<div class="section" id="facilities" role="tabpanel" aria-labelledby="tab-facilities">
  <p class="section-intro">Interactive floor plan of LL-110 and LL-112 suites · Select a week to see facility usage</p>

  <div class="fac-week-picker">
    <label for="fac-week-select">Week:</label>
    <select id="fac-week-select">
      <option value="">No week selected — showing base layout</option>
      <option value="feb8">Feb 8–14</option>
      <option value="feb15">Feb 15–21</option>
      <option value="feb22">Feb 22–28</option>
      <option value="mar1">Mar 1–7</option>
      <option value="mar8">Mar 8–14</option>
      <option value="mar15" disabled>Mar 15–21 (Spring Recess — no in-person)</option>
      <option value="mar22">Mar 22–28</option>
      <option value="mar29">Mar 29–Apr 4</option>
      <option value="apr5">Apr 5–11</option>
      <option value="apr12">Apr 12–18</option>
      <option value="apr19">Apr 19–25</option>
      <option value="apr26">Apr 26–May 1</option>
    </select>
    <div class="fac-legend" id="fac-legend"></div>
  </div>

  <div class="fac-suites">
    <!-- LL-112 Suite -->
    <div class="fac-suite">
      <div class="fac-suite-header fac-suite-header-112">
        <span class="fac-suite-title">LL-112 Suite</span>
        <span class="fac-suite-sub">Audio/Video Recording · NOLDUS</span>
      </div>
      <div class="fac-suite-status" id="fac-112-status"></div>
      <div class="fac-grid fac-grid-112">
        <div class="fac-room" data-room="112-e" id="fac-112-e" tabindex="-1">
          <div class="fac-room-id">112-E</div>
          <div class="fac-room-label">Standard Lab</div>
          <div class="fac-room-equip">Cart Computer · Sink · Phone</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-corr-cell"></div>
        <div class="fac-room fac-backstage" data-room="112-bs">
          <div class="fac-room-id">Backstage</div>
          <div class="fac-room-label">Prep Area</div>
        </div>
        <div class="fac-room" data-room="112-d" id="fac-112-d" tabindex="-1">
          <div class="fac-room-id">112-D</div>
          <div class="fac-room-label">Standard Lab</div>
          <div class="fac-room-equip">Wall Computer · 3 Chairs</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room" data-room="112-f" id="fac-112-f" tabindex="-1">
          <div class="fac-room-id">112-F</div>
          <div class="fac-room-label">NOLDUS Lab</div>
          <div class="fac-room-equip">Wall Computer · 3 Chairs</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room" data-room="112-c" id="fac-112-c" tabindex="-1">
          <div class="fac-room-id">112-C</div>
          <div class="fac-room-label">NOLDUS Lab</div>
          <div class="fac-room-equip">Wall Computer · 3 Chairs</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room" data-room="112-g" id="fac-112-g" tabindex="-1">
          <div class="fac-room-id">112-G</div>
          <div class="fac-room-label">NOLDUS Lab</div>
          <div class="fac-room-equip">Wall Computer · 3 Chairs</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room" data-room="112-b" id="fac-112-b" tabindex="-1">
          <div class="fac-room-id">112-B</div>
          <div class="fac-room-label">NOLDUS Lab</div>
          <div class="fac-room-equip">Wall Computer · 3 Chairs</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room fac-room-control fac-span2" data-room="112-h" id="fac-112-h" tabindex="-1">
          <div class="fac-room-id">112-H</div>
          <div class="fac-room-label">Observation / Control Room</div>
          <div class="fac-room-equip">Multi-Monitor · Recording · Obs Window</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room fac-room-conf" data-room="112-a" id="fac-112-a" tabindex="-1">
          <div class="fac-room-id">112-A</div>
          <div class="fac-room-label">Focus Group / Conference</div>
          <div class="fac-room-equip">60" TV · Conf Table · 9 Chairs</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room fac-reception" data-room="112-rec">
          <div class="fac-room-id">Reception</div>
          <div class="fac-room-label">Check-In</div>
        </div>
      </div>
      <!-- Mobile fallback -->
      <div class="fac-mobile-list" id="fac-112-mobile"></div>
    </div>

    <!-- LL-110 Suite -->
    <div class="fac-suite">
      <div class="fac-suite-header fac-suite-header-110">
        <span class="fac-suite-title">LL-110 Suite</span>
        <span class="fac-suite-sub">Eye-Tracking · TOBII · BIOPAC</span>
      </div>
      <div class="fac-suite-status" id="fac-110-status"></div>
      <div class="fac-grid fac-grid-110">
        <div class="fac-room fac-backstage" data-room="110-bs">
          <div class="fac-room-id">Backstage</div>
          <div class="fac-room-label">Prep Area</div>
        </div>
        <div class="fac-corr-cell"></div>
        <div class="fac-room" data-room="110-e" id="fac-110-e" tabindex="-1">
          <div class="fac-room-id">110-E</div>
          <div class="fac-room-label">Standard Lab</div>
          <div class="fac-room-equip">Cart Computer · Fridge · Sink · Phone</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room" data-room="110-f" id="fac-110-f" tabindex="-1">
          <div class="fac-room-id">110-F</div>
          <div class="fac-room-label">BIOPAC + NOLDUS</div>
          <div class="fac-room-equip">Wall Computer · 3 Chairs</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room" data-room="110-d" id="fac-110-d" tabindex="-1">
          <div class="fac-room-id">110-D</div>
          <div class="fac-room-label">TOBII Lab</div>
          <div class="fac-room-equip">Wall Computer · 3 Chairs</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room" data-room="110-g" id="fac-110-g" tabindex="-1">
          <div class="fac-room-id">110-G</div>
          <div class="fac-room-label">BIOPAC + NOLDUS</div>
          <div class="fac-room-equip">Wall Computer · 3 Chairs</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room" data-room="110-c" id="fac-110-c" tabindex="-1">
          <div class="fac-room-id">110-C</div>
          <div class="fac-room-label">TOBII Lab</div>
          <div class="fac-room-equip">Wall Computer · 3 Chairs</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room fac-room-control fac-span2" data-room="110-h" id="fac-110-h" tabindex="-1">
          <div class="fac-room-id">110-H</div>
          <div class="fac-room-label">Observation / Control Room</div>
          <div class="fac-room-equip">Multi-Monitor · Recording · Obs Window</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room" data-room="110-b" id="fac-110-b" tabindex="-1">
          <div class="fac-room-id">110-B</div>
          <div class="fac-room-label">TOBII Lab</div>
          <div class="fac-room-equip">Wall Computer · 3 Chairs</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
        <div class="fac-room fac-reception" data-room="110-rec">
          <div class="fac-room-id">Reception</div>
          <div class="fac-room-label">Check-In</div>
        </div>
        <div class="fac-room fac-room-office" data-room="110-a" id="fac-110-a" tabindex="-1">
          <div class="fac-room-id">110-A</div>
          <div class="fac-room-label">Lab Manager Office</div>
          <div class="fac-room-equip">Desk · Workstation · 4 Chairs · Phone</div>
          <div class="fac-room-study"></div>
          <div class="fac-room-tooltip"></div>
        </div>
      </div>
      <!-- Mobile fallback -->
      <div class="fac-mobile-list" id="fac-110-mobile"></div>
    </div>
  </div>

  <!-- LL102 Computer Lab -->
  <div class="fac-suite fac-suite-102">
    <div class="fac-suite-header fac-suite-header-102">
      <span class="fac-suite-title">LL102 Computer Lab</span>
      <span class="fac-suite-sub">16 Stations · Proctored Studies · Stacked Sessions</span>
    </div>
    <div class="fac-suite-status" id="fac-102-status"></div>
    <div class="lab102-floor">
      <div class="lab102-door-area">
        <div class="lab102-door">⬅ ENTRANCE</div>
      </div>
      <div class="lab102-body">
        <div class="lab102-col">
          <div class="lab102-col-label">Left Bank · 6 stations</div>
          <div class="lab102-row"><div class="lab102-cubicle"><span class="lab102-num">5</span><span class="lab102-icon">🖥️</span></div><div class="lab102-cubicle"><span class="lab102-num">6</span><span class="lab102-icon">🖥️</span></div></div>
          <div class="lab102-row"><div class="lab102-cubicle"><span class="lab102-num">3</span><span class="lab102-icon">🖥️</span></div><div class="lab102-cubicle"><span class="lab102-num">4</span><span class="lab102-icon">🖥️</span></div></div>
          <div class="lab102-row"><div class="lab102-cubicle"><span class="lab102-num">1</span><span class="lab102-icon">🖥️</span></div><div class="lab102-cubicle"><span class="lab102-num">2</span><span class="lab102-icon">🖥️</span></div></div>
        </div>
        <div class="lab102-aisle"><span>A<br>I<br>S<br>L<br>E</span></div>
        <div class="lab102-col">
          <div class="lab102-col-label">Right Bank · 10 stations</div>
          <div class="lab102-row"><div class="lab102-cubicle"><span class="lab102-num">15</span><span class="lab102-icon">🖥️</span></div><div class="lab102-cubicle"><span class="lab102-num">16</span><span class="lab102-icon">🖥️</span></div></div>
          <div class="lab102-row"><div class="lab102-cubicle"><span class="lab102-num">13</span><span class="lab102-icon">🖥️</span></div><div class="lab102-cubicle"><span class="lab102-num">14</span><span class="lab102-icon">🖥️</span></div></div>
          <div class="lab102-row"><div class="lab102-cubicle"><span class="lab102-num">11</span><span class="lab102-icon">🖥️</span></div><div class="lab102-cubicle"><span class="lab102-num">12</span><span class="lab102-icon">🖥️</span></div></div>
          <div class="lab102-row"><div class="lab102-cubicle"><span class="lab102-num">9</span><span class="lab102-icon">🖥️</span></div><div class="lab102-cubicle"><span class="lab102-num">10</span><span class="lab102-icon">🖥️</span></div></div>
          <div class="lab102-row"><div class="lab102-cubicle"><span class="lab102-num">7</span><span class="lab102-icon">🖥️</span></div><div class="lab102-cubicle"><span class="lab102-num">8</span><span class="lab102-icon">🖥️</span></div></div>
        </div>
      </div>
      <div class="lab102-proctor-area">
        <div class="lab102-proctor">🖥️ Proctor / RA Desk</div>
      </div>
    </div>
  </div>

  <div class="note-bar">
    <strong>Lab location:</strong> Verna &amp; Peter Dauterive Hall (VPD), Lower Level · 635 Downey Way · All facilities shown above are in the Lower Level.
  </div>
</div>

</div>

<footer class="footer-enhanced">
  <div class="footer-grid">
    <div class="footer-col">
      <h4>Location</h4>
      <p>Verna &amp; Peter Dauterive Hall (VPD), Lower Level</p>
      <p>635 Downey Way, Los Angeles, CA 90089</p>
      <p>Rooms: LL102 · LL-110 · LL-112</p>
    </div>
    <div class="footer-col">
      <h4>Contact</h4>
      <p>Brian N. Huh, Lab Manager</p>
      <a href="mailto:huhb@marshall.usc.edu">huhb@marshall.usc.edu</a>
      <p>213-821-8746</p>
    </div>
    <div class="footer-col">
      <h4>Quick Links</h4>
      <a href="https://marshall.usc.edu" target="_blank" rel="noopener">USC Marshall</a>
      <a href="https://marshall-mor.sona-systems.com/" target="_blank" rel="noopener">SONA Systems</a>
      <a href="https://usc-marshall-behavioral-lab.github.io/researchparticipation-buad-304-497-spring26/" target="_blank" rel="noopener">Research Participation Info (Students)</a>
    </div>
  </div>
  <div class="footer-credit">Spring 2026 · MOR Subject Pool · Marshall Behavioral Research Lab · University of Southern California</div>
</footer>

<button class="back-to-top" id="back-to-top" aria-label="Back to top" title="Back to top">↑</button>

<div class="room-modal-overlay" id="room-modal-overlay" role="dialog" aria-modal="true">
  <div class="room-modal" id="room-modal">
    <div class="room-modal-header" id="room-modal-header">
      <span id="room-modal-title"></span>
      <button class="room-modal-close" id="room-modal-close" aria-label="Close">✕</button>
    </div>
    <div class="room-modal-body" id="room-modal-body"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════
// 1. CONSTANTS & DOM REFERENCES
// ═══════════════════════════════════════════════
var TODAY = new Date().toISOString().split('T')[0];
var TODAY_DISPLAY = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

// Measure fixed header+nav heights and set CSS variables
function updateFixedOffsets() {
  var header = document.querySelector('.header');
  var nav = document.querySelector('.nav');
  if (header) document.documentElement.style.setProperty('--header-h', header.offsetHeight + 'px');
  if (nav) document.documentElement.style.setProperty('--nav-h', nav.offsetHeight + 'px');
}
// Run after a brief delay to let layout settle, and on resize
setTimeout(updateFixedOffsets, 50);
window.addEventListener('resize', updateFixedOffsets);

var mySelect = document.getElementById('my-researcher-select');
var myStudySelect = document.getElementById('my-study-select');
var myContent = document.getElementById('my-schedule-content');
var myEmpty = document.getElementById('my-schedule-empty');
var researcherSelect = document.getElementById('researcher-select');
var filterCountEl = document.getElementById('filter-result-count');
var facWeekSelect = document.getElementById('fac-week-select');

// ═══════════════════════════════════════════════
// 2. DATA
// ═══════════════════════════════════════════════
var calData = [
  {wk:"Feb 8",dates:"Feb 8–14",weekStart:"2026-02-08",weekEnd:"2026-02-14",note:"Before prescreening deadline",
    online:"Martinez, Sammy: Pilot",ll102:"—",ll110:"Ferragamo, Alys: In-Person Study – Brainstorming with a Partner (starts)",ll112:"—"},
  {wk:"Feb 15",dates:"Feb 15–21",weekStart:"2026-02-15",weekEnd:"2026-02-21",note:"",
    online:"—",ll102:"—",ll110:"Ferragamo, Alys: In-Person Study – Brainstorming with a Partner",ll112:"—"},
  {wk:"Feb 22",dates:"Feb 22–28",weekStart:"2026-02-22",weekEnd:"2026-02-28",note:"Online invites begin",
    online:"Berry, Zachariah: Hierarchy and Corruption\nBrouwers, Jeslyn: Achievement and Ambition in the Age of AI\nMartinez, Sammy: Broker 1",
    ll102:"—",ll110:"Ferragamo, Alys: In-Person Study – Brainstorming with a Partner",ll112:"Berry, Zachariah: Org Change (starts)\nLee, Elena & Kwon, Brian: AI-Assisted Negotiation Study (starts)"},
  {wk:"Mar 1",dates:"Mar 1–7",weekStart:"2026-03-01",weekEnd:"2026-03-07",note:"",
    online:"Berry, Zachariah: TED Judges\nHale, James: KODISV – Collecting Dyadic Videos of Disputes\nWakslak, Cheryl: Thinking About Others\nWiltermuth, Scott: Sammy Dissertation Study 1",
    ll102:"Ferragamo, Alys: AI Task (starts)\n📦 Stacked Lab Session (Pilot): TED Judges + Dissertation Study 1 + Thinking About Others",ll110:"Ferragamo, Alys: In-Person Study – Brainstorming with a Partner",ll112:"Berry, Zachariah: Org Change\nLee, Elena & Kwon, Brian: AI-Assisted Negotiation Study"},
  {wk:"Mar 8",dates:"Mar 8–14",weekStart:"2026-03-08",weekEnd:"2026-03-14",note:"",
    online:"Anicich, Eric: Work Recovery Perceptions Pt 1 (2-part)\nMartinez, Sammy: Broker 2\nWakslak, Cheryl: Organizational Statements\nWiltermuth, Scott: Sammy Dissertation Study 2",
    ll102:"Ferragamo, Alys: AI Task",ll110:"Ferragamo, Alys: In-Person Study – Brainstorming with a Partner (final)",ll112:"Berry, Zachariah: Org Change\nLee, Elena & Kwon, Brian: AI-Assisted Negotiation Study (final)"},
  {wk:"Mar 15",dates:"Mar 15–21",weekStart:"2026-03-15",weekEnd:"2026-03-21",note:"Spring Recess — online only",
    online:"Lee, Elena: Strategic Decision with AI",ll102:"—",ll110:"—",ll112:"—"},
  {wk:"Mar 22",dates:"Mar 22–28",weekStart:"2026-03-22",weekEnd:"2026-03-28",note:"",
    online:"Anicich, Eric: Work Recovery Perceptions Pt 2 (2-part)\nMartinez, Sammy: Broker 3",
    ll102:"Ferragamo, Alys: AI Task (final)\nLee, Elena: AI Interaction for Persuasion (starts)",ll110:"Martinez, Sammy: Broker – In-Person Option TBD (starts)",ll112:"Berry, Zachariah: Org Change (final)\nFerragamo, Alys: AI Interviews (starts)"},
  {wk:"Mar 29",dates:"Mar 29–Apr 4",weekStart:"2026-03-29",weekEnd:"2026-04-04",note:"",
    online:"Berry, Zachariah: MAC 1",
    ll102:"Dittmann, Andrea: Survey About Your USC Marshall Experiences T1 (2-wave)\nLee, Elena: AI Interaction for Persuasion",ll110:"Martinez, Sammy: Broker – In-Person Option TBD",ll112:"Berry, Zachariah: Intrapersonal Loyalty Effect (starts)\nFerragamo, Alys: AI Interviews"},
  {wk:"Apr 5",dates:"Apr 5–11",weekStart:"2026-04-05",weekEnd:"2026-04-11",note:"",
    online:"—",ll102:"Lee, Elena: AI Interaction for Persuasion",ll110:"Martinez, Sammy: Broker – In-Person Option TBD\nBerry, Zachariah: Intrapersonal Loyalty Effect",ll112:"Berry, Zachariah: Intrapersonal Loyalty Effect\nFast, Nate & Yu, Siyu: Team AI Use and Leadership Emergence (starts)\nFerragamo, Alys: AI Interviews"},
  {wk:"Apr 12",dates:"Apr 12–18",weekStart:"2026-04-12",weekEnd:"2026-04-18",note:"",
    online:"—",ll102:"Lee, Elena: AI Interaction for Persuasion (final)",ll110:"Martinez, Sammy: Broker – In-Person Option TBD\nBerry, Zachariah: Intrapersonal Loyalty Effect",ll112:"Berry, Zachariah: Intrapersonal Loyalty Effect\nFast, Nate & Yu, Siyu: Team AI Use and Leadership Emergence\nFerragamo, Alys: AI Interviews (final)"},
  {wk:"Apr 19",dates:"Apr 19–25",weekStart:"2026-04-19",weekEnd:"2026-04-25",note:"",
    online:"—",ll102:"Dittmann, Andrea: Survey About Your USC Marshall Experiences T2 (2-wave)",ll110:"Martinez, Sammy: Broker – In-Person Option TBD (final)\nBerry, Zachariah: Intrapersonal Loyalty Effect (final)",ll112:"Berry, Zachariah: Intrapersonal Loyalty Effect (final)\nFast, Nate & Yu, Siyu: Team AI Use and Leadership Emergence"},
  {wk:"Apr 26",dates:"Apr 26–May 1",weekStart:"2026-04-26",weekEnd:"2026-05-01",note:"Final week",
    online:"—",ll102:"—",ll110:"—",ll112:"Fast, Nate & Yu, Siyu: Team AI Use and Leadership Emergence (final)"},
];

var allStudies = [
  {researcher:"Martinez, Sammy", study:"Pilot", week:"Feb 8", dateSort:"2026-02-08", dateLabel:"Week of Feb 8", n:"100", dur:"10 min", format:"Online", cr:"0.25", facility:null, notes:null, completed:90, link:"https://marshall-mor.sona-systems.com/default.aspx?p_return_experiment_id=1016", irb:null},
  {researcher:"Berry, Zachariah", study:"Hierarchy and Corruption", week:"Feb 22", dateSort:"2026-02-22", dateLabel:"Week of Feb 22", n:"200", dur:"6 min", format:"Online", cr:"0.25", facility:null, notes:null, stackable:true, irb:null},
  {researcher:"Martinez, Sammy", study:"Broker 1", week:"Feb 22", dateSort:"2026-02-22", dateLabel:"Week of Feb 22", n:"200", dur:"5 min", format:"Online", cr:"0.25", facility:null, notes:null, irb:null},
  {researcher:"Brouwers, Jeslyn", study:"Achievement and Ambition in the Age of AI", week:"Feb 22", dateSort:"2026-02-22", dateLabel:"Week of Feb 22", n:"300", dur:"30 min", format:"Online", cr:"0.50", facility:null, notes:null, irb:null},
  {researcher:"Hale, James", study:"KODISV – Collecting Dyadic Videos of Disputes", week:"Mar 1", dateSort:"2026-03-01", dateLabel:"Week of Mar 1", n:"200", dur:"30 min", format:"Online", cr:"0.50", facility:null, notes:null, coPIs:["Kim, Peter","Gratch, Jonathan"], irb:null},
  {researcher:"Berry, Zachariah", study:"TED Judges", week:"Mar 1", dateSort:"2026-03-01", dateLabel:"Week of Mar 1", n:"200", dur:"5 min", format:"Online", cr:"0.25", facility:null, notes:null, stackable:true, stacked:"mar1", irb:null},
  {researcher:"Wiltermuth, Scott", study:"Sammy Dissertation Study 1", week:"Mar 1", dateSort:"2026-03-01", dateLabel:"Week of Mar 1", n:"250", dur:"15 min", format:"Online", cr:"0.25", facility:null, notes:null, stackable:"maybe", stacked:"mar1", irb:null},
  {researcher:"Wakslak, Cheryl", study:"Thinking About Others", week:"Mar 1", dateSort:"2026-03-01", dateLabel:"Week of Mar 1", n:"400", dur:"10 min", format:"Online", cr:"0.25", facility:null, notes:null, stackable:"maybe", stacked:"mar1", irb:null},
  {researcher:"Stacked Session (Pilot)", study:"Stacked Lab Session — Week of Mar 1", week:"Mar 1", dateSort:"2026-03-01", dateLabel:"Week of Mar 1", n:"16/slot", dur:"30 min", format:"In-Person", cr:"0.50", facility:"LL102", notes:"Pilot: Berry TED Judges (5m) + Wiltermuth Dissertation Study 1 (15m) + Wakslak Thinking About Others (10m) · Online option TBD", isStackedSession:true, stackedComponents:["TED Judges","Sammy Dissertation Study 1","Thinking About Others"], stackedResearchers:["Berry, Zachariah","Wiltermuth, Scott","Wakslak, Cheryl"], irb:null},
  {researcher:"Martinez, Sammy", study:"Broker 2", week:"Mar 8", dateSort:"2026-03-08", dateLabel:"Week of Mar 8", n:"200", dur:"5 min", format:"Online", cr:"0.25", facility:null, notes:null, irb:null},
  {researcher:"Wiltermuth, Scott", study:"Sammy Dissertation Study 2", week:"Mar 8", dateSort:"2026-03-08", dateLabel:"Week of Mar 8", n:"200", dur:"15 min", format:"Online", cr:"0.25", facility:null, notes:"Depends on Sammy Dissertation Study 1", stackable:"maybe", irb:null},
  {researcher:"Wakslak, Cheryl", study:"Organizational Statements", week:"Mar 8", dateSort:"2026-03-08", dateLabel:"Week of Mar 8", n:"500", dur:"15 min", format:"Online", cr:"0.25", facility:null, notes:null, stackable:"maybe", irb:null},
  {researcher:"Anicich, Eric", study:"Work Recovery Perceptions — Part 1", week:"Mar 8", dateSort:"2026-03-08", dateLabel:"Week of Mar 8", n:"200–400", dur:"2-part", format:"Online", cr:"0.50", facility:null, notes:"2-part study: Part 1 before Spring Recess", tag:"2-Part", irb:null},
  {researcher:"Lee, Elena", study:"Strategic Decision with AI", week:"Mar 15", dateSort:"2026-03-15", dateLabel:"Week of Mar 15 (Spring Recess)", n:"300", dur:"30 min", format:"Online", cr:"0.50", facility:null, notes:"Runs during Spring Recess", irb:null},
  {researcher:"Martinez, Sammy", study:"Broker 3", week:"Mar 22", dateSort:"2026-03-22", dateLabel:"Week of Mar 22", n:"400", dur:"10 min", format:"Online", cr:"0.25", facility:null, notes:null, irb:null},
  {researcher:"Anicich, Eric", study:"Work Recovery Perceptions — Part 2", week:"Mar 22", dateSort:"2026-03-22", dateLabel:"Week of Mar 22", n:"200–400", dur:"2-part", format:"Online", cr:"0.50", facility:null, notes:"2-part study: Part 2 after Spring Recess", tag:"2-Part", irb:null},
  {researcher:"Berry, Zachariah", study:"MAC 1", week:"Mar 29", dateSort:"2026-03-29", dateLabel:"Week of Mar 29", n:"200", dur:"5 min", format:"Online", cr:"0.25", facility:null, notes:null, stackable:true, irb:null},
  {researcher:"Ferragamo, Alys", study:"In-Person Study – Brainstorming with a Partner", dateSort:"2026-02-10", dateLabel:"Feb 10 – Mar 14", n:"150", dur:"30 min", format:"In-Person", cr:"0.50", facility:"LL-110", notes:null, completed:103, link:"https://marshall-mor.sona-systems.com/exp_info.aspx?experiment_id=1014", irb:null},
  {researcher:"Berry, Zachariah", study:"Org Change", dateSort:"2026-02-22", dateLabel:"Feb 22 – Mar 28", n:"200", dur:"10 min", format:"In-Person", cr:"0.25", facility:"LL-112", notes:null, irb:null},
  {researcher:"Ferragamo, Alys", study:"AI Task", dateSort:"2026-03-01", dateLabel:"Mar 1 – Mar 28", n:"400", dur:"30 min", format:"Hybrid", cr:"0.50", facility:"LL102", notes:null, irb:null},
  {researcher:"Lee, Elena", study:"AI Interaction for Persuasion", dateSort:"2026-03-22", dateLabel:"Mar 22 – Apr 18", n:"300", dur:"30 min", format:"Hybrid", cr:"0.50", facility:"LL102", notes:null, irb:null},
  {researcher:"Lee, Elena", study:"AI-Assisted Negotiation Study", dateSort:"2026-02-22", dateLabel:"Feb 22 – Mar 14", n:"300", dur:"30 min", format:"In-Person", cr:"0.50", facility:"LL-112", notes:null, coPIs:["Kwon, Brian","Kim, Peter"], irb:null},
  {researcher:"Ferragamo, Alys", study:"AI Interviews", dateSort:"2026-03-22", dateLabel:"Mar 22 – Apr 18", n:"50", dur:"30 min", format:"Hybrid", cr:"0.50", facility:"LL-112", notes:null, irb:null},
  {researcher:"Martinez, Sammy", study:"Broker – In-Person Option (TBD)", dateSort:"2026-03-22", dateLabel:"Mar 22 – Apr 25", n:"300", dur:"15 min", format:"In-Person", cr:"0.25", facility:"LL-110", notes:"TBD status", irb:null},
  {researcher:"Dittmann, Andrea", study:"Survey About Your USC Marshall Experiences — T1", dateSort:"2026-03-29", dateLabel:"Mar 29 – Apr 4", n:"100+", dur:"10 min", format:"Hybrid", cr:"0.25", facility:"LL102", notes:null, tag:"2-Wave", coPIs:["Truong, Mindy"], irb:null},
  {researcher:"Berry, Zachariah", study:"Intrapersonal Loyalty Effect", dateSort:"2026-03-29", dateLabel:"Mar 29 – Apr 25", n:"150", dur:"10 min", format:"In-Person", cr:"0.25", facility:"LL-112 + LL-110", notes:"Dyads required — start together, then separate rooms", irb:null},
  {researcher:"Fast, Nate", study:"Team AI Use and Leadership Emergence", dateSort:"2026-04-05", dateLabel:"Apr 5 – May 1", n:"800", dur:"60–90 min", format:"In-Person", cr:"1.00", facility:"LL-112", notes:null, coPIs:["Yu, Siyu"], irb:null},
  {researcher:"Dittmann, Andrea", study:"Survey About Your USC Marshall Experiences — T2", dateSort:"2026-04-19", dateLabel:"Apr 19 – Apr 25", n:"100+", dur:"7 min", format:"Hybrid", cr:"0.25", facility:"LL102", notes:null, tag:"2-Wave", coPIs:["Truong, Mindy"], irb:null},
];

var RC = {
  'Berry':     {bg:'#FFF0F0', bd:'#D44', tx:'#A22'},
  'Ferragamo': {bg:'#EEF0FF', bd:'#55C', tx:'#339'},
  'Martinez':  {bg:'#FFF7E8', bd:'#C90', tx:'#864'},
  'Fast':      {bg:'#EEFAEE', bd:'#393', tx:'#262'},
  'Dittmann':  {bg:'#F8EEFF', bd:'#93C', tx:'#628'},
  'Lee':       {bg:'#EEFAFA', bd:'#2AA', tx:'#166'},
  'Hale':      {bg:'#FBF5EE', bd:'#A62', tx:'#741'},
};

var facilityUsage = {
  feb8: {
    '110': [{study:'In-Person Study – Brainstorming with a Partner', researcher:'Ferragamo', rooms:['110-b','110-c','110-d'], badge:'start'}],
    '112': []
  },
  feb15: {
    '110': [{study:'In-Person Study – Brainstorming with a Partner', researcher:'Ferragamo', rooms:['110-b','110-c','110-d']}],
    '112': []
  },
  feb22: {
    '110': [{study:'In-Person Study – Brainstorming with a Partner', researcher:'Ferragamo', rooms:['110-b','110-c','110-d']}],
    '112': [{study:'Org Change', researcher:'Berry', rooms:['112-a','112-d','112-e'], badge:'start'},
            {study:'AI-Assisted Negotiation Study', researcher:'Lee', rooms:['112-b','112-c','112-f','112-g'], badge:'start'}]
  },
  mar1: {
    '110': [{study:'In-Person Study – Brainstorming with a Partner', researcher:'Ferragamo', rooms:['110-b','110-c','110-d']}],
    '112': [{study:'Org Change', researcher:'Berry', rooms:['112-a','112-d','112-e']},
            {study:'AI-Assisted Negotiation Study', researcher:'Lee', rooms:['112-b','112-c','112-f','112-g']}],
    '102': [{study:'AI Task', researcher:'Ferragamo', badge:'start'}, {study:'Stacked Lab Session (Pilot)', researcher:'Berry / Wiltermuth / Wakslak', badge:'pilot'}]
  },
  mar8: {
    '110': [{study:'In-Person Study – Brainstorming with a Partner', researcher:'Ferragamo', rooms:['110-b','110-c','110-d'], badge:'end'}],
    '112': [{study:'Org Change', researcher:'Berry', rooms:['112-a','112-d','112-e']},
            {study:'AI-Assisted Negotiation Study', researcher:'Lee', rooms:['112-b','112-c','112-f','112-g'], badge:'end'}],
    '102': [{study:'AI Task', researcher:'Ferragamo'}]
  },
  mar22: {
    '110': [{study:'Broker – In-Person Option (TBD)', researcher:'Martinez', rooms:['110-b','110-c','110-d','110-e','110-f','110-g'], badge:'start'}],
    '112': [{study:'Org Change', researcher:'Berry', rooms:['112-a','112-b','112-c','112-d','112-e'], badge:'end'},
            {study:'AI Interviews', researcher:'Ferragamo', rooms:['112-f','112-g'], badge:'start'}],
    '102': [{study:'AI Task', researcher:'Ferragamo', badge:'end'}, {study:'AI Interaction for Persuasion', researcher:'Lee', badge:'start'}]
  },
  mar29: {
    '110': [{study:'Broker – In-Person Option (TBD)', researcher:'Martinez', rooms:['110-b','110-c','110-d','110-e','110-f','110-g']}],
    '112': [{study:'Intrapersonal Loyalty Effect', researcher:'Berry', rooms:['112-a','112-b','112-c','112-d','112-e'], badge:'start'},
            {study:'AI Interviews', researcher:'Ferragamo', rooms:['112-f','112-g']}],
    '102': [{study:'Survey About Your USC Marshall Experiences — T1', researcher:'Dittmann'}, {study:'AI Interaction for Persuasion', researcher:'Lee'}]
  },
  apr5: {
    '110': [{study:'Broker – In-Person Option (TBD)', researcher:'Martinez', rooms:['110-f','110-g']},
            {study:'Intrapersonal Loyalty Effect', researcher:'Berry', rooms:['110-b','110-c','110-d','110-e']}],
    '112': [{study:'Intrapersonal Loyalty Effect', researcher:'Berry', rooms:['112-d','112-e']},
            {study:'Team AI Use and Leadership Emergence', researcher:'Fast', rooms:['112-a','112-b','112-c'], badge:'start'},
            {study:'AI Interviews', researcher:'Ferragamo', rooms:['112-f','112-g']}],
    '102': [{study:'AI Interaction for Persuasion', researcher:'Lee'}]
  },
  apr12: {
    '110': [{study:'Broker – In-Person Option (TBD)', researcher:'Martinez', rooms:['110-f','110-g']},
            {study:'Intrapersonal Loyalty Effect', researcher:'Berry', rooms:['110-b','110-c','110-d','110-e']}],
    '112': [{study:'Intrapersonal Loyalty Effect', researcher:'Berry', rooms:['112-d','112-e']},
            {study:'Team AI Use and Leadership Emergence', researcher:'Fast', rooms:['112-a','112-b','112-c']},
            {study:'AI Interviews', researcher:'Ferragamo', rooms:['112-f','112-g'], badge:'end'}],
    '102': [{study:'AI Interaction for Persuasion', researcher:'Lee', badge:'end'}]
  },
  apr19: {
    '110': [{study:'Broker – In-Person Option (TBD)', researcher:'Martinez', rooms:['110-f','110-g'], badge:'end'},
            {study:'Intrapersonal Loyalty Effect', researcher:'Berry', rooms:['110-b','110-c','110-d','110-e'], badge:'end'}],
    '112': [{study:'Intrapersonal Loyalty Effect', researcher:'Berry', rooms:['112-d','112-e'], badge:'end'},
            {study:'Team AI Use and Leadership Emergence', researcher:'Fast', rooms:['112-a','112-b','112-c','112-f','112-g']}],
    '102': [{study:'Survey About Your USC Marshall Experiences — T2', researcher:'Dittmann'}]
  },
  apr26: {
    '112': [{study:'Team AI Use and Leadership Emergence', researcher:'Fast', rooms:['112-a','112-b','112-c','112-d','112-e','112-f','112-g'], badge:'end'}]
  }
};

// Room layout data for SVG minimaps — [x, y, w, h, label]
// Room data for LL-112 and LL-110 suites
var suiteRoomData = {
  '112': [
    {id:'112-e', label:'Standard Lab', equip:'Cart Computer · Sink · Phone'},
    {id:'112-bs', label:'Prep Area', type:'backstage'},
    {id:'112-d', label:'Standard Lab', equip:'Wall Computer · 3 Chairs'},
    {id:'112-f', label:'NOLDUS Lab', equip:'Wall Computer · 3 Chairs'},
    {id:'112-c', label:'NOLDUS Lab', equip:'Wall Computer · 3 Chairs'},
    {id:'112-g', label:'NOLDUS Lab', equip:'Wall Computer · 3 Chairs'},
    {id:'112-b', label:'NOLDUS Lab', equip:'Wall Computer · 3 Chairs'},
    {id:'112-h', label:'Observation / Control Room', equip:'Multi-Monitor · Recording · Obs Window', type:'control', span:true},
    {id:'112-a', label:'Focus Group / Conference', equip:'60" TV · Conf Table · 9 Chairs', type:'conf', span:true},
    {id:'112-rec', label:'Check-In', type:'reception'}
  ],
  '110': [
    {id:'110-bs', label:'Prep Area', type:'backstage'},
    {id:'110-e', label:'Standard Lab', equip:'Cart Computer · Fridge · Sink · Phone'},
    {id:'110-f', label:'BIOPAC + NOLDUS', equip:'Wall Computer · 3 Chairs'},
    {id:'110-d', label:'TOBII Lab', equip:'Wall Computer · 3 Chairs'},
    {id:'110-g', label:'BIOPAC + NOLDUS', equip:'Wall Computer · 3 Chairs'},
    {id:'110-c', label:'TOBII Lab', equip:'Wall Computer · 3 Chairs'},
    {id:'110-h', label:'Observation / Control Room', equip:'Multi-Monitor · Recording · Obs Window', type:'control', span:true},
    {id:'110-b', label:'TOBII Lab', equip:'Wall Computer · 3 Chairs'},
    {id:'110-rec', label:'Check-In', type:'reception'},
    {id:'110-a', label:'Lab Manager Office', equip:'Desk · Workstation · 4 Chairs · Phone', type:'office', span:true}
  ]
};

// Generate HTML grid minimap for a suite with highlighted rooms
function buildMinimap(suite, highlightRooms, color) {
  var rooms = suiteRoomData[suite];
  if (!rooms) return '';
  var bg = color.bg || '#FFF5F5';
  var bd = color.bd || '#D44';
  var tx = color.tx || '#A22';

  var html = '<div class="fac-grid fac-grid-' + suite + '">';

  rooms.forEach(function(room) {
    var isHighlighted = highlightRooms.indexOf(room.id) > -1;
    var isUtil = room.type === 'backstage' || room.type === 'reception';
    var typeClass = '';
    if (room.type === 'backstage') typeClass = ' fac-backstage';
    else if (room.type === 'reception') typeClass = ' fac-reception';
    else if (room.type === 'control') typeClass = ' fac-room-control';
    else if (room.type === 'conf') typeClass = ' fac-room-conf';
    else if (room.type === 'office') typeClass = ' fac-room-office';
    var spanClass = room.span ? ' fac-span2' : '';
    var stateClass = isHighlighted ? ' fac-room-highlighted' : (!isUtil ? ' fac-room-dimmed' : '');
    var inlineStyle = isHighlighted ? ' style="background:' + bg + ';border-color:' + bd + '"' : '';

    var displayId;
    if (room.type === 'backstage') displayId = 'Backstage';
    else if (room.type === 'reception') displayId = 'Reception';
    else displayId = room.id.toUpperCase();

    html += '<div class="fac-room' + typeClass + spanClass + stateClass + '" data-room="' + room.id + '"' + inlineStyle + '>';
    html += '<div class="fac-room-id"' + (isHighlighted ? ' style="color:' + tx + '"' : '') + '>' + displayId + '</div>';
    html += '<div class="fac-room-label">' + room.label + '</div>';
    if (room.equip) html += '<div class="fac-room-equip">' + room.equip + '</div>';
    html += '</div>';
  });

  // Corridor
  html += '<div class="fac-corr-cell"></div>';
  html += '</div>';
  return html;
}

function buildMinimap102(color) {
  var bg = color.bg || '#EEF0FF';
  var bd = color.bd || '#55C';
  var tx = color.tx || '#339';
  var activeStyle = 'background:' + bg + ';border-color:' + bd + ';border-width:2px;box-shadow:0 1px 4px rgba(0,0,0,0.1)';
  var activeNum = 'color:' + tx;
  function cubicle(n) {
    return '<div class="lab102-cubicle lab102-active" style="' + activeStyle + '">'
      + '<span class="lab102-num" style="' + activeNum + '">' + n + '</span>'
      + '<span class="lab102-icon">🖥️</span></div>';
  }
  var html = '<div class="lab102-floor">';
  html += '<div class="lab102-door-area"><div class="lab102-door">⬅ ENTRANCE</div></div>';
  html += '<div class="lab102-body">';
  // Left Bank — 6 stations
  html += '<div class="lab102-col">';
  html += '<div class="lab102-col-label">Left Bank · 6 stations</div>';
  html += '<div class="lab102-row">' + cubicle(5) + cubicle(6) + '</div>';
  html += '<div class="lab102-row">' + cubicle(3) + cubicle(4) + '</div>';
  html += '<div class="lab102-row">' + cubicle(1) + cubicle(2) + '</div>';
  html += '</div>';
  // Aisle
  html += '<div class="lab102-aisle"><span>A<br>I<br>S<br>L<br>E</span></div>';
  // Right Bank — 10 stations
  html += '<div class="lab102-col">';
  html += '<div class="lab102-col-label">Right Bank · 10 stations</div>';
  html += '<div class="lab102-row">' + cubicle(15) + cubicle(16) + '</div>';
  html += '<div class="lab102-row">' + cubicle(13) + cubicle(14) + '</div>';
  html += '<div class="lab102-row">' + cubicle(11) + cubicle(12) + '</div>';
  html += '<div class="lab102-row">' + cubicle(9) + cubicle(10) + '</div>';
  html += '<div class="lab102-row">' + cubicle(7) + cubicle(8) + '</div>';
  html += '</div>';
  html += '</div>'; // close lab102-body
  html += '<div class="lab102-proctor-area"><div class="lab102-proctor">🖥️ Proctor / RA Desk</div></div>';
  html += '</div>'; // close lab102-floor
  return html;
}

// Get rooms for a researcher's study across all weeks
function getStudyRooms(researcherLastName) {
  var allRooms = {};
  Object.keys(facilityUsage).forEach(function(wk) {
    var usage = facilityUsage[wk];
    ['110','112'].forEach(function(suite) {
      (usage[suite] || []).forEach(function(entry) {
        if (entry.researcher === researcherLastName && entry.rooms) {
          entry.rooms.forEach(function(rid) { allRooms[rid] = true; });
        }
      });
    });
  });
  return Object.keys(allRooms).sort();
}

// #5: Get week-by-week room breakdown for a specific researcher + study date range + facility
function getStudyRoomBreakdown(researcherLastName, studyDateLabel, studyFormat, studyFacility) {
  if (studyFormat === 'Online' || !studyFacility) return [];
  var weekOrder = ['feb8','feb15','feb22','mar1','mar8','mar22','mar29','apr5','apr12','apr19','apr26'];
  var weekLabels = {feb8:'Feb 8–14',feb15:'Feb 15–21',feb22:'Feb 22–28',mar1:'Mar 1–7',mar8:'Mar 8–14',mar22:'Mar 22–28',mar29:'Mar 29–Apr 4',apr5:'Apr 5–11',apr12:'Apr 12–18',apr19:'Apr 19–25',apr26:'Apr 26–May 1'};
  var weekStarts = {feb8:'2026-02-08',feb15:'2026-02-15',feb22:'2026-02-22',mar1:'2026-03-01',mar8:'2026-03-08',mar22:'2026-03-22',mar29:'2026-03-29',apr5:'2026-04-05',apr12:'2026-04-12',apr19:'2026-04-19',apr26:'2026-04-26'};
  var weekEnds = {feb8:'2026-02-14',feb15:'2026-02-21',feb22:'2026-02-28',mar1:'2026-03-07',mar8:'2026-03-14',mar22:'2026-03-28',mar29:'2026-04-04',apr5:'2026-04-11',apr12:'2026-04-18',apr19:'2026-04-25',apr26:'2026-05-01'};

  // Parse study date range
  var dateParts = studyDateLabel.split('–');
  var studyStart = new Date(dateParts[0].trim() + ', 2026');
  var studyEnd = new Date((dateParts[1] || dateParts[0]).trim() + ', 2026');

  // Determine which suites to check based on facility
  var checkSuites = [];
  if (studyFacility.includes('110')) checkSuites.push('110');
  if (studyFacility.includes('112')) checkSuites.push('112');
  if (studyFacility.includes('102') || studyFacility === 'LL102') checkSuites.push('102');

  var result = [];
  weekOrder.forEach(function(wk) {
    var usage = facilityUsage[wk];
    if (!usage) return;
    var wkStart = new Date(weekStarts[wk]);
    var wkEnd = new Date(weekEnds[wk]);
    if (wkStart > studyEnd || wkEnd < studyStart) return;

    var weekRooms = [];
    checkSuites.forEach(function(suite) {
      if (suite === '102') {
        (usage['102'] || []).forEach(function(entry) {
          if (entry.researcher === researcherLastName) weekRooms.push('LL102');
        });
      } else {
        (usage[suite] || []).forEach(function(entry) {
          if (entry.researcher === researcherLastName && entry.rooms) {
            weekRooms = weekRooms.concat(entry.rooms);
          }
        });
      }
    });
    if (weekRooms.length > 0) {
      var roomStr = weekRooms.map(function(r) {
        if (r === 'LL102') return 'LL102';
        return r.split('-').pop().toUpperCase();
      }).join(', ');
      result.push({weekKey: wk, weekLabel: weekLabels[wk] || wk, rooms: weekRooms, roomStr: roomStr});
    }
  });
  return result;
}

function getResearcherLastName(fullName) {
  var comma = fullName.indexOf(',');
  if (comma > -1) return fullName.substring(0, comma).trim();
  return fullName.split(' ').pop();
}

function getTabFromHash() {
  var hash = window.location.hash.replace('#', '');
  // Support #study=StudyName deep links
  if (hash.startsWith('study=')) return 'studies';
  var validTabs = ['myschedule','studies','calendar','facilities'];
  return validTabs.includes(hash) ? hash : null;
}

function handleStudyDeepLink() {
  var hash = window.location.hash.replace('#', '');
  if (!hash.startsWith('study=')) return;
  var studyName = decodeURIComponent(hash.replace('study=', ''));
  // Set search input and filter
  var searchInput = document.getElementById('studies-search');
  if (searchInput) {
    searchInput.value = studyName;
    runStudiesFilter();
    // Scroll to and highlight the matching row
    setTimeout(function() {
      var rows = document.querySelectorAll('#studies-tbody tr:not(.filter-hidden)');
      if (rows.length > 0) {
        rows[0].scrollIntoView({behavior: 'smooth', block: 'center'});
        rows[0].style.transition = 'background 0.3s';
        rows[0].style.background = '#FFF3CD';
        setTimeout(function() { rows[0].style.background = ''; }, 2000);
      }
    }, 200);
  }
}

function switchTab(tabId, updateHash) {
  if (updateHash !== false) {
    try { history.replaceState(null, '', '#' + tabId); } catch(e) { /* sandboxed iframe */ }
  }
  document.querySelectorAll('.nav-tab').forEach(function(t) {
    t.classList.remove('active');
    t.setAttribute('aria-selected', 'false');
  });
  document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });

  var tab = document.querySelector('[data-tab="' + tabId + '"]');
  if (tab) { tab.classList.add('active'); tab.setAttribute('aria-selected', 'true'); }
  var section = document.getElementById(tabId);
  if (section) section.classList.add('active');

  // Carry researcher context from My Schedule to All Studies
  if (tabId === 'studies') {
    var activeResearcher = mySelect.value;
    if (activeResearcher && !researcherSelect.value) {
      researcherSelect.value = activeResearcher;
      researcherSelect.classList.add('has-selection');
    }
    runStudiesFilter();
  }

  // Auto-scroll to current week in Calendar
  if (tabId === 'calendar') {
    // Sync researcher selection to calendar filter
    var selectedResearcher = mySelect.value;
    var calFilter = document.getElementById('cal-researcher-filter');
    if (selectedResearcher && calFilter) {
      calFilter.value = selectedResearcher;
      calFilter.classList.toggle('has-selection', !!selectedResearcher);
    }
    applyCalResearcherFilter();
    setTimeout(function() {
      var currentRow = document.querySelector('#cal-body tr.current-week-row');
      if (currentRow) currentRow.scrollIntoView({behavior: 'smooth', block: 'center'});
    }, 100);
  } else {
    // Reset calendar opacity when leaving
    document.querySelectorAll('#cal-body tr').forEach(function(row) { row.style.opacity = '1'; });
  }
}

function toggleWeek(header) {
  var group = header.parentElement;
  group.classList.toggle('collapsed');
  var expanded = !group.classList.contains('collapsed');
  header.setAttribute('aria-expanded', expanded ? 'true' : 'false');
}

function highlightCurrentWeek() {
  document.querySelectorAll('.week-group[data-week-start]').forEach(function(group) {
    var start = group.dataset.weekStart;
    var end = group.dataset.weekEnd;
    if (TODAY >= start && TODAY <= end) {
      group.classList.add('current-week');
      var label = group.querySelector('.week-label');
      if (label && !label.querySelector('.badge-current-week')) {
        label.insertAdjacentHTML('afterend', ' <span class="badge-current-week">Current Week</span>');
      }
    }
  });
  document.querySelectorAll('#cal-body tr').forEach(function(row) {
    if (row.dataset && row.dataset.weekStart) {
      if (TODAY >= row.dataset.weekStart && TODAY <= row.dataset.weekEnd) {
        row.classList.add('current-week-row');
      }
    }
  });
}

// Credit allocation: cr × n per study
function parseCreditAllocation(cr, nStr) {
  var crVal = parseFloat(cr);
  nStr = (nStr || '').replace(/,/g, '');
  if (nStr.includes('–') || nStr.includes('-')) {
    var parts = nStr.split(/[–-]/);
    var lo = parseInt(parts[0]), hi = parseInt(parts[1]);
    if (!isNaN(lo) && !isNaN(hi)) return {low: Math.round(crVal * lo), high: Math.round(crVal * hi), label: (crVal * lo) + '–' + (crVal * hi)};
  }
  if (nStr.includes('+')) {
    var base = parseInt(nStr);
    if (!isNaN(base)) return {low: Math.round(crVal * base), high: null, label: (crVal * base) + '+'};
  }
  var n = parseInt(nStr);
  if (!isNaN(n)) return {low: Math.round(crVal * n), high: null, label: '' + Math.round(crVal * n)};
  return {low: 0, high: null, label: '—'};
}

function renderMySchedule() {
  var name = mySelect.value;
  if (!name) { myContent.style.display = 'none'; myEmpty.style.display = 'block'; return; }
  myEmpty.style.display = 'none';
  myContent.style.display = 'block';

  var studies = allStudies.filter(function(s) { return s.researcher === name || (s.coPIs && s.coPIs.indexOf(name) !== -1) || (s.stackedResearchers && s.stackedResearchers.indexOf(name) !== -1); }).sort(function(a,b) { return a.dateSort.localeCompare(b.dateSort); });
  var totalCredits = studies.reduce(function(sum, s) { return sum + parseFloat(s.cr); }, 0).toFixed(2);
  var totalAllocLow = 0, totalAllocHigh = 0, hasRange = false;
  studies.forEach(function(s) {
    var alloc = parseCreditAllocation(s.cr, s.n);
    totalAllocLow += alloc.low;
    if (alloc.high) { totalAllocHigh += alloc.high; hasRange = true; } else { totalAllocHigh += alloc.low; }
  });
  var totalAllocLabel = hasRange ? totalAllocLow.toLocaleString() + '–' + totalAllocHigh.toLocaleString() : totalAllocLow.toLocaleString();
  var onlineCount = studies.filter(function(s) { return s.format === 'Online'; }).length;
  var inpersonCount = studies.length - onlineCount;

  // --- #8: Credit split (earned vs upcoming) ---
  var earnedCredits = 0;
  var upcomingCredits = 0;
  studies.forEach(function(s) {
    var cr = parseFloat(s.cr);
    // For date-range studies, use end date; for weekly online, use week end
    var endDate = s.dateLabel;
    var isCompleted = false;
    if (s.dateLabel.includes('–') && s.format !== 'Online') {
      // In-person/hybrid: "Feb 10 – Mar 14" — parse end date
      var parts = s.dateLabel.split('–');
      var endStr = (parts[1] || parts[0]).trim() + ', 2026';
      isCompleted = new Date(endStr) < new Date(TODAY);
    } else {
      // Online: dateSort is the week start
      var weekEndDate = new Date(s.dateSort);
      weekEndDate.setDate(weekEndDate.getDate() + 6);
      isCompleted = weekEndDate < new Date(TODAY);
    }
    if (isCompleted) earnedCredits += cr;
    else upcomingCredits += cr;
  });
  earnedCredits = earnedCredits.toFixed(2);
  upcomingCredits = upcomingCredits.toFixed(2);

  var collabs = []; var collabSeen = {};
  studies.forEach(function(s) {
    if (s.collabs) s.collabs.forEach(function(c) { if (!collabSeen[c]) { collabSeen[c] = true; collabs.push(c); } });
  });

  // --- #6: Detect overlapping in-person/hybrid studies ---
  var overlaps = [];
  var inpersonStudies = studies.filter(function(s) { return s.format !== 'Online'; });
  for (var i = 0; i < inpersonStudies.length; i++) {
    for (var j = i + 1; j < inpersonStudies.length; j++) {
      var a = inpersonStudies[i];
      var b = inpersonStudies[j];
      // Parse date ranges
      var aParts = a.dateLabel.split('–');
      var bParts = b.dateLabel.split('–');
      var aStart = new Date(aParts[0].trim() + ', 2026');
      var aEnd = new Date((aParts[1] || aParts[0]).trim() + ', 2026');
      var bStart = new Date(bParts[0].trim() + ', 2026');
      var bEnd = new Date((bParts[1] || bParts[0]).trim() + ', 2026');
      if (aStart <= bEnd && bStart <= aEnd) {
        overlaps.push({a: a, b: b});
      }
    }
  }

  var html = '';

  // --- #3: This Week Summary ---
  var currentWeekData = null;
  var currentWeekFacKey = null;
  for (var ci = 0; ci < calData.length; ci++) {
    if (TODAY >= calData[ci].weekStart && TODAY <= calData[ci].weekEnd) {
      currentWeekData = calData[ci];
      currentWeekFacKey = calWeekToFacKey(calData[ci].wk);
      break;
    }
  }
  if (currentWeekData) {
    var thisWeekStudies = [];
    var lastName = getResearcherLastName(name);
    // Check online studies for this week
    studies.forEach(function(s) {
      if (s.format === 'Online') {
        if (s.dateSort >= currentWeekData.weekStart && s.dateSort <= currentWeekData.weekEnd) {
          thisWeekStudies.push({study: s.study, format: 'online', detail: s.dur + ' · ' + s.cr + ' CR', rooms: null});
        }
      } else {
        // In-person: check if study date range overlaps current week
        var parts = s.dateLabel.split('–');
        var sStart = new Date(parts[0].trim() + ', 2026');
        var sEnd = new Date((parts[1] || parts[0]).trim() + ', 2026');
        var wStart = new Date(currentWeekData.weekStart);
        var wEnd = new Date(currentWeekData.weekEnd);
        if (sStart <= wEnd && wStart <= sEnd) {
          // Get rooms for this specific week
          var weekUsage = facilityUsage[currentWeekFacKey] || {};
          var weekRooms = [];
          ['110','112','102'].forEach(function(suite) {
            (weekUsage[suite] || []).forEach(function(entry) {
              if (entry.researcher === lastName) {
                if (entry.rooms) weekRooms = weekRooms.concat(entry.rooms.map(getRoomLabel));
                else if (suite === '102') weekRooms.push('LL102');
              }
            });
          });
          var fmtClass = s.format === 'In-Person' ? 'inperson' : 'hybrid';
          thisWeekStudies.push({study: s.study, format: fmtClass, detail: s.dur + ' · ' + s.facility, rooms: weekRooms.length ? weekRooms.join(', ') : null});
        }
      }
    });

    var twbClass = thisWeekStudies.length === 0 ? ' twb-empty' : '';
    html += '<div class="this-week-banner' + twbClass + '">';
    html += '<div class="this-week-banner-header"><span class="twb-icon">📌</span> This Week <span class="twb-dates">' + currentWeekData.dates + '</span>';
    if (thisWeekStudies.length === 0) {
      html += ' · <span class="this-week-empty">No active studies</span>';
      html += '</div></div>';
    } else {
      html += '</div>';
      html += '<div class="this-week-items">';
      thisWeekStudies.forEach(function(ts) {
        html += '<div class="this-week-item"><span class="twi-dot ' + ts.format + '"></span>';
        html += '<span class="twi-name">' + ts.study + '</span>';
        html += '<span class="twi-meta">' + ts.detail + '</span>';
        if (ts.rooms) html += '<span class="twi-rooms">Rooms: ' + ts.rooms + '</span>';
        html += '</div>';
      });
      html += '</div></div>';
    }
  }

  // --- Researcher card ---
  html += '<div class="researcher-card"><div class="researcher-card-header">';
  html += '<div class="rc-header-top"><span class="rc-name">' + name + '</span><div class="rc-meta">';
  html += '<span>' + studies.length + ' ' + (studies.length === 1 ? 'study' : 'studies') + '</span>';
  html += '<span>' + totalCredits + ' CR</span>';
  html += '<span>' + totalAllocLabel + ' credits alloc.</span>';
  html += '</div></div>';
  // Earned / upcoming sub-row
  html += '<div class="rc-credit-row">';
  html += '<span>✓ ' + earnedCredits + ' earned</span>';
  html += '<span>◷ ' + upcomingCredits + ' upcoming</span>';
  html += '</div>';
  html += '</div>';

  // #6: Overlap warning
  if (overlaps.length > 0) {
    var overlapSeen = {};
    html += '<div class="rc-conflicts"><span class="rc-conflict-icon">⚠️</span><div>';
    html += '<strong>Schedule overlaps:</strong> ';
    var overlapStrs = [];
    overlaps.forEach(function(o) {
      var key = [o.a.study, o.b.study].sort().join('|');
      if (overlapSeen[key]) return;
      overlapSeen[key] = true;
      overlapStrs.push('<strong>' + o.a.study + '</strong> overlaps with <strong>' + o.b.study + '</strong>');
    });
    html += overlapStrs.join(' · ');
    html += '</div></div>';
  }

  if (collabs.length) html += '<div class="rc-collabs"><strong>Collaborators:</strong> ' + collabs.join(', ') + '</div>';
  html += '<div class="rc-timeline">';

  // Group studies by week
  var weekGroups = [];
  var currentGroup = null;
  studies.forEach(function(s) {
    var weekKey = s.dateSort;
    if (!currentGroup || currentGroup.weekKey !== weekKey) {
      currentGroup = {weekKey: weekKey, dateLabel: s.dateLabel, studies: []};
      weekGroups.push(currentGroup);
    }
    currentGroup.studies.push(s);
  });

  // Find matching calData for each week group (for date ranges)
  weekGroups.forEach(function(wg) {
    for (var ci = 0; ci < calData.length; ci++) {
      if (wg.weekKey >= calData[ci].weekStart && wg.weekKey <= calData[ci].weekEnd) {
        wg.calDates = calData[ci].dates;
        wg.calWk = calData[ci].wk;
        break;
      }
    }
    // Determine week status
    var weekEnd = new Date(wg.weekKey);
    weekEnd.setDate(weekEnd.getDate() + 6);
    if (weekEnd < new Date(TODAY)) wg.status = 'past';
    else if (wg.weekKey <= TODAY && weekEnd.toISOString().split('T')[0] >= TODAY) wg.status = 'current';
    else wg.status = 'upcoming';

    // Sum credits for this week
    wg.totalCr = wg.studies.reduce(function(sum, s) { return sum + parseFloat(s.cr); }, 0);
  });

  var insertedNow = false;
  weekGroups.forEach(function(wg) {
    // Insert "Today" marker between past and current/upcoming
    if (!insertedNow && (wg.status === 'current' || wg.status === 'upcoming')) {
      insertedNow = true;
    }

    var weekCls = 'rc-week-group';
    if (wg.status === 'past') weekCls += ' rc-week-past';
    if (wg.status === 'current') weekCls += ' rc-week-current';
    html += '<div class="' + weekCls + '">';

    // Week header — show just date range, not redundant "Week of X" + dates
    var weekTitle = wg.calDates || wg.dateLabel;
    html += '<div class="rc-week-header">';
    html += '<div class="rc-week-header-left">';
    html += '<span class="rc-week-title">' + weekTitle + '</span>';
    html += '</div>';
    html += '<div class="rc-week-header-right">';
    html += '<span class="rc-week-stat"><strong>' + wg.studies.length + '</strong> ' + (wg.studies.length === 1 ? 'study' : 'studies') + '</span>';
    html += '<span class="rc-week-stat"><strong>' + wg.totalCr.toFixed(2) + '</strong> CR</span>';
    html += '</div>';
    html += '</div>';

    // Studies in this week
    wg.studies.forEach(function(s) {
    var formatClass = s.format === 'Online' ? 'badge-online' : s.format === 'In-Person' ? 'badge-inperson' : 'badge-hybrid';
    
    var deepStudy = s.study.replace(/'/g, "\\'");
    // Don't repeat the week date if it matches the group header — show date range only for multi-week in-person/hybrid studies
    var showDate = '';
    if (s.format === 'Online') {
      showDate = '<span style="font-size:11px;color:var(--text-muted);font-weight:400">Online</span>';
    } else if (s.dateLabel.includes('–')) {
      showDate = '<span style="font-size:11px">' + s.dateLabel + '</span>';
    }
    html += '<div class="rc-study"><div class="rc-date">' + showDate;
    if (s.facility) html += '<div class="rc-date-sub">' + s.facility + '</div>';
    var sonaLink = s.link ? ' <a href="' + s.link + '" target="_blank" rel="noopener" class="study-sona-link" title="Open in SONA">SONA ↗</a>' : '';
    html += '</div><div class="rc-study-info"><div class="rc-study-name"><a href="#" class="rc-study-link" data-tab="studies" data-study="' + deepStudy + '" title="View in All Studies tab">' + s.study + '</a>' + sonaLink;
    if (s.tag) html += ' <span class="badge-2part">' + s.tag + '</span>';
    if (s.isStackedSession) html += ' <span class="badge-stacked">📦 Pilot</span>';
    else if (s.stacked) html += ' <span class="badge-in-stacked">In Stacked Session</span>';
    if (s.stackable === true && !s.stacked) html += ' <span class="badge-stackable">Stackable</span>';
    if (s.stackable === 'maybe' && !s.stacked) html += ' <span class="badge-stackable-maybe">Stackable?</span>';
    var studyAlloc = parseCreditAllocation(s.cr, s.n);
    var nLabel = s.n + ' N';
    if (s.completed != null) {
      var pctDone = Math.round(s.completed / parseInt(s.n) * 100);
      nLabel = s.completed + '/' + s.n + ' N (' + pctDone + '%)';
    }
    html += '</div><div class="rc-study-detail">' + nLabel + ' · ' + s.dur + ' · <span class="rc-alloc">' + studyAlloc.label + ' credits</span>';
    // Show collaboration context — always show co-PIs
    if (s.coPIs && s.coPIs.length) {
      if (s.researcher === name) {
        html += ' · <span style="color:var(--cardinal);font-weight:500">with ' + s.coPIs.join(', ') + '</span>';
      } else if (s.coPIs.indexOf(name) !== -1) {
        // Viewing as co-PI: show primary + other co-PIs
        var others = s.coPIs.filter(function(c) { return c !== name; });
        var withNames = [s.researcher].concat(others);
        html += ' · <span style="color:var(--cardinal);font-weight:500">with ' + withNames.join(', ') + '</span>';
      } else {
        html += ' · <span style="color:var(--cardinal);font-weight:500">with ' + s.coPIs.join(', ') + '</span>';
      }
    }
    if (s.isStackedSession && s.stackedResearchers) {
      html += ' · <span style="color:var(--cardinal);font-weight:500">' + s.stackedResearchers.join(', ') + '</span>';
    }
    if (s.notes) html += ' · ' + s.notes;
    if (s.irb) html += ' · <span style="color:var(--text-muted)">IRB #' + s.irb + '</span>';
    if (s.facility) {
      var sLastName = getResearcherLastName(s.researcher);
      var rooms = getStudyRooms(sLastName);
      var rColor = RC[sLastName] || {bg:'#FFF5F5', bd:'#D44', tx:'#A22'};
      var facilities = s.facility.split(' + ').map(function(f) { return f.trim(); });
      var hasMultiple = facilities.length > 1 || (facilities[0] !== 'LL102' && rooms.some(function(r) { return r.startsWith('110'); }) && rooms.some(function(r) { return r.startsWith('112'); }));

      // --- #5: Week-by-week room breakdown ---
      var roomBreakdown = getStudyRoomBreakdown(sLastName, s.dateLabel, s.format, s.facility);
      var breakdownHtml = '';
      if (roomBreakdown.length > 1) {
        var hasChanges = false;
        for (var ri = 1; ri < roomBreakdown.length; ri++) {
          if (roomBreakdown[ri].roomStr !== roomBreakdown[ri-1].roomStr) { hasChanges = true; break; }
        }
        if (hasChanges) {
          breakdownHtml = '<details class="rc-room-breakdown"><summary>Room assignments change by week ▾</summary>';
          var prevRoomStr = '';
          roomBreakdown.forEach(function(rb) {
            var changeNote = (prevRoomStr && rb.roomStr !== prevRoomStr) ? ' <span class="rc-rw-change">← changed</span>' : '';
            breakdownHtml += '<div class="rc-room-week"><span class="rc-rw-label">' + rb.weekLabel + '</span><span class="rc-rw-rooms">' + rb.roomStr + changeNote + '</span></div>';
            prevRoomStr = rb.roomStr;
          });
          breakdownHtml += '</details>';
        }
      }

      if (hasMultiple) {
        html += '</div>' + breakdownHtml + '<div class="rc-minimap-multi">';
      } else {
        html += '</div>' + breakdownHtml;
      }

      facilities.forEach(function(fac) {
        if (fac === 'LL102') {
          html += '<div class="rc-minimap rc-minimap-102">';
          html += '<div class="rc-minimap-header"><span class="rc-minimap-title">LL102 Computer Lab</span><span class="rc-minimap-sub">16 Stations · Proctored Studies · Stacked Sessions</span></div>';
          html += buildMinimap102(rColor);
          html += '</div>';
        } else if (fac === 'LL-112' || fac.includes('112')) {
          var rooms112 = rooms.filter(function(r) { return r.startsWith('112'); });
          html += '<div class="rc-minimap rc-minimap-suite rc-minimap-112">';
          html += '<div class="rc-minimap-header"><span class="rc-minimap-title">LL-112 Suite</span><span class="rc-minimap-sub">Audio/Video Recording · NOLDUS</span></div>';
          html += buildMinimap('112', rooms112, rColor);
          html += '</div>';
        } else if (fac === 'LL-110' || fac.includes('110')) {
          var rooms110 = rooms.filter(function(r) { return r.startsWith('110'); });
          html += '<div class="rc-minimap rc-minimap-suite rc-minimap-110">';
          html += '<div class="rc-minimap-header"><span class="rc-minimap-title">LL-110 Suite</span><span class="rc-minimap-sub">Eye-Tracking · TOBII · BIOPAC</span></div>';
          html += buildMinimap('110', rooms110, rColor);
          html += '</div>';
        }
      });

      if (hasMultiple) html += '</div>';
    } else {
      html += '</div>'; // close rc-study-detail for online studies
    }
    html += '</div><div class="rc-badges"><span class="badge ' + formatClass + '">' + s.format + '</span>';
    html += '<span class="badge-cr">' + s.cr + '</span></div></div>';
    }); // end studies in week

    html += '</div>'; // close rc-week-group
  }); // end weekGroups
  html += '</div></div>';
  myContent.innerHTML = html;
}

// ═══════════════════════════════════════════════
// ALL STUDIES: Build table, filter, view toggle
// ═══════════════════════════════════════════════
var activeFormat = 'all';

function buildStudiesTable() {
  var tbody = document.getElementById('studies-tbody');
  // Sort: by dateSort, then by researcher
  var sorted = allStudies.slice().sort(function(a, b) {
    var d = a.dateSort.localeCompare(b.dateSort);
    return d !== 0 ? d : a.researcher.localeCompare(b.researcher);
  });

  var html = '';
  sorted.forEach(function(s) {
    var formatClass = s.format === 'Online' ? 'badge-online' : s.format === 'In-Person' ? 'badge-inperson' : 'badge-hybrid';

    // Status: past / current / upcoming
    var rowClass = 'study-row-data';
    var statusDot = '';
    if (s.format === 'Online') {
      var weekEnd = new Date(s.dateSort);
      weekEnd.setDate(weekEnd.getDate() + 6);
      if (weekEnd < new Date(TODAY)) { rowClass += ' study-past'; statusDot = '<span class="status-dot ended"></span>'; }
      else if (s.dateSort <= TODAY && weekEnd.toISOString().split('T')[0] >= TODAY) { rowClass += ' study-current'; statusDot = '<span class="status-dot active"></span>'; }
      else { statusDot = '<span class="status-dot upcoming"></span>'; }
    } else {
      var parts = s.dateLabel.split('–');
      if (parts.length === 2) {
        var endStr = parts[1].trim() + ', 2026';
        var startStr = parts[0].trim() + ', 2026';
        var startD = new Date(startStr), endD = new Date(endStr);
        if (endD < new Date(TODAY)) { rowClass += ' study-past'; statusDot = '<span class="status-dot ended"></span>'; }
        else if (startD <= new Date(TODAY) && endD >= new Date(TODAY)) { rowClass += ' study-current'; statusDot = '<span class="status-dot active"></span>'; }
        else { statusDot = '<span class="status-dot upcoming"></span>'; }
      }
    }

    // Badges
    var badges = '';
    if (s.tag) badges += ' <span class="badge-2part">' + s.tag + '</span>';
    if (s.isStackedSession) badges += ' <span class="badge-stacked">📦 Pilot</span>';
    else if (s.stacked) badges += ' <span class="badge-in-stacked">In Stacked Session</span>';
    if (s.stackable === true && !s.stacked) badges += ' <span class="badge-stackable">Stackable</span>';
    if (s.stackable === 'maybe' && !s.stacked) badges += ' <span class="badge-stackable-maybe">Stackable?</span>';

    // Credit allocation
    var alloc = parseCreditAllocation(s.cr, s.n);

    // Details column: facility + notes + collabs
    var details = [];
    if (s.facility) details.push(s.facility);
    if (s.notes) details.push(s.notes);
    if (s.irb) details.push('IRB #' + s.irb);

    var collabAttr = s.coPIs ? ' data-collabs="' + s.coPIs.join(',') + '"' : '';
    var stackedAttr = s.stackedResearchers ? ' data-stacked-researchers="' + s.stackedResearchers.join(',') + '"' : '';
    var allWithNames = [];
    if (s.coPIs && s.coPIs.length) allWithNames = allWithNames.concat(s.coPIs);
    if (s.collabs && s.collabs.length) allWithNames = allWithNames.concat(s.collabs);
    var collabDisplay = allWithNames.length ? '<div style="font-size:11px;font-weight:400;color:var(--text-muted);margin-top:1px">with ' + allWithNames.join(', ') + '</div>' : '';
    if (s.isStackedSession) {
      collabDisplay = '<div style="font-size:11px;font-weight:400;color:var(--text-muted);margin-top:1px">' + s.stackedResearchers.join(', ') + '</div>';
    }

    if (s.isStackedSession) rowClass += ' study-stacked-session';

    html += '<tr class="' + rowClass + '" data-format="' + s.format + '" data-researcher="' + s.researcher + '"' + collabAttr + stackedAttr + '>';
    html += '<td>' + statusDot + '<strong>' + s.researcher + '</strong>' + collabDisplay + '</td>';
    var studyNameHtml = s.study;
    if (s.link) studyNameHtml += ' <a href="' + s.link + '" target="_blank" rel="noopener" class="study-sona-link" title="Open in SONA">SONA ↗</a>';
    html += '<td class="study-name-col">' + studyNameHtml + (badges ? '<div class="study-badges">' + badges + '</div>' : '') + '</td>';
    html += '<td>' + s.dateLabel + '</td>';
    html += '<td><span class="badge ' + formatClass + '">' + s.format + '</span></td>';
    var nDisplay = s.n;
    if (s.completed != null) {
      var pctDone = Math.round(s.completed / parseInt(s.n) * 100);
      nDisplay = '<span title="' + s.completed + ' of ' + s.n + ' completed">' + s.completed + '/' + s.n + '</span>'
        + '<div class="n-progress"><div class="n-progress-bar" style="width:' + Math.min(pctDone, 100) + '%"></div></div>'
        + '<span class="n-progress-label">' + pctDone + '%</span>';
    }
    html += '<td>' + nDisplay + '</td>';
    html += '<td>' + s.dur + '</td>';
    html += '<td><span class="badge-cr">' + s.cr + '</span> <span class="study-facility">(' + alloc.label + ')</span></td>';
    html += '<td class="study-notes-cell">' + (details.length ? details.join(' · ') : '—') + '</td>';
    html += '</tr>';
  });

  tbody.innerHTML = html;
}

function runStudiesFilter() {
  var researcher = researcherSelect.value;
  var searchQuery = (document.getElementById('studies-search').value || '').toLowerCase().trim();
  var rows = document.querySelectorAll('#studies-tbody tr');
  var total = 0, visible = 0;

  function matchesResearcher(row) {
    if (!researcher) return true;
    if (row.dataset.researcher === researcher) return true;
    if (row.dataset.collabs && row.dataset.collabs.split(',').indexOf(researcher) !== -1) return true;
    if (row.dataset.stackedResearchers && row.dataset.stackedResearchers.split(',').indexOf(researcher) !== -1) return true;
    return false;
  }

  function matchesSearch(row) {
    if (!searchQuery) return true;
    return row.textContent.toLowerCase().indexOf(searchQuery) !== -1;
  }

  // Clear previous highlights
  document.querySelectorAll('#studies-tbody mark').forEach(function(m) {
    var parent = m.parentNode;
    parent.replaceChild(document.createTextNode(m.textContent), m);
    parent.normalize();
  });

  rows.forEach(function(row) {
    var matchFormat = activeFormat === 'all' || row.dataset.format === activeFormat;
    var show = matchFormat && matchesResearcher(row) && matchesSearch(row);
    row.classList.toggle('filter-hidden', !show);
    total++;
    if (show) visible++;

    // Apply search highlighting to visible rows
    if (show && searchQuery && searchQuery.length >= 2) {
      highlightTextInRow(row, searchQuery);
    }
  });

  // Update chip counts based on researcher filter + search
  var counts = {all: 0, Online: 0, 'In-Person': 0, Hybrid: 0};
  rows.forEach(function(row) {
    if (matchesResearcher(row) && matchesSearch(row)) {
      counts.all++;
      counts[row.dataset.format]++;
    }
  });
  document.getElementById('chip-all').textContent = counts.all;
  document.getElementById('chip-online').textContent = counts.Online;
  document.getElementById('chip-inperson').textContent = counts['In-Person'];
  document.getElementById('chip-hybrid').textContent = counts.Hybrid;

  // Result count
  var hasFilter = researcher || activeFormat !== 'all' || searchQuery;
  filterCountEl.textContent = hasFilter ? 'Showing ' + visible + ' of ' + total + ' studies' : '';

  // No results
  var noResults = document.getElementById('studies-no-results');
  noResults.style.display = (hasFilter && visible === 0) ? 'block' : 'none';

  // Also filter calendar rows
  document.querySelectorAll('#cal-body tr').forEach(function(row) {
    var text = row.textContent.toLowerCase();
    row.classList.toggle('filter-hidden', researcher && !text.includes(researcher.toLowerCase()));
  });
}

// Search highlight helper: walks text nodes in a row and wraps matches in <mark>
function highlightTextInRow(row, query) {
  var cells = row.querySelectorAll('td');
  cells.forEach(function(cell) {
    var walker = document.createTreeWalker(cell, NodeFilter.SHOW_TEXT, null, false);
    var nodesToHighlight = [];
    while (walker.nextNode()) {
      var node = walker.currentNode;
      var idx = node.textContent.toLowerCase().indexOf(query);
      if (idx !== -1 && node.parentNode.tagName !== 'MARK') {
        nodesToHighlight.push({node: node, idx: idx});
      }
    }
    // Process in reverse to avoid invalidating indices
    for (var i = nodesToHighlight.length - 1; i >= 0; i--) {
      var info = nodesToHighlight[i];
      var textNode = info.node;
      var before = textNode.textContent.substring(0, info.idx);
      var match = textNode.textContent.substring(info.idx, info.idx + query.length);
      var after = textNode.textContent.substring(info.idx + query.length);
      var parent = textNode.parentNode;
      var frag = document.createDocumentFragment();
      if (before) frag.appendChild(document.createTextNode(before));
      var mark = document.createElement('mark');
      mark.textContent = match;
      frag.appendChild(mark);
      if (after) frag.appendChild(document.createTextNode(after));
      parent.replaceChild(frag, textNode);
    }
  });
}

// Alias for backward compat
function runFilter() { runStudiesFilter(); }

function renderFacilities() {
  var wk = facWeekSelect.value;

  document.querySelectorAll('.fac-room').forEach(function(room) {
    room.classList.remove('fac-active');
    room.style.background = ''; room.style.borderColor = ''; room.style.borderWidth = '';
    room.style.borderLeftWidth = ''; room.style.borderLeftColor = '';
    room.removeAttribute('tabindex');
    var studyEl = room.querySelector('.fac-room-study');
    if (studyEl) { studyEl.innerHTML = ''; studyEl.style.display = 'none'; studyEl.style.color = ''; }
    var idEl = room.querySelector('.fac-room-id');
    if (idEl) idEl.style.color = '';
    var tipEl = room.querySelector('.fac-room-tooltip');
    if (tipEl) tipEl.innerHTML = '';
  });

  ['110','112','102'].forEach(function(s) {
    var el = document.getElementById('fac-' + s + '-status');
    el.innerHTML = ''; el.className = 'fac-suite-status';
    el.style.padding = ''; el.style.minHeight = '';
  });

  document.querySelectorAll('.lab102-cubicle').forEach(function(c) {
    c.classList.remove('lab102-active','lab102-multi');
    c.style.background = ''; c.style.borderColor = '';
  });

  document.getElementById('fac-112-mobile').innerHTML = '';
  document.getElementById('fac-110-mobile').innerHTML = '';
  updateFacLegend(wk);

  if (!wk || !facilityUsage[wk]) return;
  var usage = facilityUsage[wk];

  ['110','112'].forEach(function(suite) {
    var studies = usage[suite] || [];
    if (studies.length === 0) return;

    var statusEl = document.getElementById('fac-' + suite + '-status');
    statusEl.innerHTML = studies.map(function(s) {
      var c = RC[s.researcher] || {bd:'#990000',tx:'#333'};
      var line = '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:' + c.bd + ';margin-right:6px;vertical-align:middle"></span><strong>' + s.researcher + '</strong>: ' + s.study;
      if (s.badge === 'start') line += ' <span class="badge-start">Start</span>';
      if (s.badge === 'end') line += ' <span class="badge-end">End</span>';
      return line;
    }).join('<br>');
    statusEl.className = 'fac-suite-status has-study';

    var roomMap = {};
    studies.forEach(function(s) { if (s.rooms) s.rooms.forEach(function(rid) { if (!roomMap[rid]) roomMap[rid] = []; roomMap[rid].push(s); }); });

    var mobileEl = document.getElementById('fac-' + suite + '-mobile');
    var mobileHtml = '';

    Object.keys(roomMap).forEach(function(rid) {
      var room = document.querySelector('[data-room="' + rid + '"]');
      if (!room) return;
      var primary = roomMap[rid][0];
      var c = RC[primary.researcher] || {bg:'#FFF5F5',bd:'#990000',tx:'#990000'};

      room.classList.add('fac-active');
      room.setAttribute('tabindex', '0');
      room.style.background = c.bg; room.style.borderColor = c.bd;
      room.style.borderWidth = '2px'; room.style.borderLeftWidth = '4px'; room.style.borderLeftColor = c.bd;

      var idEl = room.querySelector('.fac-room-id');
      if (idEl) idEl.style.color = c.tx;

      var studyEl = room.querySelector('.fac-room-study');
      if (studyEl) {
        studyEl.style.color = c.tx;
        studyEl.innerHTML = roomMap[rid].map(function(s) { return '<strong>' + s.study + '</strong><div class="fac-study-researcher">' + s.researcher + '</div>'; }).join('');
        studyEl.style.display = 'block';
      }

      var tipEl = room.querySelector('.fac-room-tooltip');
      if (tipEl) {
        var roomLabel = room.querySelector('.fac-room-label');
        var roomEquip = room.querySelector('.fac-room-equip');
        tipEl.innerHTML = roomMap[rid].map(function(s) {
          return '<div style="margin-bottom:4px"><strong style="color:' + (RC[s.researcher]||{bd:'#fff'}).bd + '">' + s.researcher + '</strong><br>' + s.study + (s.badge ? ' (' + s.badge + ')' : '') + '</div>';
        }).join('') + '<div style="font-size:10px;opacity:0.7;margin-top:4px">' + (roomLabel ? roomLabel.textContent : '') + (roomEquip ? ' · ' + roomEquip.textContent : '') + '</div>';
      }

      mobileHtml += '<div class="fac-mobile-room" style="border-left:3px solid ' + c.bd + '"><div class="fac-mobile-room-id" style="color:' + c.tx + '">' + rid.toUpperCase().replace('-',' ') + '</div>';
      mobileHtml += roomMap[rid].map(function(s) { return '<div class="fac-mobile-room-study">' + s.researcher + ': ' + s.study + '</div>'; }).join('') + '</div>';
    });
    mobileEl.innerHTML = mobileHtml;
  });

  var studies102 = usage['102'] || [];
  if (studies102.length > 0) {
    var statusEl102 = document.getElementById('fac-102-status');
    statusEl102.innerHTML = studies102.map(function(s) {
      var c = RC[s.researcher] || {bd:'#990000',tx:'#333'};
      var line = '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:' + c.bd + ';margin-right:6px;vertical-align:middle"></span><strong>' + s.researcher + '</strong>: ' + s.study;
      if (s.badge === 'start') line += ' <span class="badge-start">Start</span>';
      if (s.badge === 'end') line += ' <span class="badge-end">End</span>';
      return line;
    }).join('<br>');
    statusEl102.className = 'fac-suite-status has-study';

    var cubicles = document.querySelectorAll('.lab102-cubicle');
    if (studies102.length === 1) {
      var clr = RC[studies102[0].researcher] || {bg:'#FFF5F5',bd:'#990000'};
      cubicles.forEach(function(c) { c.classList.add('lab102-active'); c.style.background = clr.bg; c.style.borderColor = clr.bd; });
    } else {
      var c1 = RC[studies102[0].researcher] || {bg:'#FFF5F5',bd:'#990000'};
      var c2 = RC[studies102[1].researcher] || {bg:'#FFF5F5',bd:'#990000'};
      cubicles.forEach(function(c, idx) {
        c.classList.add('lab102-active');
        if (idx % 2 === 0) { c.style.background = c1.bg; c.style.borderColor = c1.bd; }
        else { c.style.background = c2.bg; c.style.borderColor = c2.bd; }
      });
    }
  }

  var s110 = document.getElementById('fac-110-status');
  var s112 = document.getElementById('fac-112-status');
  // Ensure both status bars have matching padding so grids align
  var s110HasStudy = s110.classList.contains('has-study');
  var s112HasStudy = s112.classList.contains('has-study');
  if (s110HasStudy !== s112HasStudy) {
    var emptyBar = s110HasStudy ? s112 : s110;
    emptyBar.style.padding = '10px 18px';
    emptyBar.style.boxSizing = 'border-box';
  }
  s110.style.minHeight = ''; s112.style.minHeight = '';
  var maxH = Math.max(s110.offsetHeight, s112.offsetHeight);
  s110.style.minHeight = maxH + 'px'; s112.style.minHeight = maxH + 'px';

  var grid112 = document.querySelector('.fac-grid-112');
  var grid110 = document.querySelector('.fac-grid-110');
  if (grid112 && grid110) {
    grid112.style.gridTemplateRows = ''; grid110.style.gridTemplateRows = '';
    // Force layout recalc before measuring
    void grid112.offsetHeight;
    var rowHeights = [];
    for (var r = 1; r <= 6; r++) {
      var maxRow = 80;
      [grid112, grid110].forEach(function(grid) {
        grid.querySelectorAll('.fac-room, .fac-backstage, .fac-reception').forEach(function(el) {
          var cs = window.getComputedStyle(el);
          var rowStart = parseInt(cs.gridRowStart);
          var rowEnd = cs.gridRowEnd === 'auto' ? rowStart + 1 : parseInt(cs.gridRowEnd);
          if (isNaN(rowEnd)) rowEnd = rowStart + 1;
          if (rowStart === r && (rowEnd - rowStart) === 1) {
            var h = Math.max(el.offsetHeight, el.scrollHeight) + 8;
            maxRow = Math.max(maxRow, h);
          }
        });
      });
      rowHeights.push(maxRow);
    }
    var rowStr = rowHeights.map(function(h) { return 'minmax(' + h + 'px, max-content)'; }).join(' ');
    grid112.style.gridTemplateRows = rowStr; grid110.style.gridTemplateRows = rowStr;
  }
}

function updateFacLegend(wk) {
  var legendEl = document.getElementById('fac-legend');
  if (!wk || !facilityUsage[wk]) {
    legendEl.innerHTML = '<span style="color:var(--text-muted);font-size:12px">Select a week to see active researchers</span>';
    return;
  }
  var usage = facilityUsage[wk];
  var activeResearchers = {};
  ['110','112','102'].forEach(function(suite) {
    (usage[suite] || []).forEach(function(s) {
      if (!activeResearchers[s.researcher]) activeResearchers[s.researcher] = RC[s.researcher] || {bd:'#990000'};
    });
  });
  legendEl.innerHTML = Object.keys(activeResearchers).map(function(name) {
    return '<span class="fac-legend-item"><span class="fac-dot" style="background:' + activeResearchers[name].bd + '"></span>' + name + '</span>';
  }).join('');
}

// ═══════════════════════════════════════════════
// 4. BUILD DROPDOWNS & RENDER CALENDAR
// ═══════════════════════════════════════════════
var researcherNames = []; var seen = {};
allStudies.forEach(function(s) {
  if (s.isStackedSession) return; // skip stacked session pseudo-researcher
  if (!seen[s.researcher]) { seen[s.researcher] = true; researcherNames.push(s.researcher); }
  if (s.coPIs) { s.coPIs.forEach(function(c) { if (!seen[c]) { seen[c] = true; researcherNames.push(c); } }); }
});
researcherNames.sort(function(a,b) {
  return (a.split(',')[0] || a.split(' ').pop()).localeCompare(b.split(',')[0] || b.split(' ').pop());
});
researcherNames.forEach(function(name) {
  var o1 = document.createElement('option'); o1.value = name; o1.textContent = name; mySelect.appendChild(o1);
  var o2 = document.createElement('option'); o2.value = name; o2.textContent = name; researcherSelect.appendChild(o2);
});

// Build study dropdown (filter bar + my schedule picker)
var studyNames = []; var seenStudy = {}; var studyToResearcher = {};
allStudies.forEach(function(s) {
  if (!seenStudy[s.study]) {
    seenStudy[s.study] = true;
    studyNames.push({name: s.study, researcher: s.researcher, format: s.format});
    studyToResearcher[s.study] = s.researcher;
  }
});
studyNames.sort(function(a,b) { return a.name.localeCompare(b.name); });
studyNames.forEach(function(s) {
  var o2 = document.createElement('option');
  o2.value = s.name;
  o2.textContent = s.name;
  myStudySelect.appendChild(o2);
});

// Render calendar table
// Helper: map calData week key to facilityUsage key
function calWeekToFacKey(wk) {
  return wk.toLowerCase().replace(/\s+/g, '').replace('feb','feb').replace('mar','mar').replace('apr','apr');
}
function getRoomLabel(rid) { return rid.split('-').pop().toUpperCase(); }

// ═══ Shared Stacked Session Bar Builder ═══
var STACKED_PILOT = {
  title: 'Stacked Lab Session — Week of Mar 1',
  subtitle: 'Pilot · LL102 · 16 stations · Online option TBD',
  cap: 60,
  studies: [
    {name:'TED Judges', researcher:'Berry, Zachariah', dur:5, color:'#16A34A', status:'confirmed'},
    {name:'Sammy Dissertation Study 1', researcher:'Wiltermuth, Scott', dur:15, color:'#D97706', status:'maybe'},
    {name:'Thinking About Others', researcher:'Wakslak, Cheryl', dur:10, color:'#6366F1', status:'maybe'}
  ]
};
STACKED_PILOT.totalDur = STACKED_PILOT.studies.reduce(function(s,x){return s+x.dur;},0);
STACKED_PILOT.totalCr = STACKED_PILOT.studies.reduce(function(s,x){return s+parseFloat(x.dur>=15?0.25:0.25);},0);

function buildStackedBarHTML(opts) {
  // opts: {compact:bool} — compact mode for calendar cells
  var p = STACKED_PILOT;
  var compact = opts && opts.compact;
  var barH = compact ? 28 : 38;
  var html = '';

  // Session bar
  html += '<div class="stack-bar-area">';
  html += '<div class="stack-bar" style="height:'+barH+'px">';
  p.studies.forEach(function(s, i) {
    var pct = (s.dur / p.cap * 100).toFixed(1);
    html += '<div class="stack-block stack-block-' + (i+1) + '" style="width:'+pct+'%">';
    html += compact ? s.dur+'m' : s.name + ' ('+s.dur+'m)';
    html += '</div>';
  });
  var remainPct = ((p.cap - p.totalDur) / p.cap * 100).toFixed(1);
  html += '<div class="stack-bar-empty" style="width:'+remainPct+'%">' + (p.cap - p.totalDur) + 'min buffer</div>';
  html += '</div>';
  html += '<div class="stack-bar-ruler"><span>0 min</span><span>30 min</span><span>60 min cap</span></div>';
  html += '</div>';

  // Study breakdown rows
  html += '<div class="stack-studies">';
  p.studies.forEach(function(s, i) {
    var statusLabel = s.status === 'confirmed'
      ? '<span style="color:#16A34A;font-weight:600">✓ Confirmed</span>'
      : '<span style="color:#D97706;font-weight:600">? Awaiting</span>';
    html += '<div class="stack-study-row">';
    html += '<div class="stack-study-dot" style="background:' + s.color + '"></div>';
    html += '<div class="stack-study-name">' + s.name + '</div>';
    html += '<div class="stack-study-researcher">' + s.researcher + '</div>';
    html += '<div class="stack-study-dur">' + s.dur + ' min</div>';
    if (!compact) html += '<div>' + statusLabel + '</div>';
    html += '</div>';
  });
  html += '</div>';

  return html;
}

function buildFullStackedCallout() {
  var p = STACKED_PILOT;
  var html = '<div class="stack-callout">';
  html += '<div class="stack-callout-header">';
  html += '<span class="stack-callout-icon">📦</span>';
  html += '<span class="stack-callout-title">' + p.title + '</span>';
  html += '<div class="stack-callout-tags">';
  html += '<span class="stack-callout-tag primary">Pilot</span>';
  html += '<span class="stack-callout-tag">LL102 · 16 stations</span>';
  html += '<span class="stack-callout-tag">' + p.totalDur + ' min · 0.50 CR</span>';
  html += '</div></div>';
  html += buildStackedBarHTML({compact: false});
  html += '<div class="stack-callout-note">Online option TBD · ' + p.studies.filter(function(s){return s.status==='maybe';}).length + ' researcher(s) awaiting confirmation</div>';
  html += '</div>';
  return html;
}

// Build co-PI lookup by study name
var studyCoPIMap = {};
allStudies.forEach(function(s) {
  if (s.coPIs && s.coPIs.length) {
    studyCoPIMap[s.study] = s.coPIs;
  }
});
function findCoPIs(lineText) {
  var keys = Object.keys(studyCoPIMap);
  for (var i = 0; i < keys.length; i++) {
    // Exact match first
    if (lineText.includes(keys[i])) return studyCoPIMap[keys[i]];
    // Fuzzy: strip non-alphanumeric, compare core name
    var coreName = keys[i].replace(/[—–\-:]/g, ' ').replace(/\s+/g, ' ').trim();
    var coreWords = coreName.split(' ').filter(function(w) { return w.length > 2; });
    var matchCount = coreWords.filter(function(w) { return lineText.includes(w); }).length;
    if (matchCount >= Math.max(2, coreWords.length * 0.6)) return studyCoPIMap[keys[i]];
  }
  return null;
}

document.getElementById('cal-body').innerHTML = calData.map(function(f) {
  var rowStyle = f.note && f.note.includes('Spring Recess') ? ' style="background:#FAFAFA"' : '';
  var facKey = calWeekToFacKey(f.wk);
  var weekUsage = facilityUsage[facKey] || {};

  var fmtFac = function(v, suiteKey) {
    var suiteEntries = weekUsage[suiteKey] || [];
    return (v||'—').split('\n').map(function(l) {
      if (l === '—') return '<div class="cal-empty">—</div>';
      var isOngoing = l.includes('ongoing') || l.includes('overflow');
      var isStacked = l.includes('Stacked') || l.includes('📦');

      // Expanded stacked session card
      if (isStacked) {
        var card = '<div class="cal-stacked-expanded">';
        card += '<div class="stack-callout-title">📦 Stacked Lab Session (Pilot)</div>';
        card += buildStackedBarHTML({compact: true});
        card += '</div>';
        return card;
      }

      var cls = 'cal-study cal-inperson';
      if (isOngoing) cls += ' cal-ongoing';
      var html = l.replace(/^([^:]+):/, '<strong>$1</strong>:');
      html = html.replace(/\(2-part\)/g, '<span class="badge-2part">2-Part</span>');
      html = html.replace(/\(2-wave\)/g, '<span class="badge-2part">2-Wave</span>');
      html = html.replace(/\(starts\)/g, '<span class="badge-start">Start</span>');
      html = html.replace(/\(final\)/g, '<span class="badge-end">End</span>');
      html = html.replace(/\(ongoing\)/g, '').replace(/\(overflow\)/g, '');
      var roomStr = '';
      if (suiteKey && suiteEntries.length) {
        suiteEntries.forEach(function(entry) {
          if (l.includes(entry.researcher) && entry.rooms && entry.rooms.length) {
            roomStr = '<div class="cal-rooms">' + entry.rooms.map(getRoomLabel).join(', ') + '</div>';
          }
        });
      }
      // Append co-PI names if not already in the line
      var coPIs = findCoPIs(l);
      var copiStr = '';
      if (coPIs) {
        var missing = coPIs.filter(function(c) { return !l.includes(c.split(',')[0]); });
        if (missing.length) copiStr = '<div class="cal-rooms">with ' + missing.join(', ') + '</div>';
      }
      return '<div class="' + cls + '">' + html.trim() + roomStr + copiStr + '</div>';
    }).join('');
  };
  var fmtOnline = function(v) {
    return (v||'—').split('\n').map(function(l) {
      if (l === '—') return '<div class="cal-empty">—</div>';
      var isStacked = l.includes('Stacked') || l.includes('📦');
      var cls = 'cal-study cal-online';
      if (isStacked) cls += ' cal-stacked';
      var html = l.replace(/^([^:]+):/, '<strong>$1</strong>:');
      html = html.replace(/\(2-part\)/g, '<span class="badge-2part">2-Part</span>');
      html = html.replace(/\(2-wave\)/g, '<span class="badge-2part">2-Wave</span>');
      // Append co-PI names if not already in the line
      var coPIs = findCoPIs(l);
      var copiStr = '';
      if (coPIs) {
        var missing = coPIs.filter(function(c) { return !l.includes(c.split(',')[0]); });
        if (missing.length) copiStr = '<div class="cal-rooms">with ' + missing.join(', ') + '</div>';
      }
      return '<div class="' + cls + '">' + html.trim() + copiStr + '</div>';
    }).join('');
  };
  var noteHtml = f.note ? '<div class="cal-week-note">' + f.note + '</div>' : '';
  return '<tr data-week-start="' + f.weekStart + '" data-week-end="' + f.weekEnd + '"' + rowStyle + '>' +
    '<td><div class="cal-week-label">Week of ' + f.wk + '</div><div class="cal-week-dates">' + f.dates + '</div>' + noteHtml + '</td>' +
    '<td>' + fmtOnline(f.online) + '</td><td>' + fmtFac(f.ll102, '102') + '</td>' +
    '<td>' + fmtFac(f.ll110, '110') + '</td><td>' + fmtFac(f.ll112, '112') + '</td></tr>';
}).join('');

// ═══════════════════════════════════════════════
// 5. EVENT LISTENERS
// ═══════════════════════════════════════════════
document.querySelectorAll('.nav-tab').forEach(function(tab) {
  tab.addEventListener('click', function() { switchTab(tab.dataset.tab); });
});

document.querySelectorAll('.nav-tab').forEach(function(tab, i, tabs) {
  tab.addEventListener('keydown', function(e) {
    var idx = Array.from(tabs).indexOf(tab);
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
      e.preventDefault(); var next = tabs[(idx + 1) % tabs.length]; next.focus(); switchTab(next.dataset.tab);
    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
      e.preventDefault(); var prev = tabs[(idx - 1 + tabs.length) % tabs.length]; prev.focus(); switchTab(prev.dataset.tab);
    }
  });
});

window.addEventListener('hashchange', function() {
  var tab = getTabFromHash();
  if (tab) { switchTab(tab, false); handleStudyDeepLink(); }
});

// mySelect listener moved to init section

researcherSelect.addEventListener('change', function() {
  researcherSelect.classList.toggle('has-selection', researcherSelect.value !== '');
  if (researcherSelect.value && mySelect.querySelector('option[value="' + researcherSelect.value + '"]')) {
    mySelect.value = researcherSelect.value; renderMySchedule();
  }
  runStudiesFilter();
  updateResetBtn();
});

// Format chip handlers
document.querySelectorAll('.format-chip').forEach(function(chip) {
  chip.addEventListener('click', function() {
    document.querySelectorAll('.format-chip').forEach(function(c) {
      c.classList.remove('active');
      c.setAttribute('aria-selected', 'false');
    });
    chip.classList.add('active');
    chip.setAttribute('aria-selected', 'true');
    activeFormat = chip.dataset.format;
    runStudiesFilter();
  });
});

// Search input handler
var studiesSearchInput = document.getElementById('studies-search');
studiesSearchInput.addEventListener('input', function() { runStudiesFilter(); });

// Clear filters button
document.getElementById('studies-clear-filters').addEventListener('click', function() {
  researcherSelect.value = '';
  researcherSelect.classList.remove('has-selection');
  studiesSearchInput.value = '';
  activeFormat = 'all';
  document.querySelectorAll('.format-chip').forEach(function(c) {
    c.classList.remove('active');
    c.setAttribute('aria-selected', 'false');
  });
  document.querySelector('.format-chip[data-format="all"]').classList.add('active');
  document.querySelector('.format-chip[data-format="all"]').setAttribute('aria-selected', 'true');
  runStudiesFilter();
});


// ═══════════════════════════════════════════════
// 6. INITIALIZATION + NEW FEATURES
// ═══════════════════════════════════════════════

// --- What's new indicator (now handled by changelog panel above) ---

// --- Dark mode ---
var darkToggle = document.getElementById('dark-mode-toggle');
function applyDarkMode(dark) {
  document.body.classList.toggle('dark', dark);
  darkToggle.textContent = dark ? '☀️' : '🌙';
  darkToggle.title = dark ? 'Switch to light mode' : 'Switch to dark mode';
  try { localStorage.setItem('mor-dark-mode', dark ? '1' : '0'); } catch(e) {}
}
// Check saved preference or system preference
var savedDark = null;
try { savedDark = localStorage.getItem('mor-dark-mode'); } catch(e) {}
if (savedDark === '1') applyDarkMode(true);
else if (savedDark === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) applyDarkMode(true);
darkToggle.addEventListener('click', function() { applyDarkMode(!document.body.classList.contains('dark')); updateFixedOffsets(); });

// --- Back to top ---
var backToTopBtn = document.getElementById('back-to-top');
window.addEventListener('scroll', function() {
  backToTopBtn.classList.toggle('visible', window.scrollY > 400);
});
backToTopBtn.addEventListener('click', function() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// --- Sortable columns for All Studies table ---
document.querySelectorAll('#studies-table th.sortable').forEach(function(th) {
  th.addEventListener('click', function() {
    var table = th.closest('table');
    var tbody = table.querySelector('tbody');
    var rows = Array.from(tbody.querySelectorAll('tr'));
    var colIdx = parseInt(th.dataset.col);
    var isNum = th.dataset.type === 'num';
    var isAsc = th.classList.contains('sort-asc');

    table.querySelectorAll('th.sortable').forEach(function(h) { h.classList.remove('sort-asc','sort-desc'); });
    th.classList.add(isAsc ? 'sort-desc' : 'sort-asc');

    rows.sort(function(a, b) {
      var aVal = a.querySelectorAll('td')[colIdx].textContent.trim();
      var bVal = b.querySelectorAll('td')[colIdx].textContent.trim();
      if (isNum) {
        aVal = parseFloat(aVal.replace(/[^0-9.]/g, '')) || 0;
        bVal = parseFloat(bVal.replace(/[^0-9.]/g, '')) || 0;
      }
      var cmp = isNum ? aVal - bVal : aVal.localeCompare(bVal);
      return isAsc ? -cmp : cmp;
    });
    rows.forEach(function(r) { tbody.appendChild(r); });
  });
});

// --- Calendar week navigation ---
var calWeekIdx = -1; // -1 = show all
var calRows;
function initCalNav() {
  calRows = Array.from(document.querySelectorAll('#cal-body tr'));
  updateCalNav();
}
function updateCalNav() {
  var label = document.getElementById('cal-nav-label');
  var prevBtn = document.getElementById('cal-prev');
  var nextBtn = document.getElementById('cal-next');
  if (calWeekIdx === -1) {
    calRows.forEach(function(r) { r.style.display = ''; });
    label.textContent = 'All Weeks (' + calRows.length + ')';
    prevBtn.disabled = true;
    nextBtn.disabled = calRows.length === 0;
  } else {
    calRows.forEach(function(r, i) { r.style.display = i === calWeekIdx ? '' : 'none'; });
    var vis = calRows[calWeekIdx];
    label.textContent = vis ? vis.querySelector('td').textContent.split('\n')[0].trim() : '';
    prevBtn.disabled = calWeekIdx <= 0;
    nextBtn.disabled = calWeekIdx >= calRows.length - 1;
  }
}
document.getElementById('cal-prev').addEventListener('click', function() {
  if (calWeekIdx === -1) calWeekIdx = 0;
  else if (calWeekIdx > 0) calWeekIdx--;
  updateCalNav();
});
document.getElementById('cal-next').addEventListener('click', function() {
  if (calWeekIdx === -1) calWeekIdx = 0;
  else if (calWeekIdx < calRows.length - 1) calWeekIdx++;
  updateCalNav();
});
document.getElementById('cal-show-all').addEventListener('click', function() {
  calWeekIdx = -1;
  updateCalNav();
});
document.getElementById('cal-today').addEventListener('click', function() {
  // Find the current week index
  for (var i = 0; i < calRows.length; i++) {
    if (calRows[i].dataset.weekStart && TODAY >= calRows[i].dataset.weekStart && TODAY <= calRows[i].dataset.weekEnd) {
      calWeekIdx = i;
      updateCalNav();
      return;
    }
  }
  // Fallback: show all and scroll
  calWeekIdx = -1;
  updateCalNav();
  var currentRow = document.querySelector('#cal-body tr.current-week-row');
  if (currentRow) currentRow.scrollIntoView({behavior: 'smooth', block: 'center'});
});

// --- Auto-select current week in Facilities ---
function autoSelectFacWeek() {
  var options = facWeekSelect.querySelectorAll('option');
  for (var i = 0; i < calData.length; i++) {
    if (TODAY >= calData[i].weekStart && TODAY <= calData[i].weekEnd) {
      // Find matching option value
      var weekKeys = ['feb8','feb15','feb22','mar1','mar8','mar15','mar22','mar29','apr5','apr12','apr19','apr26'];
      if (weekKeys[i] && !facWeekSelect.querySelector('option[value="' + weekKeys[i] + '"][disabled]')) {
        facWeekSelect.value = weekKeys[i];
        renderFacilities();
      }
      break;
    }
  }
}

// --- Room click-to-detail modal ---
var roomModal = document.getElementById('room-modal-overlay');
var roomModalClose = document.getElementById('room-modal-close');

function openRoomModal(roomEl) {
  var roomId = roomEl.querySelector('.fac-room-id').textContent;
  var label = roomEl.querySelector('.fac-room-label');
  var equip = roomEl.querySelector('.fac-room-equip');
  var study = roomEl.querySelector('.fac-room-study');
  var tip = roomEl.querySelector('.fac-room-tooltip');

  var headerBg = '#333';
  // Try to get researcher color
  if (study && study.textContent.trim()) {
    var studyText = study.textContent;
    Object.keys(RC).forEach(function(name) {
      if (studyText.includes(name)) headerBg = RC[name].bd;
    });
  }

  document.getElementById('room-modal-header').style.background = headerBg;
  document.getElementById('room-modal-title').textContent = roomId + (label ? ' — ' + label.textContent : '');

  var body = '';
  if (equip) body += '<div class="room-modal-row"><strong>Equipment</strong>' + equip.textContent + '</div>';
  if (study && study.innerHTML.trim()) body += '<div class="room-modal-row"><strong>Current Study</strong>' + study.innerHTML + '</div>';
  if (!body) body = '<div class="room-modal-row" style="color:var(--text-muted)">No study assigned this week</div>';

  document.getElementById('room-modal-body').innerHTML = body;
  roomModal.classList.add('active');
}

roomModalClose.addEventListener('click', function() { roomModal.classList.remove('active'); });
roomModal.addEventListener('click', function(e) { if (e.target === roomModal) roomModal.classList.remove('active'); });
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') roomModal.classList.remove('active'); });

// Attach click handlers to active rooms
function attachRoomClicks() {
  document.querySelectorAll('.fac-room.fac-active').forEach(function(room) {
    room.style.cursor = 'pointer';
    room.onclick = function(e) { e.stopPropagation(); openRoomModal(room); };
  });
}

// Wrap renderFacilities to also attach room clicks
var origRenderFac = renderFacilities;
renderFacilities = function() {
  origRenderFac();
  attachRoomClicks();
};
facWeekSelect.addEventListener('change', renderFacilities);

// --- Enhance renderMySchedule: welcome dismiss + progress bar + minimap toggle + download btn ---
var baseRenderMySchedule = renderMySchedule;
renderMySchedule = function() {
  baseRenderMySchedule();

  // Hide intro once researcher is selected
  if (mySelect.value) {
    var intro = document.querySelector('.home-intro');
    if (intro) intro.style.display = 'none';
  }

  // Progress bar
  if (!mySelect.value) return;
  var content = document.getElementById('my-schedule-content');
  var card = content ? content.querySelector('.researcher-card') : null;
  if (!card) return;
  var header = card.querySelector('.researcher-card-header');
  if (!header || card.querySelector('.rc-progress')) return;

  var semStart = new Date('2026-02-08');
  var semEnd = new Date('2026-05-01');
  var now = new Date(TODAY);
  var pct = Math.max(0, Math.min(100, ((now - semStart) / (semEnd - semStart)) * 100));

  var progHTML = '<div class="rc-progress"><div class="rc-progress-fill" style="width:' + pct + '%"></div><div class="rc-progress-marker" style="left:' + pct + '%"></div></div>';
  progHTML += '<div class="rc-progress-labels"><span>Feb 8</span><span style="font-weight:600;color:var(--cardinal)">TODAY — ' + TODAY_DISPLAY + '</span><span>May 1</span></div>';
  header.insertAdjacentHTML('afterend', progHTML);

  // Minimap toggle button
  if (!card.querySelector('.rc-map-toggle')) {
    var hasMaps = card.querySelectorAll('.rc-minimap, .rc-minimap-multi');
    if (hasMaps.length > 0) {
      var toggleBtn = document.createElement('button');
      toggleBtn.className = 'rc-map-toggle';
      toggleBtn.textContent = '🗺️ Hide Maps';
      toggleBtn.setAttribute('aria-label', 'Toggle floor plan maps');
      var mapsVisible = true;
      toggleBtn.addEventListener('click', function() {
        mapsVisible = !mapsVisible;
        toggleBtn.textContent = mapsVisible ? '🗺️ Hide Maps' : '🗺️ Show Maps';
        card.querySelectorAll('.rc-minimap, .rc-minimap-multi').forEach(function(m) {
          m.classList.toggle('maps-hidden', !mapsVisible);
        });
      });
      var topBar = card.querySelector('.rc-header-top');
      if (topBar) topBar.appendChild(toggleBtn);
      else header.appendChild(toggleBtn);
    }
  }
};
mySelect.addEventListener('change', function() {
  myStudySelect.value = '';
  myStudySelect.classList.remove('picker-active');
  mySelect.classList.toggle('picker-active', mySelect.value !== '');
  renderMySchedule();
  updateResetBtn();
});

// #2: Study deep-link handler
myContent.addEventListener('click', function(e) {
  var link = e.target.closest('.rc-study-link');
  if (!link) return;
  e.preventDefault();
  var studyName = link.dataset.study;
  // Set researcher filter to current My Schedule researcher
  researcherSelect.value = mySelect.value;
  researcherSelect.classList.toggle('has-selection', !!researcherSelect.value);
  switchTab('studies');
  // Scroll to matching study
  setTimeout(function() {
    var rows = document.querySelectorAll('#studies-tbody tr:not(.filter-hidden)');
    for (var i = 0; i < rows.length; i++) {
      if (rows[i].textContent.includes(studyName)) {
        rows[i].scrollIntoView({behavior:'smooth', block:'center'});
        rows[i].style.outline = '2px solid var(--cardinal)';
        rows[i].style.borderRadius = '4px';
        setTimeout(function(r) { r.style.outline = ''; r.style.borderRadius = ''; }, 2000, rows[i]);
        break;
      }
    }
  }, 100);
});

myStudySelect.addEventListener('change', function() {
  var studyName = myStudySelect.value;
  if (studyName && studyToResearcher[studyName]) {
    mySelect.value = studyToResearcher[studyName];
    mySelect.classList.add('picker-active');
    myStudySelect.classList.add('picker-active');
    renderMySchedule();
  } else {
    myStudySelect.classList.remove('picker-active');
  }
  updateResetBtn();
});

// --- Header Reset Button ---
var headerResetBtn = document.getElementById('header-reset');
function updateResetBtn() {
  var hasSelection = mySelect.value || researcherSelect.value;
  headerResetBtn.classList.toggle('visible', !!hasSelection);
}
headerResetBtn.addEventListener('click', function() {
  // Clear My Schedule picker
  mySelect.value = '';
  mySelect.classList.remove('picker-active');
  myStudySelect.value = '';
  myStudySelect.classList.remove('picker-active');
  renderMySchedule();
  // Show intro again
  var intro = document.querySelector('.home-intro');
  if (intro) intro.style.display = '';
  // Clear All Studies researcher filter
  researcherSelect.value = '';
  researcherSelect.classList.remove('has-selection');
  runStudiesFilter();
  // Update URL
  updateUrlParam('researcher', null);
  // Hide button
  updateResetBtn();
  // Scroll to top
  window.scrollTo({top: 0, behavior: 'smooth'});
});


// --- Stacking Planner ---
(function() {
  var toggle = document.getElementById('stack-planner-toggle');
  var planner = document.getElementById('stack-planner');
  var content = document.getElementById('stack-planner-content');

  toggle.addEventListener('click', function() {
    planner.classList.toggle('open');
    if (planner.classList.contains('open') && !content.innerHTML) renderStackPlanner();
  });

  function renderStackPlanner() {
    // Show confirmed pilot session first
    var html = buildFullStackedCallout();
    html += '<div style="margin-top:16px;padding:12px 0 4px;font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;border-top:2px solid var(--border)">Other Stackable Weeks</div>';

    // Gather stackable studies
    var stackable = allStudies.filter(function(s) { return s.stackable === true || s.stackable === 'maybe'; });

    // Group by week
    var weekMap = {};
    stackable.forEach(function(s) {
      var wk = s.dateSort;
      if (!weekMap[wk]) weekMap[wk] = {date: wk, label: s.dateLabel, studies: []};
      // Parse duration to number
      var durMin = parseInt(s.dur) || 0;
      weekMap[wk].studies.push({
        name: s.study,
        researcher: s.researcher,
        dur: durMin,
        durLabel: s.dur,
        cr: parseFloat(s.cr),
        confirmed: s.stackable === true,
        notes: s.notes
      });
    });

    // Sort weeks chronologically
    var weeks = Object.keys(weekMap).sort().map(function(k) { return weekMap[k]; });

    // Calculate totals and find best week
    var bestIdx = -1;
    var bestCount = 0;
    weeks.forEach(function(wk, i) {
      wk.totalDur = wk.studies.reduce(function(sum, s) { return sum + s.dur; }, 0);
      wk.totalCr = wk.studies.reduce(function(sum, s) { return sum + s.cr; }, 0);
      wk.confirmedCount = wk.studies.filter(function(s) { return s.confirmed; }).length;
      if (wk.studies.length > bestCount) { bestCount = wk.studies.length; bestIdx = i; }
    });
    // If tie on count, prefer more confirmed
    weeks.forEach(function(wk, i) {
      if (wk.studies.length === bestCount && i !== bestIdx) {
        if (wk.confirmedCount > weeks[bestIdx].confirmedCount) bestIdx = i;
      }
    });

    // Check LL102 availability by week
    var ll102Usage = {};
    var facWeekMap = {
      '2026-02-22':'feb22','2026-03-01':'mar1','2026-03-08':'mar8',
      '2026-03-22':'mar22','2026-03-29':'mar29','2026-04-05':'apr5'
    };
    Object.keys(facWeekMap).forEach(function(dateKey) {
      var fk = facWeekMap[dateKey];
      var usage = facilityUsage[fk];
      if (usage && usage['102'] && usage['102'].length > 0) {
        ll102Usage[dateKey] = usage['102'].map(function(e) { return e.researcher + ': ' + e.study; });
      }
    });

    // Render
    html += '<div class="sp-weeks">';

    weeks.forEach(function(wk, i) {
      var isBest = i === bestIdx && wk.studies.length >= 2;
      var isSlim = wk.studies.length < 2;
      var cls = 'sp-week';
      if (isBest) cls += ' sp-best';
      if (isSlim) cls += ' sp-week-slim';

      html += '<div class="' + cls + '">';

      // Header
      html += '<div class="sp-week-header">';
      html += '<span class="sp-week-date">' + wk.label + '</span>';
      html += '<div class="sp-week-stats">';
      html += '<span class="sp-week-stat"><strong>' + wk.studies.length + '</strong> studies</span>';
      html += '<span class="sp-week-stat"><strong>' + wk.totalDur + '</strong> min total</span>';
      html += '<span class="sp-week-stat"><strong>' + wk.totalCr.toFixed(2) + '</strong> CR</span>';
      if (isBest) html += '<span class="sp-best-tag">Best Combo</span>';
      if (isSlim) html += '<span style="font-size:11px;color:var(--text-muted);font-style:italic">Not enough to stack alone</span>';
      html += '</div></div>';

      // Studies
      html += '<div class="sp-week-studies">';
      wk.studies.forEach(function(s) {
        html += '<div class="sp-study">';
        html += '<span class="sp-study-status ' + (s.confirmed ? 'confirmed' : 'maybe') + '">' + (s.confirmed ? '✓ Yes' : '? Maybe') + '</span>';
        html += '<span class="sp-study-name">' + s.name + '</span>';
        html += '<span class="sp-study-researcher">' + s.researcher + '</span>';
        html += '<span class="sp-study-dur">' + s.durLabel + ' · ' + s.cr.toFixed(2) + ' CR</span>';
        html += '</div>';
      });
      html += '</div>';

      // LL102 status
      var ll102Busy = ll102Usage[wk.date];
      html += '<div class="sp-ll102">';
      if (ll102Busy) {
        html += '<span class="sp-ll102-dot sp-ll102-busy"></span> LL102 in use: ' + ll102Busy.join(', ');
        html += ' <span style="font-style:italic;margin-left:4px">— would need to coordinate timeslots</span>';
      } else {
        html += '<span class="sp-ll102-dot sp-ll102-free"></span> LL102 available this week';
      }
      html += '</div>';

      html += '</div>';
    });

    // Summary
    html += '</div>';
    html += '<div style="padding:12px 16px;font-size:12px;color:var(--text-muted);border-top:1px solid var(--border-light)">';
    html += '<strong>Recommendation:</strong> ';
    if (bestIdx >= 0 && weeks[bestIdx].studies.length >= 2) {
      var best = weeks[bestIdx];
      html += best.label + ' is the strongest candidate — ' + best.studies.length + ' studies, ' + best.totalDur + ' min combined, ' + best.totalCr.toFixed(2) + ' credits.';
      var maybes = best.studies.filter(function(s) { return !s.confirmed; });
      if (maybes.length) {
        html += ' Confirm with: ' + maybes.map(function(s) { return s.researcher; }).join(', ') + '.';
      }
    } else {
      html += 'No weeks currently have enough stackable studies for a combined session.';
    }
    html += '</div>';

    content.innerHTML = html;
  }
})();


// --- Clickable intro tab cards ---
document.querySelectorAll('.home-intro-tab[data-goto]').forEach(function(card) {
  card.addEventListener('click', function() {
    switchTab(card.dataset.goto);
    window.scrollTo({top: 0, behavior: 'smooth'});
  });
});

// --- Badge legend tap support for mobile ---
document.querySelectorAll('.badge-legend-trigger').forEach(function(trigger) {
  trigger.addEventListener('click', function(e) {
    e.stopPropagation();
    var popup = trigger.querySelector('.badge-legend-popup');
    if (!popup) return;
    var isOpen = popup.style.display === 'block';
    // Close all others first
    document.querySelectorAll('.badge-legend-popup').forEach(function(p) { p.style.display = ''; });
    if (!isOpen) popup.style.display = 'block';
  });
});
document.addEventListener('click', function() {
  document.querySelectorAll('.badge-legend-popup').forEach(function(p) { p.style.display = ''; });
});

// --- Final initialization ---
buildStudiesTable();
initCalNav();
autoSelectFacWeek();

// --- Feature: Calendar researcher filter ---
function populateCalResearcherFilter() {
  var calFilter = document.getElementById('cal-researcher-filter');
  if (!calFilter) return;
  // Copy options from mySelect
  var options = mySelect.querySelectorAll('option');
  for (var i = 1; i < options.length; i++) {
    var opt = document.createElement('option');
    opt.value = options[i].value;
    opt.textContent = options[i].textContent;
    calFilter.appendChild(opt);
  }
}
populateCalResearcherFilter();

function applyCalResearcherFilter() {
  var calFilter = document.getElementById('cal-researcher-filter');
  var selected = calFilter ? calFilter.value : '';
  document.querySelectorAll('#cal-body tr').forEach(function(row) {
    if (selected) {
      var text = row.textContent.toLowerCase();
      var match = text.includes(selected.split(',')[0].toLowerCase());
      row.style.opacity = match ? '1' : '0.35';
      row.style.transition = 'opacity 0.2s';
    } else {
      row.style.opacity = '1';
    }
  });
  if (calFilter) calFilter.classList.toggle('has-selection', !!selected);
}

document.getElementById('cal-researcher-filter').addEventListener('change', function() {
  applyCalResearcherFilter();
});

// --- Feature: Prev/Next researcher navigation ---
var prevBtn = document.getElementById('researcher-prev');
var nextBtn = document.getElementById('researcher-next');

function updateResearcherNav() {
  var options = mySelect.querySelectorAll('option[value]');
  var vals = [];
  for (var i = 0; i < options.length; i++) {
    if (options[i].value) vals.push(options[i].value);
  }
  var currentIdx = vals.indexOf(mySelect.value);
  prevBtn.disabled = currentIdx <= 0;
  nextBtn.disabled = currentIdx < 0 || currentIdx >= vals.length - 1;
  // Show nav buttons only when a researcher is selected
  prevBtn.style.visibility = mySelect.value ? 'visible' : 'hidden';
  nextBtn.style.visibility = mySelect.value ? 'visible' : 'hidden';
}

prevBtn.addEventListener('click', function() {
  var options = mySelect.querySelectorAll('option[value]');
  var vals = [];
  for (var i = 0; i < options.length; i++) {
    if (options[i].value) vals.push(options[i].value);
  }
  var currentIdx = vals.indexOf(mySelect.value);
  if (currentIdx > 0) {
    mySelect.value = vals[currentIdx - 1];
    mySelect.dispatchEvent(new Event('change'));
  }
});

nextBtn.addEventListener('click', function() {
  var options = mySelect.querySelectorAll('option[value]');
  var vals = [];
  for (var i = 0; i < options.length; i++) {
    if (options[i].value) vals.push(options[i].value);
  }
  var currentIdx = vals.indexOf(mySelect.value);
  if (currentIdx < vals.length - 1) {
    mySelect.value = vals[currentIdx + 1];
    mySelect.dispatchEvent(new Event('change'));
  }
});

// Hook into existing mySelect change handler to update nav state
var originalMySelectChange = mySelect.onchange;
mySelect.addEventListener('change', function() {
  updateResearcherNav();
});
updateResearcherNav();

// --- Feature: Changelog panel ---
(function() {
  var trigger = document.getElementById('changelog-trigger');
  var panel = document.getElementById('changelog-panel');
  var dismiss = document.getElementById('changelog-dismiss');
  var dataDate = document.getElementById('updated-date').dataset.date;

  try {
    var lastSeen = localStorage.getItem('mor-last-seen-update');
    if (!lastSeen || lastSeen < dataDate) {
      trigger.classList.add('visible');
    }
  } catch(e) { /* no localStorage */ }

  trigger.addEventListener('click', function(e) {
    e.stopPropagation();
    var isOpen = panel.classList.contains('open');
    panel.classList.toggle('open');
    if (!isOpen) {
      // Mark as seen
      try { localStorage.setItem('mor-last-seen-update', dataDate); } catch(e) {}
    }
  });

  dismiss.addEventListener('click', function(e) {
    e.stopPropagation();
    panel.classList.remove('open');
    trigger.classList.remove('visible');
    try { localStorage.setItem('mor-last-seen-update', dataDate); } catch(e) {}
  });

  // Close panel on outside click
  document.addEventListener('click', function(e) {
    if (!trigger.contains(e.target) && !panel.contains(e.target)) {
      panel.classList.remove('open');
    }
  });

  // Auto-dismiss after 30 seconds
  setTimeout(function() {
    if (trigger.classList.contains('visible') && !panel.classList.contains('open')) {
      trigger.classList.remove('visible');
      try { localStorage.setItem('mor-last-seen-update', dataDate); } catch(e) {}
    }
  }, 30000);
})();

// Semester progress bar
(function() {
  var semStart = new Date('2026-02-08');
  var semEnd = new Date('2026-05-01');
  var now = new Date(TODAY);
  var pct = Math.max(0, Math.min(100, (now - semStart) / (semEnd - semStart) * 100));
  document.getElementById('semester-progress-bar').style.setProperty('--progress', pct.toFixed(1) + '%');
  document.getElementById('semester-progress-pct').textContent = Math.round(pct) + '% complete';

  // Relative "updated" time
  var updEl = document.getElementById('updated-date');
  var updDate = new Date(updEl.dataset.date);
  var diffDays = Math.floor((now - updDate) / 86400000);
  var relText = '';
  if (diffDays === 0) relText = 'today';
  else if (diffDays === 1) relText = 'yesterday';
  else if (diffDays < 7) relText = diffDays + ' days ago';
  else if (diffDays < 14) relText = '1 week ago';
  else relText = Math.floor(diffDays / 7) + ' weeks ago';
  updEl.textContent = 'Updated Feb 16, 2026 · ' + relText;
})();

// #4: URL parameter for researcher pre-selection
function getUrlParam(param) {
  var params = new URLSearchParams(window.location.search);
  return params.get(param);
}
function updateUrlParam(param, value) {
  try {
    var url = new URL(window.location);
    if (value) url.searchParams.set(param, value);
    else url.searchParams.delete(param);
    history.replaceState(null, '', url);
  } catch(e) { /* sandboxed iframe */ }
}
var urlResearcher = getUrlParam('researcher');
if (urlResearcher) {
  // Try to match the researcher name
  var matchOption = mySelect.querySelector('option[value="' + urlResearcher + '"]');
  if (matchOption) {
    mySelect.value = urlResearcher;
    renderMySchedule();
    switchTab('myschedule', false);
  } else {
    // Try partial match (last name only)
    var options = mySelect.querySelectorAll('option');
    for (var oi = 0; oi < options.length; oi++) {
      if (options[oi].value && options[oi].value.toLowerCase().includes(urlResearcher.toLowerCase())) {
        mySelect.value = options[oi].value;
        renderMySchedule();
        switchTab('myschedule', false);
        break;
      }
    }
  }
}
// Update URL when researcher is selected
mySelect.addEventListener('change', function() {
  updateUrlParam('researcher', mySelect.value || null);
});

// Handle initial tab from URL hash
var initialTab = getTabFromHash();
if (initialTab) { switchTab(initialTab, false); handleStudyDeepLink(); }

// Show reset button if researcher pre-selected via URL
updateResetBtn();

</script>
</body>
</html>